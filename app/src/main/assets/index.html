<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Football Match Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Mobile-first responsive design */
        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            scroll-behavior: smooth;
        }
        
        /* Better touch targets for mobile */
        button, input, select, textarea {
            min-height: 44px;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden;
            color: #ffffff;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            background: transparent;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            color: #e2e8f0;
            padding: env(safe-area-inset-top, 20px) 20px 2px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: clamp(1.4rem, 4vw, 1.8rem);
            margin: 0 0 10px 0;
            padding: 0;
            font-weight: 600;
            letter-spacing: -0.02em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 50%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }


        /* Floating Stop Sound Button */
        .floating-mute-btn {
            position: fixed !important;
            bottom: 20px !important;
            left: 20px !important;
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(185, 28, 28, 0.9) 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999 !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
            font-size: 18px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .floating-mute-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }

        .floating-mute-btn:active {
            transform: translateY(0) scale(0.95);
        }


        .score-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: clamp(1.1rem, 3vw, 1.4rem);
            font-weight: 600;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .team-score-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            backdrop-filter: blur(20px);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
            width: 50%;
            min-height: 72px;
            height: 72px;
            position: relative;
            overflow: hidden;
        }

        .team-score-header.yellow-team {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.9) 0%, rgba(255, 152, 0, 0.8) 50%, rgba(251, 191, 36, 0.9) 100%);
            justify-content: space-between;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
        }

        .team-score-header.blue-team {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.9) 0%, rgba(63, 81, 181, 0.8) 50%, rgba(59, 130, 246, 0.9) 100%);
            justify-content: space-between;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
        }

        .score-display {
            font-size: 1.4em;
            font-weight: 800;
            min-width: 32px;
            text-align: center;
            padding: 6px 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.7);
            letter-spacing: 0.02em;
        }

        .score-animation {
            animation: scoreFlash 0.5s ease-out;
        }

        @keyframes scoreFlash {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); background: rgba(255, 255, 255, 0.3); }
            100% { transform: scale(1); }
        }

        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 2px;
            padding: 12px;
            background: transparent;
            border-radius: 16px;
            max-width: 480px;
            margin-left: auto;
            margin-right: auto;
            overflow: visible;
        }

        .mode-btn {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid transparent;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            position: relative;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mode-btn.active {
            background: rgba(30, 58, 138, 0.9);
            color: #e2e8f0;
            box-shadow: 0 2px 8px rgba(30, 58, 138, 0.3);
            transform: translateY(-1px);
            border: 2px solid #1e3a8a;
        }


        /* Help Modal Styles */
        .help-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .help-modal-content {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            margin: 0;
            padding: 0;
            border: none;
            border-radius: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            box-shadow: none;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .help-modal-header {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(30, 58, 138, 0.4));
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .help-modal-header h2 {
            margin: 0;
            color: #ffffff;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .help-modal-close {
            background: transparent;
            border: none;
            color: #ffffff;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .help-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .help-modal-body {
            padding: 24px;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .help-content {
            color: #e2e8f0;
            line-height: 1.6;
        }

        .help-content p {
            margin-bottom: 16px;
        }

        .help-content h3 {
            color: #ffffff;
            margin-top: 24px;
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        .setup-mode {
            padding: 20px 16px;
            flex: 1;
        }

        .setup-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .setup-header h2 {
            color: #ffffff;
            margin-bottom: 8px;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .setup-header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin: 0;
        }

        .teams-setup {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .team-setup {
            padding: 25px;
            border-radius: 15px;
            border: 3px solid;
        }

        .team-setup.yellow {
            border-color: #fbbf24;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.1) 100%);
            box-shadow: 0 8px 32px rgba(251, 191, 36, 0.2);
        }

        .team-setup.blue {
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.1) 100%);
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.2);
        }

        .team-setup h3 {
            text-align: center;
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #ffffff;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .team-name-input {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .team-name-input input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            min-height: 52px;
        }

        .team-name-input.yellow input {
            border-color: #fbbf24;
            color: #f59e0b;
        }

        .team-name-input.blue input {
            border-color: #3b82f6;
            color: #2563eb;
        }

        .team-name-input input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3), 0 4px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
            scale: 1.02;
        }

        .team-name-input input::placeholder {
            color: #999;
            font-weight: normal;
        }

        .player-input {
            margin-bottom: 16px;
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .player-dropdown {
            margin-bottom: 16px;
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .player-input input,
        .player-dropdown select {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            color: #1f2937;
            min-height: 48px;
        }

        .player-input input:focus,
        .player-dropdown select:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.8);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2), 0 2px 10px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        /* Placeholder styling for dropdowns */
        .player-dropdown select option:first-child {
            color: #999;
            font-style: italic;
        }

        .player-dropdown select:invalid {
            color: #999;
        }

        .player-dropdown select:valid {
            color: #1f2937;
        }

        .assign-sound-btn {
            padding: 10px 16px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            min-height: 40px;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .assign-sound-btn:active {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 1px 4px rgba(99, 102, 241, 0.4);
        }


        .sound-button-group {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .sound-test-btn {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.8) 0%, rgba(21, 128, 61, 0.9) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
            min-width: 44px;
        }

        .sound-test-btn:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
        }

        .remove-sound-btn {
            padding: 10px 12px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            min-width: 44px;
        }

        .remove-sound-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        .remove-sound-btn:active {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 1px 4px rgba(239, 68, 68, 0.4);
        }

        .custom-sound-card .remove-sound-btn {
            padding: 8px 10px;
            font-size: 12px;
            min-width: 36px;
        }

        /* Mobile-specific styles for better layout */
        @media (max-width: 480px) {
            .setup-mode {
                padding: 15px 12px;
            }
            .teams-setup {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .team-name-input {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .team-name-input input {
                padding: 14px 16px;
                font-size: 16px;
            }
            
            .sound-button-group {
                justify-content: center;
                gap: 12px;
            }
            
            .assign-sound-btn,
            .remove-sound-btn {
                padding: 12px 16px;
                font-size: 14px;
                min-width: 60px;
            }
            
            .own-goal-container {
                display: flex;
                align-items: center;
                justify-content: flex-start;
                gap: 15px;
                margin-top: 15px;
                padding: 16px;
                background: linear-gradient(135deg, rgba(231, 76, 60, 0.15) 0%, rgba(192, 57, 43, 0.1) 100%);
                border: 2px solid #e74c3c;
                border-radius: 12px;
                backdrop-filter: blur(10px);
            }
            
            .rule-item .sound-button-group {
                justify-content: flex-start;
                flex-wrap: wrap;
            }
            
            .rule-item .assign-sound-btn {
                flex: 1;
                min-width: 120px;
            }
            
            .rule-item .remove-sound-btn {
                flex: 0 0 auto;
                min-width: 50px;
            }
            
            .player-input .sound-button-group {
                justify-content: center;
            }
            
            .add-player-btn {
                font-size: 14px;
                padding: 12px 16px;
                margin-top: 16px;
            }
            
            /* Improved mobile styles for player dropdowns */
            .player-dropdown {
                margin-bottom: 18px;
                gap: 8px;
                flex-wrap: wrap;
            }
            
            .player-dropdown select {
                font-size: 16px;
                padding: 16px 14px;
                min-height: 52px;
                border-radius: 8px;
            }
            
            .player-dropdown .sound-button-group {
                min-width: 100%;
                margin-top: 8px;
                justify-content: center;
                gap: 10px;
            }
            
            .remove-player-btn {
                display: block !important;
                position: static;
                transform: none;
                padding: 8px 12px;
                font-size: 14px;
                border-radius: 6px;
                min-width: 44px;
                margin-left: 8px;
            }
            
            /* Better spacing for team sections */
            .team-setup {
                padding: 20px 16px;
                margin-bottom: 24px;
                border-radius: 12px;
            }
            
            .team-setup h3 {
                font-size: 18px;
                margin-bottom: 16px;
                text-align: center;
            }
            
            /* Improved touch targets for mobile */
            .assign-sound-btn,
            .remove-sound-btn {
                min-height: 44px;
                min-width: 44px;
                padding: 10px 16px;
                border-radius: 8px;
            }
        }


        .add-player-btn {
            width: 100%;
            padding: 14px 16px;
            background: linear-gradient(135deg, #a855f7, #9333ea);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 16px;
            font-size: 15px;
            min-height: 48px;
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
        }

        .add-player-btn:active {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 2px 6px rgba(168, 85, 247, 0.4);
        }

        .remove-player-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .player-input:hover .remove-player-btn {
            display: block;
        }

        .own-goal-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            margin-top: 15px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.15) 0%, rgba(192, 57, 43, 0.1) 100%);
            border: 2px solid #e74c3c;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .own-goal-label {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
            border: none;
            text-align: center;
            flex: 1;
            width: 100%;
        }

        .start-game-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-game-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }

        .sample-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .sample-btn:hover {
            background: linear-gradient(135deg, #5b56e8, #7c3aed);
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
            flex: 1;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .game-mode {
            padding: 20px 16px;
            flex: 1;
        }

        .score-board {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
            padding: 24px 20px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6, #a855f7);
            border-radius: 20px;
            color: white;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
            backdrop-filter: blur(10px);
        }
        
        @media (min-width: 640px) {
            .score-board {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }

        .team-score {
            text-align: center;
            padding: 20px 16px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex: 1;
        }

        .team-score h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .score {
            font-size: clamp(2.5rem, 8vw, 3.5rem);
            font-weight: 800;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            letter-spacing: -0.02em;
        }

        .vs {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.5rem, 4vw, 2rem);
            font-weight: 700;
            order: -1;
            margin-bottom: 16px;
        }
        
        @media (min-width: 640px) {
            .vs {
                order: 0;
                margin-bottom: 0;
                flex-shrink: 0;
                width: 60px;
            }
        }

        .teams-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 24px;
        }
        
        @media (min-width: 768px) {
            .teams-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 24px;
            }
        }

        .team-players {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 8px 32px rgba(15, 15, 35, 0.4);
            padding: 20px;
            border-radius: 15px;
            border: 3px solid;
        }

        .team-players.yellow {
            border-color: #fbbf24;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.1) 100%);
            box-shadow: 0 8px 32px rgba(251, 191, 36, 0.2);
        }

        .team-players.blue {
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.1) 100%);
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.2);
        }

        .team-players h4 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.3rem;
            color: #e2e8f0;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .player-btn {
            padding: 12px 8px;
            border: 2px solid;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 14px;
            background: white;
        }

        .player-btn.yellow {
            border-color: #f39c12;
            color: #f39c12;
            background: linear-gradient(135deg, #0f172a, #1e3a8a) !important;
        }

        .player-btn.blue {
            border-color: #3498db;
            color: #3498db;
            background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;
        }

        .player-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .player-btn.yellow:hover {
            background: #f39c12;
            color: white;
        }

        .player-btn.blue:hover {
            background: #3498db;
            color: white;
        }

        .own-goal-btn {
            background: #e74c3c !important;
            color: white !important;
            border-color: #e74c3c !important;
        }

        .game-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .game-action-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .game-action-controls .control-btn {
            flex: 1;
            min-height: 44px;
            max-width: 150px;
        }

        .custom-sounds-section {
            margin-bottom: 25px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(139, 69, 219, 0.2) 0%, rgba(124, 58, 237, 0.1) 100%);
            border-radius: 15px;
            border: 3px solid #8b45db;
            box-shadow: 0 8px 32px rgba(139, 69, 219, 0.2);
        }

        .custom-sounds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .custom-sound-btn {
            padding: 10px 16px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            white-space: nowrap;
            min-width: 100px;
        }

        .custom-sound-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
            background: linear-gradient(135deg, #7c3aed, #5b5bd6);
        }

        .custom-sound-btn:active {
            transform: translateY(0);
        }

        .custom-sound-btn:disabled {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .control-btn {
            padding: 8px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 13px;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            min-height: 36px;
        }

        .control-btn.start {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.8) 0%, rgba(21, 128, 61, 0.9) 100%);
            color: white;
            border-color: rgba(34, 197, 94, 0.6);
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
        }

        .control-btn.stop {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.8) 0%, rgba(185, 28, 28, 0.9) 100%);
            color: white;
            border-color: rgba(239, 68, 68, 0.6);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
        }

        .control-btn.undo {
            background: linear-gradient(135deg, rgba(139, 69, 219, 0.8) 0%, rgba(124, 58, 237, 0.9) 100%);
            color: white;
            border-color: rgba(139, 69, 219, 0.6);
            box-shadow: 0 4px 16px rgba(139, 69, 219, 0.3);
        }

        .control-btn.reset {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.8) 0%, rgba(217, 119, 6, 0.9) 100%);
            color: white;
            border-color: rgba(245, 158, 11, 0.6);
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
        }

        .control-btn:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .control-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .control-btn.export {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.8) 0%, rgba(37, 99, 235, 0.9) 100%);
            color: white;
            border-color: rgba(59, 130, 246, 0.6);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }

        .control-btn.help {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.8) 0%, rgba(79, 70, 229, 0.9) 100%);
            color: white;
            border-color: rgba(99, 102, 241, 0.6);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }

        .custom-sound-buttons {
            margin-bottom: 24px;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(15, 15, 35, 0.2);
        }

        .custom-sound-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .custom-sound-header h4 {
            color: #ffffff;
            margin-bottom: 6px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .custom-sound-header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            margin: 0;
        }

        .custom-sound-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        
        @media (min-width: 640px) {
            .custom-sound-row {
                grid-template-columns: repeat(4, 1fr);
                gap: 16px;
            }
        }

        .custom-sound-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .custom-sound-btn-compact {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.15);
            padding: 12px 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            text-align: center;
            position: relative;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            line-height: 1.2;
        }

        .custom-sound-btn-compact:hover {
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.15);
            transform: translateY(-1px);
        }

        .custom-sound-btn-compact.has-sound {
            border-color: rgba(34, 197, 94, 0.5);
            background: rgba(34, 197, 94, 0.08);
            color: #4ade80;
        }

        .custom-sound-btn-compact.has-sound:hover {
            border-color: rgba(34, 197, 94, 0.7);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2);
        }

        .custom-sound-btn-compact.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .custom-sound-number-compact {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 16px;
            height: 16px;
            background: rgba(99, 102, 241, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.6rem;
        }

        .custom-sound-edit-icon {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 16px;
            height: 16px;
            background: rgba(139, 92, 246, 0.8);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.6rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
        }

        .custom-sound-btn-compact:hover .custom-sound-edit-icon {
            opacity: 1;
        }

        .custom-sound-btn-compact.game-active .custom-sound-edit-icon {
            display: none;
        }

        @media (max-width: 768px) {
            .custom-sound-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .custom-sound-btn-compact {
                min-height: 50px;
                padding: 8px 6px;
                font-size: 0.7rem;
            }
        }

        .action-log {
            background: linear-gradient(135deg, rgba(139, 69, 219, 0.2) 0%, rgba(124, 58, 237, 0.1) 100%);
            border: 3px solid #8b45db;
            backdrop-filter: blur(20px);
            color: white;
            padding: 25px;
            border-radius: 15px;
            max-height: 240px;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(139, 69, 219, 0.2);
        }

        .action-log h4 {
            margin-bottom: 15px;
            text-align: center;
            color: #ecf0f1;
        }

        .log-entry {
            padding: 8px 12px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 5px;
            border-left: 4px solid #3498db;
            animation: slideIn 0.3s ease-out;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-entry.yellow {
            border-left-color: #f39c12;
        }

        .log-entry.blue {
            border-left-color: #3498db;
        }

        .log-entry.deleted {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .log-entry-text {
            flex: 1;
        }

        .log-entry-actions {
            display: flex;
            gap: 5px;
        }

        .log-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .log-action-btn.edit {
            background: #f39c12;
            color: white;
        }

        .log-action-btn.edit:hover {
            background: #e67e22;
        }

        .log-action-btn.delete {
            background: #e74c3c;
            color: white;
        }

        .log-action-btn.delete:hover {
            background: #c0392b;
        }

        .sounds-content {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 20px;
        }

        .sounds-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .sounds-header h2 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .upload-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 3px dashed #ddd;
            text-align: center;
        }

        .native-upload-btn {
            width: 100%;
            max-width: 300px;
            padding: 15px;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .native-upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }

        .sound-management {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .management-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .management-btn.clear {
            background: #e74c3c;
            color: white;
        }

        .management-btn.info {
            background: #3498db;
            color: white;
        }

        .management-btn.save {
            background: #27ae60;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(30, 58, 138, 0.4);
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #3b82f6;
            color: #e2e8f0;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #f1f5f9;
        }

        .modal p {
            color: #e2e8f0;
        }

        .modal label {
            color: #e2e8f0 !important;
        }

        .assist-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .assist-btn {
            padding: 10px;
            border: 2px solid #3498db;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: #64b5f6;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .assist-btn:hover {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
        }

        .modal-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .modal-btn.confirm {
            background: #27ae60;
            color: white;
        }

        .modal-btn.cancel {
            background: #e74c3c;
            color: white;
        }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .player-option {
            padding: 12px 16px;
            border: 2px solid #4a5568;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #2d3748;
            color: #e2e8f0;
            text-align: left;
        }

        .player-option:hover {
            border-color: #63b3ed;
            background: #4a5568;
            color: #ffffff;
        }

        .player-option.unassign {
            background: #4a1e1e;
            border-color: #e53e3e;
            color: #feb2b2;
            font-weight: bold;
        }

        .player-option.unassign:hover {
            background: #5a2323;
            border-color: #fc8181;
            color: #fed7d7;
        }

        #player-assignment-modal .modal-content {
            background: #1a202c;
            color: #e2e8f0;
            border: 1px solid #4a5568;
        }

        #player-assignment-modal h3 {
            color: #e2e8f0;
        }

        #player-assignment-modal p {
            color: #cbd5e0;
        }

        .player-option.assigned-yellow {
            background: linear-gradient(135deg, #2d3748, #4a4a00);
            border: 2px solid #ffd700;
            color: #fff2cc;
        }

        .player-option.assigned-yellow:hover {
            background: linear-gradient(135deg, #4a5568, #5c5c00);
            border-color: #ffed4a;
            color: #ffffff;
        }

        .player-option.assigned-blue {
            background: linear-gradient(135deg, #2d3748, #1e3a8a);
            border: 2px solid #3b82f6;
            color: #dbeafe;
        }

        .player-option.assigned-blue:hover {
            background: linear-gradient(135deg, #4a5568, #2563eb);
            border-color: #60a5fa;
            color: #ffffff;
        }

        .upload-status {
            color: #3498db;
            font-weight: bold;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background: #e3f2fd;
            display: none;
        }

        .rename-effects-container {
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .rename-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .rename-input label {
            flex: 0 0 100px;
            font-weight: bold;
            color: #2c3e50;
        }

        .rename-input input {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .rename-input .assign-sound-btn {
            flex: 0 0 auto;
        }

        @media (max-width: 768px) {
            .mode-toggle {
                gap: 5px;
                padding: 10px;
                max-width: 440px;
            }

            .mode-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .teams-setup {
                grid-template-columns: 1fr;
                gap: 20px;
                margin-bottom: 20px;
            }
            
            .team-name-input {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .sound-button-group {
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .own-goal-container {
                display: flex;
                align-items: center;
                justify-content: flex-start;
                gap: 15px;
                margin-top: 15px;
                padding: 16px;
                background: linear-gradient(135deg, rgba(231, 76, 60, 0.15) 0%, rgba(192, 57, 43, 0.1) 100%);
                border: 2px solid #e74c3c;
                border-radius: 12px;
                backdrop-filter: blur(10px);
                flex-direction: column;
                align-items: flex-start;
            }

            .teams-container {
                grid-template-columns: 1fr;
            }

            .score-board {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .vs {
                order: -1;
            }

            .players-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
            }

            .sounds-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .custom-sound-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @keyframes scoreAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .rename-effects-container {
        flex-direction: column;
        gap: 10px;
    }

    .rename-inputs {
        flex-direction: column;
        gap: 8px;
    }

    .custom-sound-buttons {
        justify-content: center;
        max-width: 100%;
    }

    .custom-sound-buttons button {
        min-width: 80px;
        max-width: 120px;
        font-size: 12px;
        padding: 8px 12px;
    }
        .score-animation {
            animation: scoreAnimation 0.5s ease-in-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse-warning {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        @keyframes pulse-danger {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); }
            50% { transform: scale(1.02); box-shadow: 0 0 0 5px rgba(229, 62, 62, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); }
        }

        /* Announcer Mode Styles */
.announcer-content {
    padding: 20px 16px;
    flex: 1;
}

.announcer-header {
    text-align: center;
    margin-bottom: 32px;
}

.announcer-header h2 {
    color: #ffffff;
    margin-bottom: 8px;
    font-size: 1.4rem;
    font-weight: 600;
}

.announcer-header p {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    margin: 0;
}

.announcer-rules {
    background: linear-gradient(135deg, rgba(139, 69, 219, 0.2) 0%, rgba(124, 58, 237, 0.1) 100%);
    backdrop-filter: blur(20px);
    border: 3px solid #8b45db;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 8px 32px rgba(139, 69, 219, 0.2);
}

.announcer-rules h3 {
    margin-bottom: 24px;
    color: #ffffff;
    text-align: center;
    font-size: 1.3rem;
    font-weight: 600;
}

.rule-item {
    display: flex;
    align-items: center;
    padding: 16px;
    margin-bottom: 12px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    border: 2px solid rgba(255, 255, 255, 0.15);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    gap: 12px;
}

.rule-item:hover {
    border-color: rgba(99, 102, 241, 0.5);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
    transform: translateY(-2px);
}

.rule-info {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 16px;
    min-width: 0;
}

.rule-icon {
    font-size: 28px;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    flex-shrink: 0;
}

.rule-details {
    flex: 1;
    min-width: 0;
}

.rule-title {
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 4px;
    font-size: 1rem;
    line-height: 1.2;
}

.rule-description {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
    line-height: 1.3;
}

.rule-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

.rule-status {
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.rule-status.assigned {
    background: rgba(34, 197, 94, 0.2);
    color: #4ade80;
    border: 1px solid rgba(34, 197, 94, 0.3);
}

.rule-status.not-assigned {
    background: rgba(239, 68, 68, 0.2);
    color: #f87171;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.rule-item .assign-sound-btn {
    padding: 10px 12px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 44px;
    max-width: 44px;
    white-space: nowrap;
    min-width: 100px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.rule-item .assign-sound-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
    background: linear-gradient(135deg, #5b5bd6, #7c3aed);
}

.rule-item .assign-sound-btn:active {
    transform: translateY(0);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
}

.custom-sound-name {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 14px;
    margin-top: 6px;
    transition: all 0.3s ease;
}

.custom-sound-name:focus {
    outline: none;
    border-color: rgba(99, 102, 241, 0.6);
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
}

.custom-sound-name::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

@media (max-width: 768px) {
    .announcer-content {
        padding: 16px 12px;
    }
    
    .rule-item {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 16px;
    }
    
    .rule-info {
        gap: 12px;
    }
    
    .rule-controls {
        justify-content: space-between;
        width: 100%;
    }
    
    .rule-controls .sound-button-group {
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .rule-item .assign-sound-btn {
        flex: 0 0 auto;
        min-width: 44px;
        max-width: 44px;
        padding: 10px 12px;
    }
    
    .rule-item .remove-sound-btn {
        flex: 0 0 auto;
        min-width: 44px;
        max-width: 44px;
        padding: 10px 12px;
    }
}

/* Players Mode Styles */
.players-mode {
    padding: 20px 16px;
    flex: 1;
}

.players-header {
    text-align: center;
    margin-bottom: 32px;
}

.players-header h2 {
    font-size: 1.4rem;
    color: #ffffff;
    margin-bottom: 6px;
    font-weight: 600;
}

.players-header p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
}

.add-player-section {
    background: linear-gradient(135deg, rgba(139, 69, 219, 0.2) 0%, rgba(124, 58, 237, 0.1) 100%);
    border: 3px solid #8b45db;
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 32px;
    box-shadow: 0 8px 32px rgba(139, 69, 219, 0.2);
}

.new-player-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

@media (min-width: 768px) {
    .new-player-form {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 12px;
        align-items: end;
    }
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-size: 14px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
}

.form-group input,
.form-group select {
    padding: 14px 16px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    font-size: 15px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    color: #1f2937;
    min-height: 48px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: rgba(99, 102, 241, 0.8);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2), 0 2px 10px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
}

.create-player-btn {
    padding: 16px 24px;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 16px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-height: 52px;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.create-player-btn:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4);
}

.edit-names-btn {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 14px 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 16px;
    min-height: 52px;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.edit-names-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
}

.edit-names-btn:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
}

.bulk-edit-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, rgba(79, 70, 229, 0.3), rgba(67, 56, 202, 0.2));
    border-radius: 12px;
    border: 1px solid rgba(139, 69, 219, 0.4);
}

.bulk-edit-header h3 {
    margin: 0 0 8px 0;
    color: #ffffff;
    font-size: 20px;
}

.bulk-edit-header p {
    margin: 0;
    color: #e2e8f0;
    font-size: 14px;
}

.bulk-edit-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 20px;
    margin-bottom: 12px;
    background: linear-gradient(135deg, rgba(139, 69, 219, 0.15), rgba(124, 58, 237, 0.1));
    border-radius: 10px;
    border: 1px solid rgba(139, 69, 219, 0.3);
    transition: all 0.2s ease;
    box-sizing: border-box;
    overflow: hidden;
}

.bulk-edit-item:hover {
    background: linear-gradient(135deg, rgba(139, 69, 219, 0.25), rgba(124, 58, 237, 0.2));
    border-color: rgba(139, 69, 219, 0.5);
    transform: translateY(-1px);
}

.bulk-edit-item label {
    font-weight: 600;
    color: #ffffff;
    min-width: 80px;
    font-size: 14px;
}

.bulk-edit-input {
    flex: 1;
    padding: 10px 14px;
    border: 2px solid #8b45db;
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.3s ease;
    background: linear-gradient(135deg, rgba(139, 69, 219, 0.2) 0%, rgba(124, 58, 237, 0.1) 100%);
    color: #ffffff;
    min-width: 0;
    max-width: 100%;
    box-sizing: border-box;
}

.bulk-edit-input:focus {
    outline: none;
    border-color: #8b45db;
    box-shadow: 0 0 0 3px rgba(139, 69, 219, 0.3);
    transform: translateY(-1px);
}

.players-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.player-card {
    background: linear-gradient(135deg, rgba(139, 69, 219, 0.2) 0%, rgba(124, 58, 237, 0.1) 100%);
    border: 3px solid #8b45db;
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(139, 69, 219, 0.2);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.player-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(139, 69, 219, 0.3);
}

.player-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.player-info h3 {
    font-size: 1.2rem;
    color: #ffffff;
    margin: 0;
    font-weight: 600;
}


.player-music {
    margin-top: 16px;
}

.music-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    cursor: pointer;
    padding: 4px 0;
    border-radius: 6px;
    transition: background-color 0.2s ease;
}

.music-header:hover {
    background: rgba(255, 255, 255, 0.05);
}

.music-header h4 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.expand-icon {
    font-size: 12px;
    transition: transform 0.3s ease;
    color: rgba(255, 255, 255, 0.6);
}

.expand-icon.expanded {
    transform: rotate(90deg);
}

.music-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.music-content.expanded {
    max-height: 300px;
}

.player-music h4 {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 12px;
    font-size: 14px;
    font-weight: 600;
}

.music-slots {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.music-slot {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border: 1px dashed rgba(255, 255, 255, 0.2);
}

.music-slot.has-music {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05));
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-style: solid;
}

.music-slot-number {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    min-width: 24px;
    text-align: center;
}

.music-info {
    flex: 1;
    font-size: 13px;
    color: rgba(255, 255, 255, 0.7);
}

.music-info.has-music {
    color: rgba(255, 255, 255, 0.9);
}

.music-controls {
    display: flex;
    gap: 4px;
}

.music-btn {
    padding: 6px 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-height: 32px;
}

.upload-music-btn {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    box-shadow: 0 2px 6px rgba(99, 102, 241, 0.3);
}

.play-music-btn {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
}

.remove-music-btn {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
}

.music-btn:active {
    transform: scale(0.96);
}

.delete-player-btn {
    background: rgba(239, 68, 68, 0.8);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 8px;
    cursor: pointer;
    font-size: 10px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 3px rgba(239, 68, 68, 0.3);
    opacity: 0.7;
    min-height: 28px;
    min-width: 28px;
}

.delete-player-btn:hover {
    opacity: 1;
    background: rgba(239, 68, 68, 1);
    transform: scale(1.05);
}

.delete-player-btn:active {
    transform: scale(0.96);
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: rgba(255, 255, 255, 0.6);
}

.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 16px;
}

.empty-state h3 {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: rgba(255, 255, 255, 0.8);
}

.empty-state p {
    font-size: 14px;
}
    </style>
</head>
<body>
<!-- Floating Stop Sound Button -->
<button id="floating-stop-btn" class="floating-mute-btn" onclick="stopCurrentAudio()" title="Stop current sound">
    <span id="stop-icon"></span>
</button>

<div class="container">
    <div class="header">
        <h1 id="main-title">Football Tracker & Announcer</h1>
        <div id="score-header" class="score-header" style="display: none;">
            <div class="team-score-header yellow-team">
                <span id="yellow-team-name-header">Yellow Team</span>
                <span id="yellow-score" class="score-display">0</span>
            </div>
            <div class="team-score-header blue-team">
                <span id="blue-score" class="score-display">0</span>
                <span id="blue-team-name-header">Blue Team</span>
            </div>
        </div>
        <div class="mode-toggle">
            <button class="mode-btn active" onclick="switchMode('game')"> Game</button>
            <button class="mode-btn" onclick="switchMode('setup')"> Setup</button>
            <button class="mode-btn" onclick="switchMode('players')"> Players</button>
            <button class="mode-btn" onclick="switchMode('announcer')"> Announcer</button>
            <button class="mode-btn" onclick="switchMode('custom-sounds')"> Effects</button>
        </div>
    </div>

    <!-- Setup Mode -->
    <div id="setup-mode" class="tab-content">
        <div class="setup-mode">
            <div class="setup-header">
                <h2> Game Setup</h2>
                <p>Configure team names, assign goal sounds, and prepare for the match</p>
            </div>
            <div class="teams-setup">
                <div class="team-setup yellow">
                    <h3> Yellow Team</h3>
                    <div class="team-name-input yellow">
                        <input type="text" id="yellow-team-name" placeholder="Enter team name (e.g., ci)" maxlength="25">
                        <div class="rule-controls">
                            <span class="rule-status not-assigned" id="yellow-team-status">Not Assigned</span>
                            <div class="sound-button-group">
                                <button class="assign-sound-btn" id="yellow-team-sound-btn" onclick="uploadSoundDirectly('yellow-team')"></button>
                                <button class="sound-test-btn" id="yellow-team-test-btn" onclick="testAssignedSound('yellow-team')" style="display: none;"></button>
                                <button class="remove-sound-btn" id="yellow-team-remove-btn" onclick="unassignSound('yellow-team')" title="Remove assigned sound"></button>
                            </div>
                        </div>
                    </div>
                    <div id="yellow-players">
                        <!-- Player dropdowns will be generated by JavaScript -->
                    </div>
                    <button class="add-player-btn" id="add-yellow-player" onclick="addPlayerDropdown('yellow')">
                         Add Player Slot
                    </button>
                    <div class="own-goal-container">
                        <div class="own-goal-label">OWN GOAL</div>
                        <div class="rule-controls">
                            <span class="rule-status not-assigned" id="yellow-own-goal-status">Not Assigned</span>
                            <div class="sound-button-group">
                                <button class="assign-sound-btn" id="yellow-own-goal-sound-btn" onclick="uploadSoundDirectly('yellow-own-goal')"></button>
                                <button class="sound-test-btn" id="yellow-own-goal-test-btn" onclick="testAssignedSound('yellow-own-goal')" style="display: none;"></button>
                                <button class="remove-sound-btn" id="yellow-own-goal-remove-btn" onclick="unassignSound('yellow-own-goal')" title="Remove assigned sound"></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="team-setup blue">
                    <h3> Blue Team</h3>
                    <div class="team-name-input blue">
                        <input type="text" id="blue-team-name" placeholder="Enter team name (e.g., Niebiescy)" maxlength="25">
                        <div class="rule-controls">
                            <span class="rule-status not-assigned" id="blue-team-status">Not Assigned</span>
                            <div class="sound-button-group">
                                <button class="assign-sound-btn" id="blue-team-sound-btn" onclick="uploadSoundDirectly('blue-team')"></button>
                                <button class="sound-test-btn" id="blue-team-test-btn" onclick="testAssignedSound('blue-team')" style="display: none;"></button>
                                <button class="remove-sound-btn" id="blue-team-remove-btn" onclick="unassignSound('blue-team')" title="Remove assigned sound"></button>
                            </div>
                        </div>
                    </div>
                    <div id="blue-players">
                        <!-- Player dropdowns will be generated by JavaScript -->
                    </div>
                    <button class="add-player-btn" id="add-blue-player" onclick="addPlayerDropdown('blue')">
                         Add Player Slot
                    </button>
                    <div class="own-goal-container">
                        <div class="own-goal-label">OWN GOAL</div>
                        <div class="rule-controls">
                            <span class="rule-status not-assigned" id="blue-own-goal-status">Not Assigned</span>
                            <div class="sound-button-group">
                                <button class="assign-sound-btn" id="blue-own-goal-sound-btn" onclick="uploadSoundDirectly('blue-own-goal')"></button>
                                <button class="sound-test-btn" id="blue-own-goal-test-btn" onclick="testAssignedSound('blue-own-goal')" style="display: none;"></button>
                                <button class="remove-sound-btn" id="blue-own-goal-remove-btn" onclick="unassignSound('blue-own-goal')" title="Remove assigned sound"></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="sample-btn" onclick="randomlyAssignPlayers()" style="font-size: 13px;"> Randomly Assign Leftover Players</button>
            
            <button onclick="clearAllPlayerAssignmentsWithConfirmation()" 
                    class="sample-btn"
                    style="background: linear-gradient(135deg, #dc2626, #b91c1c); 
                           color: white; 
                           border: 2px solid rgba(220, 38, 38, 0.3);
                           margin-top: 15px;"
                    onmouseover="this.style.background='linear-gradient(135deg, #b91c1c, #991b1b)'"
                    onmouseout="this.style.background='linear-gradient(135deg, #dc2626, #b91c1c)'">
                 Clear All Player Assignments
            </button>
        </div>
    </div>

    <!-- Game Mode -->
    <div id="game-mode" class="tab-content active">
        <div class="game-mode">

            <div class="game-controls">
                <button class="control-btn start" id="game-control-btn" onclick="toggleGame()"> START GAME</button>
                <button class="control-btn help" onclick="openHelpModal()"> HELP</button>
            </div>
            
            <div class="game-action-controls" id="game-action-controls" style="display: none;">
                <button class="control-btn undo" onclick="undoLastAction()"> UNDO</button>
                <button class="control-btn reset" onclick="resetMatch()"> RESET</button>
                <button class="control-btn export" onclick="exportLog()"> LOGS</button>
            </div>

            <div class="teams-container" id="teams-container" style="display: none;">
                <div class="team-players yellow">
                    <h4 id="yellow-players-header"> Yellow Team Players</h4>
                    <div class="players-grid" id="yellow-players-game"></div>
                </div>

                <div class="team-players blue">
                    <h4 id="blue-players-header"> Blue Team Players</h4>
                    <div class="players-grid" id="blue-players-game"></div>
                </div>
            </div>

            <!-- Custom Sounds Section -->
            <div class="custom-sounds-section" id="custom-sounds-section" style="display: none;">
                <h4 style="text-align: center; color: #e2e8f0; margin-bottom: 15px; font-size: 1.3rem;"> Custom Sound Effects</h4>
                <div class="custom-sounds-grid" id="custom-sounds-grid"></div>
            </div>

            <div class="action-log" id="action-log" style="display: none;">
                <h4 style="text-align: center; color: #e2e8f0; margin-bottom: 15px; font-size: 1.3rem;"> Action Log</h4>
                <div id="log-entries"></div>
            </div>
        </div>
    </div>

    <!-- Players Mode -->
    <div id="players-mode" class="tab-content">
        <div class="players-mode">
            <div class="players-header">
                <h2> Player Profiles</h2>
                <p>Create and manage player profiles with custom music</p>
                
            </div>

            <div class="add-player-section">
                <div class="new-player-form">
                    <div class="form-group">
                        <input type="text" id="new-player-name" placeholder="Enter player name" maxlength="30">
                    </div>
                    <button class="create-player-btn" onclick="createPlayerProfile()">
                         Create Player Profile
                    </button>
                    <button class="edit-names-btn" onclick="toggleBulkNameEdit()">
                         Edit Names
                    </button>
                </div>
            </div>

            <div class="players-grid" id="players-grid">
                <div class="empty-state">
                    <div class="empty-state-icon"></div>
                    <h3>No Players Yet</h3>
                    <p>Create your first player profile above</p>
                </div>
            </div>
        </div>
    </div>


<!-- Announcer Mode -->
<div id="announcer-mode" class="tab-content">
    <div class="announcer-content">
        <div class="announcer-header">
            <h2> Announcer Settings</h2>
            <p>Configure special sounds for game events</p>
        </div>

        <div class="announcer-rules">
            <h3> Event Sound Rules</h3>

            <div class="rule-item">
                <div class="rule-info">
                    <span class="rule-icon"></span>
                    <div class="rule-details">
                        <div class="rule-title">Start of the Game</div>
                        <div class="rule-description">Plays when the game timer starts</div>
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="announcer-game-start-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="announcer-game-start-btn" onclick="uploadSoundDirectly('announcer-game-start')"></button>
                        <button class="sound-test-btn" id="announcer-game-start-test-btn" onclick="testAssignedSound('announcer-game-start')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('announcer-game-start')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <span class="rule-icon"></span>
                    <div class="rule-details">
                        <div class="rule-title">First Goal of the Game</div>
                        <div class="rule-description">Plays before the first goal sound</div>
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="announcer-first-goal-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="announcer-first-goal-btn" onclick="uploadSoundDirectly('announcer-first-goal')"></button>
                        <button class="sound-test-btn" id="announcer-first-goal-test-btn" onclick="testAssignedSound('announcer-first-goal')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('announcer-first-goal')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <span class="rule-icon"></span>
                    <div class="rule-details">
                        <div class="rule-title">Player Hat Trick</div>
                        <div class="rule-description">When a player scores their third goal</div>
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="announcer-hat-trick-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="announcer-hat-trick-btn" onclick="uploadSoundDirectly('announcer-hat-trick')"></button>
                        <button class="sound-test-btn" id="announcer-hat-trick-test-btn" onclick="testAssignedSound('announcer-hat-trick')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('announcer-hat-trick')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <span class="rule-icon"></span>
                    <div class="rule-details">
                        <div class="rule-title">Player Scores 5 Goals</div>
                        <div class="rule-description">When a player reaches five goals</div>
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="announcer-five-goals-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="announcer-five-goals-btn" onclick="uploadSoundDirectly('announcer-five-goals')"></button>
                        <button class="sound-test-btn" id="announcer-five-goals-test-btn" onclick="testAssignedSound('announcer-five-goals')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('announcer-five-goals')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <span class="rule-icon"></span>
                    <div class="rule-details">
                        <div class="rule-title">End of the Match</div>
                        <div class="rule-description">Plays when the game timer stops</div>
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="announcer-game-end-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="announcer-game-end-btn" onclick="uploadSoundDirectly('announcer-game-end')"></button>
                        <button class="sound-test-btn" id="announcer-game-end-test-btn" onclick="testAssignedSound('announcer-game-end')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('announcer-game-end')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <span class="rule-icon"></span>
                    <div class="rule-details">
                        <div class="rule-title">Game is Tied</div>
                        <div class="rule-description">When both teams have the same score after a goal</div>
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="announcer-tie-game-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="announcer-tie-game-btn" onclick="uploadSoundDirectly('announcer-tie-game')"></button>
                        <button class="sound-test-btn" id="announcer-tie-game-test-btn" onclick="testAssignedSound('announcer-tie-game')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('announcer-tie-game')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <span class="rule-icon"></span>
                    <div class="rule-details">
                        <div class="rule-title">3 Goal Lead</div>
                        <div class="rule-description">When a team leads by 3 goals</div>
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="announcer-three-lead-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="announcer-three-lead-btn" onclick="uploadSoundDirectly('announcer-three-lead')"></button>
                        <button class="sound-test-btn" id="announcer-three-lead-test-btn" onclick="testAssignedSound('announcer-three-lead')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('announcer-three-lead')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <span class="rule-icon"></span>
                    <div class="rule-details">
                        <div class="rule-title">5 Goal Lead</div>
                        <div class="rule-description">When a team leads by 5 goals</div>
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="announcer-five-lead-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="announcer-five-lead-btn" onclick="uploadSoundDirectly('announcer-five-lead')"></button>
                        <button class="sound-test-btn" id="announcer-five-lead-test-btn" onclick="testAssignedSound('announcer-five-lead')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('announcer-five-lead')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Sounds Mode -->
<div id="custom-sounds-mode" class="tab-content">
    <div class="announcer-content">
        <div class="announcer-header">
            <h2> Custom Sound Effects</h2>
            <p>Upload and assign up to 10 custom sounds for manual playback during the game</p>
        </div>

        <div class="announcer-rules">
            <h3> Your Custom Sounds</h3>

            <div class="rule-item">
                <div class="rule-info">
                    <div class="rule-details">
                        <div class="rule-title"></div>
                        <input type="text" class="custom-sound-name" id="custom-sound-1-name" placeholder="Enter sound name..." onchange="updateCustomSoundName(1, this.value)">
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="custom-sound-1-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="custom-sound-1-btn" onclick="uploadSoundDirectly('custom-sound-1')"></button>
                        <button class="sound-test-btn" id="custom-sound-1-test-btn" onclick="testAssignedSound('custom-sound-1')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('custom-sound-1')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <div class="rule-details">
                        <div class="rule-title"></div>
                        <input type="text" class="custom-sound-name" id="custom-sound-2-name" placeholder="Enter sound name..." onchange="updateCustomSoundName(2, this.value)">
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="custom-sound-2-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="custom-sound-2-btn" onclick="uploadSoundDirectly('custom-sound-2')"></button>
                        <button class="sound-test-btn" id="custom-sound-2-test-btn" onclick="testAssignedSound('custom-sound-2')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('custom-sound-2')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <div class="rule-details">
                        <div class="rule-title"></div>
                        <input type="text" class="custom-sound-name" id="custom-sound-3-name" placeholder="Enter sound name..." onchange="updateCustomSoundName(3, this.value)">
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="custom-sound-3-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="custom-sound-3-btn" onclick="uploadSoundDirectly('custom-sound-3')"></button>
                        <button class="sound-test-btn" id="custom-sound-3-test-btn" onclick="testAssignedSound('custom-sound-3')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('custom-sound-3')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <div class="rule-details">
                        <div class="rule-title"></div>
                        <input type="text" class="custom-sound-name" id="custom-sound-4-name" placeholder="Enter sound name..." onchange="updateCustomSoundName(4, this.value)">
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="custom-sound-4-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="custom-sound-4-btn" onclick="uploadSoundDirectly('custom-sound-4')"></button>
                        <button class="sound-test-btn" id="custom-sound-4-test-btn" onclick="testAssignedSound('custom-sound-4')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('custom-sound-4')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <div class="rule-details">
                        <div class="rule-title"></div>
                        <input type="text" class="custom-sound-name" id="custom-sound-5-name" placeholder="Enter sound name..." onchange="updateCustomSoundName(5, this.value)">
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="custom-sound-5-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="custom-sound-5-btn" onclick="uploadSoundDirectly('custom-sound-5')"></button>
                        <button class="sound-test-btn" id="custom-sound-5-test-btn" onclick="testAssignedSound('custom-sound-5')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('custom-sound-5')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <div class="rule-details">
                        <div class="rule-title"></div>
                        <input type="text" class="custom-sound-name" id="custom-sound-6-name" placeholder="Enter sound name..." onchange="updateCustomSoundName(6, this.value)">
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="custom-sound-6-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="custom-sound-6-btn" onclick="uploadSoundDirectly('custom-sound-6')"></button>
                        <button class="sound-test-btn" id="custom-sound-6-test-btn" onclick="testAssignedSound('custom-sound-6')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('custom-sound-6')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <div class="rule-details">
                        <div class="rule-title"></div>
                        <input type="text" class="custom-sound-name" id="custom-sound-7-name" placeholder="Enter sound name..." onchange="updateCustomSoundName(7, this.value)">
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="custom-sound-7-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="custom-sound-7-btn" onclick="uploadSoundDirectly('custom-sound-7')"></button>
                        <button class="sound-test-btn" id="custom-sound-7-test-btn" onclick="testAssignedSound('custom-sound-7')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('custom-sound-7')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <div class="rule-details">
                        <div class="rule-title"></div>
                        <input type="text" class="custom-sound-name" id="custom-sound-8-name" placeholder="Enter sound name..." onchange="updateCustomSoundName(8, this.value)">
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="custom-sound-8-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="custom-sound-8-btn" onclick="uploadSoundDirectly('custom-sound-8')"></button>
                        <button class="sound-test-btn" id="custom-sound-8-test-btn" onclick="testAssignedSound('custom-sound-8')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('custom-sound-8')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <div class="rule-details">
                        <div class="rule-title"></div>
                        <input type="text" class="custom-sound-name" id="custom-sound-9-name" placeholder="Enter sound name..." onchange="updateCustomSoundName(9, this.value)">
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="custom-sound-9-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="custom-sound-9-btn" onclick="uploadSoundDirectly('custom-sound-9')"></button>
                        <button class="sound-test-btn" id="custom-sound-9-test-btn" onclick="testAssignedSound('custom-sound-9')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('custom-sound-9')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

            <div class="rule-item">
                <div class="rule-info">
                    <div class="rule-details">
                        <div class="rule-title"></div>
                        <input type="text" class="custom-sound-name" id="custom-sound-10-name" placeholder="Enter sound name..." onchange="updateCustomSoundName(10, this.value)">
                    </div>
                </div>
                <div class="rule-controls">
                    <span class="rule-status not-assigned" id="custom-sound-10-status">Not Assigned</span>
                    <div class="sound-button-group">
                        <button class="assign-sound-btn" id="custom-sound-10-btn" onclick="uploadSoundDirectly('custom-sound-10')"></button>
                        <button class="sound-test-btn" id="custom-sound-10-test-btn" onclick="testAssignedSound('custom-sound-10')" style="display: none;"></button>
                        <button class="remove-sound-btn" onclick="unassignSound('custom-sound-10')" title="Remove assigned sound"></button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Assist Modal -->
<div id="assist-modal" class="modal">
    <div class="modal-content">
        <h3> Was there an assist?</h3>
        <p>Goal by: <span id="goal-scorer"></span></p>
        <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Click an assistant's name to confirm, or choose an option below:</p>
        <div class="assist-buttons" id="assist-buttons"></div>
        <div class="modal-controls">
            <button class="modal-btn confirm" onclick="confirmGoal()"> No Assist</button>
            <button class="modal-btn cancel" onclick="cancelGoal()"> Cancel Goal</button>
        </div>
    </div>
</div>

<!-- OWN GOAL Modal -->
<div id="own-goal-modal" class="modal">
    <div class="modal-content">
        <h3> Own Goal Confirmation</h3>
        <p>Own goal for: <span id="own-goal-team"></span></p>
        <p style="font-size: 14px; color: #666; margin-bottom: 15px;">This will score a goal for the opposing team.</p>
        <div class="modal-controls">
            <button class="modal-btn confirm" onclick="confirmOwnGoal()"> Confirm Own Goal</button>
            <button class="modal-btn cancel" onclick="cancelOwnGoal()"> Cancel</button>
        </div>
    </div>
</div>


<!-- Edit Log Modal -->
<div id="edit-log-modal" class="modal">
    <div class="modal-content">
        <h3> Edit Goal</h3>
        <div style="margin: 20px 0; text-align: left;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">Goal Scorer:</label>
            <select id="edit-goal-scorer" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 5px;">
                <!-- Options will be populated -->
            </select>

            <label style="display: block; margin-bottom: 10px; font-weight: bold;">Assistant (optional):</label>
            <select id="edit-assistant" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                <option value="">No Assist</option>
                <!-- Options will be populated -->
            </select>
        </div>
        <div class="modal-controls">
            <button class="modal-btn confirm" onclick="saveEditedGoal()"> Save Changes</button>
            <button class="modal-btn cancel" onclick="closeEditLog()"> Cancel</button>
        </div>
    </div>
</div>

<!-- Delete Entry Confirmation Modal -->
<div id="delete-entry-modal" class="modal">
    <div class="modal-content">
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="display: inline-block; width: 60px; height: 60px; background: linear-gradient(135deg, #e74c3c, #c0392b); border-radius: 50%; margin-bottom: 10px; position: relative;">
                <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; color: white;"></span>
            </div>
            <h3 style="color: #fca5a5; font-size: 20px; margin: 0; font-weight: bold;">DELETE ENTRY</h3>
        </div>
        
        <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; border-radius: 10px; padding: 15px; margin: 15px 0; text-align: center;">
            <p style="color: #fca5a5; font-size: 16px; font-weight: bold; margin: 0 0 10px 0;">Entry to Delete:</p>
            <p id="delete-entry-text" style="color: #f1f5f9; font-size: 14px; margin: 0 0 12px 0; line-height: 1.3; font-weight: bold;"></p>
            
            <div style="background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%); border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin: 12px 0;">
                <p style="color: #fca5a5; font-weight: bold; font-size: 14px; margin: 0 0 8px 0;"> This action will:</p>
                <ul style="color: #e2e8f0; font-size: 13px; margin: 0; padding-left: 20px; text-align: left;">
                    <li>Remove the entry from match log</li>
                    <li>Update team scores</li>
                    <li>Update player statistics</li>
                </ul>
            </div>
            
            <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 6px; padding: 8px; margin: 10px 0;">
                <p style="color: #fca5a5; font-weight: bold; font-size: 14px; margin: 0;"> THIS ACTION CANNOT BE UNDONE </p>
            </div>
        </div>
        
        <div class="modal-controls" style="margin-top: 20px;">
            <button class="modal-btn cancel" onclick="cancelDeleteEntry()" style="background: #48bb78; padding: 12px 24px; font-weight: bold;">
                 Cancel
            </button>
            <button class="modal-btn confirm" onclick="confirmDeleteEntry()" style="background: #e53e3e; padding: 12px 24px; font-weight: bold;">
                 Delete Entry
            </button>
        </div>
    </div>
</div>

<!-- Reset Confirmation Modal -->
<div id="reset-modal" class="modal">
    <div class="modal-content">
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="display: inline-block; width: 60px; height: 60px; background: linear-gradient(135deg, #e74c3c, #c0392b); border-radius: 50%; margin-bottom: 10px; position: relative; animation: pulse-warning 2s infinite;">
                <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; color: white;"></span>
            </div>
            <h3 style="color: #fca5a5; font-size: 20px; margin: 0; font-weight: bold;">RESET MATCH</h3>
        </div>
        
        <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; border-radius: 10px; padding: 15px; margin: 15px 0; text-align: center;">
            <p style="color: #fca5a5; font-size: 16px; font-weight: bold; margin: 0 0 10px 0;"> DANGER ZONE </p>
            <p style="color: #e2e8f0; font-size: 14px; margin: 0 0 12px 0; line-height: 1.3;">This action will <strong>permanently erase</strong> all match progress</p>
            
            <div style="background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%); border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin: 12px 0;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; text-align: left; font-size: 13px;">
                    <div style="display: flex; align-items: center; color: #fca5a5;">
                        <span style="margin-right: 6px;"></span>
                        <span>Score  0-0</span>
                    </div>
                    <div style="display: flex; align-items: center; color: #fca5a5;">
                        <span style="margin-right: 6px;"></span>
                        <span>All goals deleted</span>
                    </div>
                    <div style="display: flex; align-items: center; color: #fca5a5;">
                        <span style="margin-right: 6px;"></span>
                        <span>All assists deleted</span>
                    </div>
                    <div style="display: flex; align-items: center; color: #fca5a5;">
                        <span style="margin-right: 6px;"></span>
                        <span>Player stats reset</span>
                    </div>
                </div>
                <div style="display: flex; align-items: center; color: #fca5a5; margin-top: 8px; justify-content: center;">
                    <span style="margin-right: 6px;"></span>
                    <span>Complete match history erased</span>
                </div>
            </div>
            
            <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 6px; padding: 8px; margin: 10px 0;">
                <p style="color: #fca5a5; font-weight: bold; font-size: 14px; margin: 0;"> THIS ACTION CANNOT BE UNDONE </p>
            </div>
        </div>
        
        <div class="modal-controls" style="margin-top: 20px;">
            <button class="modal-btn cancel" onclick="cancelReset()" style="background: #48bb78; padding: 12px 24px; font-weight: bold;">
                 Keep Match Data
            </button>
            <button class="modal-btn confirm" onclick="confirmReset()" style="background: #e53e3e; padding: 12px 24px; font-weight: bold; animation: pulse-danger 2s infinite;">
                 DELETE EVERYTHING
            </button>
        </div>
    </div>
</div>

<!-- Player Assignment Modal -->
<div id="player-assignment-modal" class="modal">
    <div class="modal-content">
        <h3> Assign Player</h3>
        <p>Select a player for <span id="assignment-slot-info"></span>:</p>
        <div class="player-list" id="player-assignment-list" style="max-height: 300px; overflow-y: auto; margin: 15px 0;">
            <!-- Player options will be populated here -->
        </div>
        <div class="modal-controls">
            <button class="modal-btn cancel" onclick="closePlayerAssignmentModal()"> Cancel</button>
        </div>
    </div>
</div>

<!-- Clear All Player Assignments Confirmation Modal -->
<div id="clear-assignments-modal" class="modal">
    <div class="modal-content">
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="display: inline-block; width: 60px; height: 60px; background: linear-gradient(135deg, #e74c3c, #c0392b); border-radius: 50%; margin-bottom: 10px; position: relative;">
                <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; color: white;"></span>
            </div>
            <h3 style="color: #fca5a5; font-size: 20px; margin: 0; font-weight: bold;">CLEAR ASSIGNMENTS</h3>
        </div>
        
        <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; border-radius: 10px; padding: 15px; margin: 15px 0; text-align: center;">
            <p style="color: #fca5a5; font-size: 16px; font-weight: bold; margin: 0 0 10px 0;"> CLEAR ALL PLAYER ASSIGNMENTS </p>
            <p id="clear-assignments-text" style="color: #f1f5f9; font-size: 14px; margin: 0 0 12px 0; line-height: 1.3; font-weight: bold;"></p>
            
            <div style="background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%); border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin: 12px 0;">
                <p style="color: #fca5a5; font-weight: bold; font-size: 14px; margin: 0 0 8px 0;"> This action will:</p>
                <ul style="color: #e2e8f0; font-size: 13px; margin: 0; padding-left: 20px; text-align: left;">
                    <li>Remove all player assignments from both teams</li>
                    <li>Reset all player slots to unassigned state</li>
                    <li>Save the changes permanently</li>
                </ul>
            </div>
            
            <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 6px; padding: 8px; margin: 10px 0;">
                <p style="color: #fca5a5; font-weight: bold; font-size: 14px; margin: 0;"> THIS ACTION CANNOT BE UNDONE </p>
            </div>
        </div>
        
        <div class="modal-controls" style="margin-top: 20px;">
            <button class="modal-btn cancel" onclick="cancelClearAssignments()" style="background: #48bb78; padding: 12px 24px; font-weight: bold;">
                 Keep Assignments
            </button>
            <button class="modal-btn confirm" onclick="confirmClearAssignments()" style="background: #e53e3e; padding: 12px 24px; font-weight: bold;">
                 Clear All Assignments
            </button>
        </div>
    </div>
</div>

<div id="edit-log-modal" class="modal">
    <div class="modal-content">
        <h3> Edit Goal</h3>
        <div style="margin: 20px 0; text-align: left;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">Goal Scorer:</label>
            <select id="edit-goal-scorer" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 5px;">
                <!-- Options will be populated -->
            </select>

            <label style="display: block; margin-bottom: 10px; font-weight: bold;">Assistant (optional):</label>
            <select id="edit-assistant" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px;">
                <option value="">No Assist</option>
                <!-- Options will be populated -->
            </select>
        </div>
        <div class="modal-controls">
            <button class="modal-btn confirm" onclick="saveEditedGoal()"> Save Changes</button>
            <button class="modal-btn cancel" onclick="closeEditLog()"> Cancel</button>
        </div>
    </div>
</div>
<script>
    
    
    // Global audio control variables
    var currentAudio = null;
    var audioTimeout = null;
    var currentSoundTarget = null;
    var currentEditLogIndex = null;
    var expandedMusicSections = {}; // Track which player music sections are expanded
    var isAppInitialized = false; // Prevent re-initialization on Bluetooth events

    var gameState = {
        isGameStarted: false,
        hasGameBeenStarted: false,
        yellowScore: 0,
        blueScore: 0,
        yellowPlayers: [],
        bluePlayers: [],
        yellowPlayerSlots: {}, // Map player name to original slot number
        bluePlayerSlots: {}, // Map player name to original slot number
        yellowPlayerCount: 7,
        bluePlayerCount: 7,
        yellowTeamName: '',
        blueTeamName: '',
        actionLog: [],
        currentGoal: null,
        sounds: [],
        soundAssignments: {},
        playerAssignments: {},
        playerStats: {},
        totalGoalsScored: 0,
        hasThreeGoalLead: false,
        hasFiveGoalLead: false,
        customSoundNames: {
            1: 'Yellow Card',
            2: 'Red Card',
            3: 'Penalty',
            4: 'Corner',
            5: 'Free Kick',
            6: 'Offside',
            7: 'Foul',
            8: 'Celebration'
        }
    };


    function debugLog(message) {
        console.log('[FootballTracker] ' + message);
        if (window.AndroidInterface) {
            window.AndroidInterface.logMessage(message);
        }
    }

    // Help Modal Functions
    function openHelpModal() {
        debugLog('Opening help modal');
        var modal = document.getElementById('helpModal');
        if (modal) {
            modal.style.display = 'block';
            // Prevent background scrolling
            document.body.style.overflow = 'hidden';
        }
    }

    function closeHelpModal() {
        debugLog('Closing help modal');
        var modal = document.getElementById('helpModal');
        if (modal) {
            modal.style.display = 'none';
            // Re-enable background scrolling
            document.body.style.overflow = 'auto';
        }
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
        var modal = document.getElementById('helpModal');
        if (event.target === modal) {
            closeHelpModal();
        }
    }

    // Function to update Edit Names button visibility based on game state
    function updateEditNamesButtonVisibility() {
        var editNamesBtn = document.querySelector('.edit-names-btn');
        if (editNamesBtn) {
            if (gameState.isGameStarted) {
                editNamesBtn.style.display = 'none';
            } else {
                editNamesBtn.style.display = 'inline-block';
            }
        }
    }

    function switchMode(mode) {
        debugLog('Switching to mode: ' + mode);

        var tabContents = document.querySelectorAll('.tab-content');
        for (var i = 0; i < tabContents.length; i++) {
            tabContents[i].classList.remove('active');
        }

        var modeButtons = document.querySelectorAll('.mode-btn');
        for (var i = 0; i < modeButtons.length; i++) {
            modeButtons[i].classList.remove('active');
        }

        var selectedTab = document.getElementById(mode + '-mode');
        if (selectedTab) {
            selectedTab.classList.add('active');
        }

        var buttons = document.querySelectorAll('.mode-btn');
        if (mode === 'game') {
            buttons[0].classList.add('active');
            updateCustomSoundButtons();
        } else if (mode === 'setup') {
            buttons[1].classList.add('active');
            // Update all sound assignment buttons
            updateAllSoundAssignmentButtons();
            // Refresh player dropdowns with latest player list
            refreshPlayerDropdowns();
        } else if (mode === 'players') {
            buttons[2].classList.add('active');
            displayPlayerProfiles();
        } else if (mode === 'announcer') {
              buttons[3].classList.add('active');
              updateAnnouncerButtons();
        } else if (mode === 'custom-sounds') {
              buttons[4].classList.add('active');
              updateCustomSoundsButtons();
        }
        
        // Instantly position at top - no scrolling motion
        document.documentElement.style.scrollBehavior = 'auto';
        document.body.style.scrollBehavior = 'auto';
        
        // Force immediate positioning at top
        setTimeout(function() {
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            window.pageYOffset = 0;
        }, 0);
    }

    // Test assigned sound function
    function testAssignedSound(assignment) {
        // Stop any currently playing audio first
        stopCurrentAudio();
        
        var soundId = gameState.soundAssignments[assignment];
        if (soundId) {
            var sound = gameState.sounds.find(function(s) { return s.id === soundId; });
            if (sound) {
                playSound(sound, 'Testing: ' + assignment);
            } else {
                debugLog('Sound not found for assignment: ' + assignment);
            }
        } else {
            debugLog('No sound assigned to: ' + assignment);
        }
    }

    function updateAllSoundAssignmentButtons() {
        // Update team buttons
        updateSoundAssignmentButton('yellow-team');
        updateSoundAssignmentButton('blue-team');

        // Update own goal buttons
        updateSoundAssignmentButton('yellow-own-goal');
        updateSoundAssignmentButton('blue-own-goal');

        // Update all player buttons
        for (var i = 1; i <= gameState.yellowPlayerCount; i++) {
            updateSoundAssignmentButton('yellow-player-' + i);
        }
        for (var i = 1; i <= gameState.bluePlayerCount; i++) {
            updateSoundAssignmentButton('blue-player-' + i);
        }

        // Update custom sound buttons
        for (var i = 1; i <= 8; i++) {
            updateSoundAssignmentButton('custom-sound-' + i);
        } updateAnnouncerButtons();
    }

    function initializePlayerSlots() {
        debugLog('Initializing player dropdowns');

        // Initialize Yellow team dropdowns (default 7 players)
        var yellowContainer = document.getElementById('yellow-players');
        yellowContainer.innerHTML = '';
        for (var i = 1; i <= 7; i++) {
            addPlayerDropdownElement('yellow', i);
        }

        // Initialize Blue team dropdowns (default 7 players)
        var blueContainer = document.getElementById('blue-players');
        blueContainer.innerHTML = '';
        for (var i = 1; i <= 7; i++) {
            addPlayerDropdownElement('blue', i);
        }

        gameState.yellowPlayerCount = 7;
        gameState.bluePlayerCount = 7;

        // Update team and own goal sound buttons
        updateSoundAssignmentButton('yellow-team');
        updateSoundAssignmentButton('blue-team');
        updateSoundAssignmentButton('yellow-own-goal');
        updateSoundAssignmentButton('blue-own-goal');
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        var assistModal = document.getElementById('assist-modal');
        var ownGoalModal = document.getElementById('own-goal-modal');
        var editLogModal = document.getElementById('edit-log-modal');
        var resetModal = document.getElementById('reset-modal');
        var deleteEntryModal = document.getElementById('delete-entry-modal');
        var playerAssignmentModal = document.getElementById('player-assignment-modal');

        if (event.target === assistModal) {
            cancelGoal();
        } else if (event.target === ownGoalModal) {
            cancelOwnGoal();
        } else if (event.target === editLogModal) {
            closeEditLog();
        } else if (event.target === resetModal) {
            cancelReset();
        } else if (event.target === deleteEntryModal) {
            cancelDeleteEntry();
        } else if (event.target === playerAssignmentModal) {
            closePlayerAssignmentModal();
        }
    }

    function generateMatchReport() {
        var timestamp = new Date();
        var report = ' FOOTBALL MATCH REPORT\n';
        report += '==================================================\n\n';
        report += 'Date: ' + timestamp.toLocaleDateString() + '\n';
        report += 'Time: ' + timestamp.toLocaleTimeString() + '\n\n';

        report += 'FINAL SCORE\n';
        report += '--------------------\n';
        report += ' ' + gameState.yellowTeamName + ': ' + gameState.yellowScore + '\n';
        report += ' ' + gameState.blueTeamName + ': ' + gameState.blueScore + '\n\n';

        report += 'TEAM ROSTERS\n';
        report += '--------------------\n';
        var yellowPlayers = [];
        for (var i = 0; i < gameState.yellowPlayers.length; i++) {
            if (gameState.yellowPlayers[i] !== 'OWN GOAL') {
                yellowPlayers.push(gameState.yellowPlayers[i]);
            }
        }
        var bluePlayers = [];
        for (var i = 0; i < gameState.bluePlayers.length; i++) {
            if (gameState.bluePlayers[i] !== 'OWN GOAL') {
                bluePlayers.push(gameState.bluePlayers[i]);
            }
        }
        report += ' ' + gameState.yellowTeamName + ' (' + yellowPlayers.length + ' players): ' + yellowPlayers.join(', ') + '\n';
        report += ' ' + gameState.blueTeamName + ' (' + bluePlayers.length + ' players): ' + bluePlayers.join(', ') + '\n\n';

        var allPlayerStats = getAllPlayerStats();
        if (allPlayerStats.length > 0) {
            report += 'PLAYER STATISTICS\n';
            report += '--------------------\n';
            for (var i = 0; i < allPlayerStats.length; i++) {
                var player = allPlayerStats[i];
                var teamName = player.team === 'yellow' ? gameState.yellowTeamName : gameState.blueTeamName;
                var teamEmoji = player.team === 'yellow' ? '' : '';

                var statsText = '';
                if (player.goals > 0 && player.assists > 0) {
                    statsText = player.goals + ' goal' + (player.goals !== 1 ? 's' : '') + ', ' + player.assists + ' assist' + (player.assists !== 1 ? 's' : '');
                } else if (player.goals > 0) {
                    statsText = player.goals + ' goal' + (player.goals !== 1 ? 's' : '');
                } else if (player.assists > 0) {
                    statsText = player.assists + ' assist' + (player.assists !== 1 ? 's' : '');
                }

                if (statsText) {
                    report += (i + 1) + '. ' + player.name + ' (' + teamEmoji + ' ' + teamName + ') - ' + statsText + '\n';
                }
            }
            report += '\n';
        }

        report += 'MATCH EVENTS\n';
        report += '--------------------\n';
        var eventNum = 1;
        for (var i = 0; i < gameState.actionLog.length; i++) {
            var action = gameState.actionLog[i];
            var time = action.timestamp ? action.timestamp.toLocaleTimeString() : 'Unknown time';
            report += eventNum + '. [' + time + '] ' + action.text + '\n';
            eventNum++;
        }

        report += '\n==================================================\n';
        report += 'Report generated by Football Match Tracker\n';

        return report;
    }

    // Functions for editing and deleting log entries
    function editLogEntry(index) {
        var entry = gameState.actionLog[index];
        if (!entry || (entry.type !== 'goal' && entry.type !== 'own-goal')) return;

        currentEditLogIndex = index;

        // Populate scorer dropdown
        var scorerSelect = document.getElementById('edit-goal-scorer');
        scorerSelect.innerHTML = '';

        var teamPlayers = entry.team === 'yellow' ? gameState.yellowPlayers : gameState.bluePlayers;
        for (var i = 0; i < teamPlayers.length; i++) {
            var option = document.createElement('option');
            option.value = teamPlayers[i];
            option.textContent = teamPlayers[i];
            if (teamPlayers[i] === entry.player) {
                option.selected = true;
            }
            scorerSelect.appendChild(option);
        }

        // Function to update assistant dropdown based on selected scorer
        function updateAssistDropdown() {
            var selectedScorer = scorerSelect.value;
            var assistSelect = document.getElementById('edit-assistant');
            var currentAssist = assistSelect.value;
            
            // If OWN GOAL is selected, disable assist dropdown
            if (selectedScorer === 'OWN GOAL') {
                assistSelect.innerHTML = '<option value="">No Assist (Own goals cannot have assists)</option>';
                assistSelect.disabled = true;
                assistSelect.style.backgroundColor = '#1a1a2e';
                assistSelect.style.color = '#666';
                return;
            }
            
            // Re-enable dropdown for regular players
            assistSelect.disabled = false;
            assistSelect.style.backgroundColor = '';
            assistSelect.style.color = '';
            
            assistSelect.innerHTML = '<option value="">No Assist</option>';

            for (var i = 0; i < teamPlayers.length; i++) {
                if (teamPlayers[i] !== 'OWN GOAL' && teamPlayers[i] !== selectedScorer) {
                    var option = document.createElement('option');
                    option.value = teamPlayers[i];
                    option.textContent = teamPlayers[i];
                    if (teamPlayers[i] === currentAssist) {
                        option.selected = true;
                    }
                    assistSelect.appendChild(option);
                }
            }
        }

        // Add event listener to scorer dropdown to update assistant options
        scorerSelect.addEventListener('change', updateAssistDropdown);

        // Initial population of assistant dropdown
        updateAssistDropdown();
        
        // Set the original assist if it exists and is valid
        if (entry.assist && entry.assist !== entry.player) {
            document.getElementById('edit-assistant').value = entry.assist;
        }

        document.getElementById('edit-log-modal').style.display = 'block';
    }

    function saveEditedGoal() {
        if (currentEditLogIndex === null) return;

        var entry = gameState.actionLog[currentEditLogIndex];
        var newScorer = document.getElementById('edit-goal-scorer').value;
        var newAssist = document.getElementById('edit-assistant').value;

        // Validation: prevent same player being scorer and assistant
        if (newAssist && newScorer === newAssist) {
            alert(' Error: A player cannot be both the scorer and the assistant for the same goal!');
            return;
        }

        // Validation: OWN GOAL cannot have an assist
        if (newScorer === 'OWN GOAL' && newAssist) {
            alert(' Error: Own goals cannot have assists!');
            return;
        }

        // Update player stats - remove old stats
        if (entry.player !== 'OWN GOAL') {
            var oldPlayerKey = entry.team + '-' + entry.player;
            if (gameState.playerStats[oldPlayerKey]) {
                gameState.playerStats[oldPlayerKey].goals = Math.max(0, gameState.playerStats[oldPlayerKey].goals - 1);
            }
        }

        if (entry.assist) {
            var oldAssistKey = entry.team + '-' + entry.assist;
            if (gameState.playerStats[oldAssistKey]) {
                gameState.playerStats[oldAssistKey].assists = Math.max(0, gameState.playerStats[oldAssistKey].assists - 1);
            }
        }

        // Update entry
        entry.player = newScorer;
        entry.assist = newAssist || null;

        // Update entry type and log text based on scorer
        if (newScorer === 'OWN GOAL') {
            // Converting to own goal
            entry.type = 'own-goal';
            entry.scoringTeam = entry.team; // The team that scored gets the goal
            var logText = 'Own Goal by ' + (entry.team === 'yellow' ? gameState.yellowTeamName : gameState.blueTeamName) + ' (Goal for ' + (entry.team === 'yellow' ? gameState.yellowTeamName : gameState.blueTeamName) + ')';
            entry.text = logText;
        } else {
            // Converting to regular goal
            entry.type = 'goal';
            if (entry.scoringTeam) {
                delete entry.scoringTeam; // Remove own goal properties
            }
            var logText = 'Goal: ' + entry.player;
            if (entry.assist) {
                logText += ', Assist: ' + entry.assist;
            }
            logText += ' (' + (entry.team === 'yellow' ? gameState.yellowTeamName : gameState.blueTeamName) + ')';
            entry.text = logText;
        }

        // Add new stats
        updatePlayerStats(entry);

        // Save game state after editing
        saveGameState();

        // Update UI
        var logEntry = document.querySelector('[data-log-index="' + currentEditLogIndex + '"]');
        if (logEntry) {
            var textSpan = logEntry.querySelector('.log-entry-text');
            if (textSpan) {
                textSpan.textContent = entry.text;
            }
            
            // Update CSS class and buttons based on entry type
            var logEntryIndex = parseInt(logEntry.getAttribute('data-log-index'));
            if (entry.type === 'own-goal') {
                logEntry.className = 'log-entry ' + entry.scoringTeam;
                logEntry.innerHTML = '<span class="log-entry-text">' + entry.text + '</span>' +
                    '<div class="log-entry-actions">' +
                    '<button class="log-action-btn edit" onclick="if(window.AndroidInterface) window.AndroidInterface.showToast(\'Edit clicked from save!\'); editLogEntry(' + logEntryIndex + ')"></button>' +
                    '<button class="log-action-btn delete" onclick="if(window.AndroidInterface) window.AndroidInterface.showToast(\'Delete clicked from save for index ' + logEntryIndex + '!\'); deleteLogEntry(' + logEntryIndex + ')"></button>' +
                    '</div>';
            } else {
                logEntry.className = 'log-entry ' + entry.team;
                logEntry.innerHTML = '<span class="log-entry-text">' + entry.text + '</span>' +
                    '<div class="log-entry-actions">' +
                    '<button class="log-action-btn edit" onclick="if(window.AndroidInterface) window.AndroidInterface.showToast(\'Edit clicked from save!\'); editLogEntry(' + logEntryIndex + ')"></button>' +
                    '<button class="log-action-btn delete" onclick="if(window.AndroidInterface) window.AndroidInterface.showToast(\'Delete clicked from save for index ' + logEntryIndex + '!\'); deleteLogEntry(' + logEntryIndex + ')"></button>' +
                    '</div>';
            }
        }

        closeEditLog();

    }

    function closeEditLog() {
        document.getElementById('edit-log-modal').style.display = 'none';
        currentEditLogIndex = null;
    }

    function deleteLogEntry(index) {
    debugLog('Delete button clicked for index: ' + index);
    // if (window.AndroidInterface) {
    //     window.AndroidInterface.showToast('deleteLogEntry called with index: ' + index);
    // }
    var entry = gameState.actionLog[index];
    if (!entry) {
        debugLog('No entry found at index: ' + index);
        // if (window.AndroidInterface) {
        //     window.AndroidInterface.showToast('No entry found at index: ' + index);
        // }
        return;
    }

    // Store the index for the modal
    window.pendingDeleteIndex = index;
    
    // Set the entry text in the modal
    document.getElementById('delete-entry-text').textContent = entry.text;
    
    // Show the custom delete confirmation modal
    document.getElementById('delete-entry-modal').style.display = 'block';
}

// Delete modal functions
function cancelDeleteEntry() {
    document.getElementById('delete-entry-modal').style.display = 'none';
    window.pendingDeleteIndex = null;
    if (window.AndroidInterface) {
        // window.AndroidInterface.showToast('Delete cancelled');
    }
}

function confirmDeleteEntry() {
    document.getElementById('delete-entry-modal').style.display = 'none';
    
    if (window.pendingDeleteIndex !== null && window.pendingDeleteIndex !== undefined) {
        var index = window.pendingDeleteIndex;
        window.pendingDeleteIndex = null;
        
        if (window.AndroidInterface) {
            // window.AndroidInterface.showToast('Deleting entry at index: ' + index);
        }
        
        // Now perform the actual deletion
        performDeleteEntry(index);
    }
}

// Extracted the actual deletion logic into a separate function
function performDeleteEntry(index) {
    var entry = gameState.actionLog[index];
    if (!entry) {
        if (window.AndroidInterface) {
            // window.AndroidInterface.showToast('Entry not found for deletion');
        }
        return;
    }

    // Update score and stats if it was a goal
    if (entry.type === 'goal') {
        if (entry.team === 'yellow') {
            gameState.yellowScore = Math.max(0, gameState.yellowScore - 1);
            document.getElementById('yellow-score').textContent = gameState.yellowScore;
            document.getElementById('yellow-score').classList.add('score-animation');
            setTimeout(function() {
                document.getElementById('yellow-score').classList.remove('score-animation');
            }, 500);
        } else {
            gameState.blueScore = Math.max(0, gameState.blueScore - 1);
            document.getElementById('blue-score').textContent = gameState.blueScore;
            document.getElementById('blue-score').classList.add('score-animation');
            setTimeout(function() {
                document.getElementById('blue-score').classList.remove('score-animation');
            }, 500);
        }

        // Update player stats
        if (entry.player !== 'OWN GOAL') {
            var playerKey = entry.team + '-' + entry.player;
            if (gameState.playerStats[playerKey]) {
                gameState.playerStats[playerKey].goals = Math.max(0, gameState.playerStats[playerKey].goals - 1);
            }
        }

        if (entry.assist) {
            var assistKey = entry.team + '-' + entry.assist;
            if (gameState.playerStats[assistKey]) {
                gameState.playerStats[assistKey].assists = Math.max(0, gameState.playerStats[assistKey].assists - 1);
            }
        }

        // Update announcer state for regular goal
        gameState.totalGoalsScored = Math.max(0, gameState.totalGoalsScored - 1);

    } else if (entry.type === 'own-goal') {
        if (entry.scoringTeam === 'yellow') {
            gameState.yellowScore = Math.max(0, gameState.yellowScore - 1);
            document.getElementById('yellow-score').textContent = gameState.yellowScore;
            document.getElementById('yellow-score').classList.add('score-animation');
            setTimeout(function() {
                document.getElementById('yellow-score').classList.remove('score-animation');
            }, 500);
        } else {
            gameState.blueScore = Math.max(0, gameState.blueScore - 1);
            document.getElementById('blue-score').textContent = gameState.blueScore;
            document.getElementById('blue-score').classList.add('score-animation');
            setTimeout(function() {
                document.getElementById('blue-score').classList.remove('score-animation');
            }, 500);
        }

        // Update announcer state for own goal
        gameState.totalGoalsScored = Math.max(0, gameState.totalGoalsScored - 1);
    }

    // Recalculate lead flags after score changes
    var scoreDiff = Math.abs(gameState.yellowScore - gameState.blueScore);
    if (scoreDiff < 3) {
        gameState.hasThreeGoalLead = false;
    }
    if (scoreDiff < 5) {
        gameState.hasFiveGoalLead = false;
    }

    // Remove the entry from the log array
    gameState.actionLog.splice(index, 1);

    // Remove the corresponding DOM element
    var logEntry = document.querySelector('[data-log-index="' + index + '"]');
    if (logEntry) {
        logEntry.remove();
    }

    // Update all remaining log entry indices
    updateLogEntryIndices();

    // Save game state after deletion
    saveGameState();

    debugLog('Entry deleted: ' + entry.text);
    
    if (window.AndroidInterface) {
        // window.AndroidInterface.showToast('Entry deleted successfully');
    }
}

// Make sure functions are globally accessible
window.deleteLogEntry = deleteLogEntry;
window.editLogEntry = editLogEntry;
window.cancelDeleteEntry = cancelDeleteEntry;
window.confirmDeleteEntry = confirmDeleteEntry;

// Test function to check if delete is working
function testDelete() {
    // if (window.AndroidInterface) {
    //     window.AndroidInterface.showToast('Test function called!');
    //     if (typeof deleteLogEntry === 'function') {
    //         window.AndroidInterface.showToast('deleteLogEntry function exists');
    //         if (gameState.actionLog.length > 0) {
    //             window.AndroidInterface.showToast('Found ' + gameState.actionLog.length + ' log entries. Testing delete on index 0.');
    //             deleteLogEntry(0);
    //         } else {
    //             window.AndroidInterface.showToast('No log entries to delete');
    //         }
    //     } else {
    //         window.AndroidInterface.showToast('deleteLogEntry function NOT found');
    //     }
    // }
}
window.testDelete = testDelete;

    function toggleGame() {
        var btn = document.getElementById('game-control-btn');

        if (!gameState.isGameStarted) {
            // Check if both teams have at least 5 players
            var yellowPlayerCount = 0;
            var bluePlayerCount = 0;
            
            for (var i = 1; i <= gameState.yellowPlayerCount; i++) {
                var button = document.getElementById('yellow-player-' + i);
                if (button) {
                    var buttonText = button.textContent.trim();
                    var isOptional = i > 5;
                    var placeholderText = isOptional ? '#' + i + ' (Optional)' : '#' + i;
                    
                    // If it's not a placeholder, it's assigned
                    if (buttonText !== placeholderText) {
                        yellowPlayerCount++;
                    }
                }
            }
            
            for (var i = 1; i <= gameState.bluePlayerCount; i++) {
                var button = document.getElementById('blue-player-' + i);
                if (button) {
                    var buttonText = button.textContent.trim();
                    var isOptional = i > 5;
                    var placeholderText = isOptional ? '#' + i + ' (Optional)' : '#' + i;
                    
                    // If it's not a placeholder, it's assigned
                    if (buttonText !== placeholderText) {
                        bluePlayerCount++;
                    }
                }
            }
            
            if (yellowPlayerCount < 5 || bluePlayerCount < 5) {
                var message = 'Please complete the setup first! Go to Setup tab to configure teams.';
                alert(message);
                if (window.AndroidInterface) {
                    window.AndroidInterface.showToast(message);
                }
                return;
            }

            // Setup game state with player data (integrated from startGame function)
            gameState.yellowPlayers = [];
            gameState.bluePlayers = [];
            gameState.yellowPlayerSlots = {};
            gameState.bluePlayerSlots = {};
            gameState.totalGoalsScored = 0;
            gameState.hasThreeGoalLead = false;
            gameState.hasFiveGoalLead = false;
            
            // Get team names
            gameState.yellowTeamName = document.getElementById('yellow-team-name').value.trim() || 'Yellow Team';
            gameState.blueTeamName = document.getElementById('blue-team-name').value.trim() || 'Blue Team';

            // Collect all yellow players with their slot numbers
            for (var i = 1; i <= gameState.yellowPlayerCount; i++) {
                var button = document.getElementById('yellow-player-' + i);
                if (button) {
                    var buttonText = button.textContent.trim();
                    var isOptional = i > 5;
                    var placeholderText = isOptional ? '#' + i + ' (Optional)' : '#' + i;
                    
                    if (buttonText !== placeholderText) {
                        gameState.yellowPlayers.push(buttonText);
                        gameState.yellowPlayerSlots[buttonText] = i;
                    }
                }
            }

            // Collect all blue players with their slot numbers
            for (var i = 1; i <= gameState.bluePlayerCount; i++) {
                var button = document.getElementById('blue-player-' + i);
                if (button) {
                    var buttonText = button.textContent.trim();
                    var isOptional = i > 5;
                    var placeholderText = isOptional ? '#' + i + ' (Optional)' : '#' + i;
                    
                    if (buttonText !== placeholderText) {
                        gameState.bluePlayers.push(buttonText);
                        gameState.bluePlayerSlots[buttonText] = i;
                    }
                }
            }

            // Add OWN GOAL as a selectable option
            gameState.yellowPlayers.push('OWN GOAL');
            gameState.bluePlayers.push('OWN GOAL');

            // Only reset scores and logs if this is a fresh game (no existing scores)
            if (gameState.yellowScore === undefined || gameState.blueScore === undefined) {
                gameState.yellowScore = 0;
                gameState.blueScore = 0;
                gameState.actionLog = [];
                document.getElementById('yellow-score').textContent = '0';
                document.getElementById('blue-score').textContent = '0';
                document.getElementById('log-entries').innerHTML = '';
            }
            
            gameState.currentGoal = null;
            initializePlayerStats();

            // Update team headers and generate player buttons in game mode
            try {
                updateTeamHeaders();
                generatePlayerButtons();
                updateCustomSoundButtons();
            } catch (error) {
                debugLog('Error in game setup functions: ' + error.message);
                // Continue with game start even if these fail
            }

            gameState.isGameStarted = true;
            gameState.hasGameBeenStarted = true;
            btn.textContent = ' STOP GAME';
            btn.className = 'control-btn stop';
            saveGameState(); // Save state immediately after starting game
            
            // Show score header and hide main title
            try {
                document.getElementById('main-title').style.display = 'none';
                document.getElementById('score-header').style.display = 'flex';
                
                // Update Edit Names button visibility
                updateEditNamesButtonVisibility();
                
                // Update team names in header
                document.getElementById('yellow-team-name-header').textContent = gameState.yellowTeamName;
                document.getElementById('blue-team-name-header').textContent = gameState.blueTeamName;
                
                // Update custom sound buttons state
                generateGameModeCustomSounds();
            } catch (error) {
                debugLog('Error in UI updates: ' + error.message);
                // Continue with game start even if UI updates fail
            }

            // Add game start log entry
            var startEntry = {
                type: 'system',
                text: ' Game Started',
                timestamp: new Date()
            };
            var logIndex = gameState.actionLog.length;
            gameState.actionLog.push(startEntry);

            var logContainer = document.getElementById('log-entries');
            var logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.setAttribute('data-log-index', logIndex);
            logEntry.innerHTML = '<span class="log-entry-text">' + startEntry.text + '</span>';
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Show game containers and action controls
            try {
                var teamsContainer = document.getElementById('teams-container');
                teamsContainer.style.display = 'flex';
                // Apply responsive grid on larger screens
                if (window.innerWidth >= 768) {
                    teamsContainer.style.display = 'grid';
                }
                document.getElementById('game-action-controls').style.display = 'flex';
                document.getElementById('custom-sounds-section').style.display = 'block';
                document.getElementById('action-log').style.display = 'block';
            } catch (e) {
                debugLog('Error showing game containers: ' + e.message);
            }

            // Play start of game announcer sound
            playAnnouncerSound('announcer-game-start', function() {
                debugLog('Game start announcer completed');
            });

        } else {
            gameState.isGameStarted = false;
            btn.textContent = ' START GAME';
            btn.className = 'control-btn start';
            saveGameState(); // Save state after stopping game
            
            // Hide score header and show main title
            document.getElementById('main-title').style.display = 'flex';
            document.getElementById('score-header').style.display = 'none';
            
            
            // Update Edit Names button visibility
            updateEditNamesButtonVisibility();
            
            // Update custom sound buttons state
            generateGameModeCustomSounds();

            var stopEntry = {
                type: 'system',
                text: ' Game Stopped',
                timestamp: new Date()
            };
            var logIndex = gameState.actionLog.length;
            gameState.actionLog.push(stopEntry);

            var logContainer = document.getElementById('log-entries');
            var logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.setAttribute('data-log-index', logIndex);
            logEntry.innerHTML = '<span class="log-entry-text">' + stopEntry.text + '</span>';
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Play end of match announcer sound
            playAnnouncerSound('announcer-game-end', function() {
                debugLog('Game end announcer completed');
            });

        }
    }

    function confirmOwnGoal() {
        if (!gameState.currentGoal) return;

        var goal = gameState.currentGoal;

        // Own goal scores for the SAME team (the team whose button was clicked)
        var scoringTeam = goal.team; // Changed from opposite team to same team

        if (scoringTeam === 'yellow') {
            gameState.yellowScore++;
            document.getElementById('yellow-score').textContent = gameState.yellowScore;
            document.getElementById('yellow-score').classList.add('score-animation');
            saveGameState(); // Save state after goal
            setTimeout(function() {
                document.getElementById('yellow-score').classList.remove('score-animation');
            }, 500);
        } else {
            gameState.blueScore++;
            document.getElementById('blue-score').textContent = gameState.blueScore;
            document.getElementById('blue-score').classList.add('score-animation');
            saveGameState(); // Save state after goal
            setTimeout(function() {
                document.getElementById('blue-score').classList.remove('score-animation');
            }, 500);
        }

        var logText = 'Own Goal by ' + (goal.team === 'yellow' ? gameState.yellowTeamName : gameState.blueTeamName) + ' (Goal for ' + (scoringTeam === 'yellow' ? gameState.yellowTeamName : gameState.blueTeamName) + ')';

        var logIndex = gameState.actionLog.length;
        gameState.actionLog.push({
            type: 'own-goal',
            team: goal.team,
            scoringTeam: scoringTeam,
            player: 'OWN GOAL',
            timestamp: goal.timestamp,
            text: logText
        });

        var logContainer = document.getElementById('log-entries');
        var logEntry = document.createElement('div');
        logEntry.className = 'log-entry ' + scoringTeam;
        logEntry.setAttribute('data-log-index', logIndex);
        logEntry.innerHTML = '<span class="log-entry-text">' + logText + '</span>' +
            '<div class="log-entry-actions">' +
            '<button class="log-action-btn delete" onclick="if(window.AndroidInterface) window.AndroidInterface.showToast(\'Own goal delete clicked for index ' + logIndex + '!\'); deleteLogEntry(' + logIndex + ')"></button>' +
            '</div>';
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
        // Check for announcer events BEFORE updating score
        var isFirstGoal = gameState.totalGoalsScored === 0;

        // Increment total goals
        gameState.totalGoalsScored++;

        // After hiding the modal and before debugLog, add:

        // Determine which announcer sounds to play
        var announcerSounds = [];

        // First goal of the game
        if (isFirstGoal) {
            announcerSounds.push('announcer-first-goal');
        }

        // Check for tie game
        if (gameState.yellowScore === gameState.blueScore) {
            announcerSounds.push('announcer-tie-game');
        }

        // Check for 3 goal lead
        var scoreDiff = Math.abs(gameState.yellowScore - gameState.blueScore);
        if (scoreDiff === 3 && !gameState.hasThreeGoalLead) {
            gameState.hasThreeGoalLead = true;
            announcerSounds.push('announcer-three-lead');
        }

        // Check for 5 goal lead
        if (scoreDiff === 5 && !gameState.hasFiveGoalLead) {
            gameState.hasFiveGoalLead = true;
            announcerSounds.push('announcer-five-lead');
        }

        // Reset lead flags if lead is lost
        if (scoreDiff < 3) {
            gameState.hasThreeGoalLead = false;
        }
        if (scoreDiff < 5) {
            gameState.hasFiveGoalLead = false;
        }

        // Play announcer sounds in sequence, then goal sound
        playAnnouncerSoundsSequence(announcerSounds, function() {
            // After all announcer sounds, play the own goal sound
            playGoalSound(goal.team, 'OWN GOAL');
        });
        document.getElementById('own-goal-modal').style.display = 'none';
        gameState.currentGoal = null;

        debugLog('Own goal confirmed: ' + logText);
    }

   function confirmGoal() {
    if (!gameState.currentGoal) return;

    var goal = gameState.currentGoal;

    // Check for announcer events BEFORE updating score
    var previousYellowScore = gameState.yellowScore;
    var previousBlueScore = gameState.blueScore;
    var isFirstGoal = gameState.totalGoalsScored === 0;

    // Get player's current goals before update
    var playerKey = goal.team + '-' + goal.player;
    var playerGoalsBefore = 0;
    if (gameState.playerStats[playerKey]) {
        playerGoalsBefore = gameState.playerStats[playerKey].goals;
    }

    // Update score
    if (goal.team === 'yellow') {
        gameState.yellowScore++;
        document.getElementById('yellow-score').textContent = gameState.yellowScore;
        document.getElementById('yellow-score').classList.add('score-animation');
        saveGameState(); // Save state after goal
        setTimeout(function() {
            document.getElementById('yellow-score').classList.remove('score-animation');
        }, 500);
    } else {
        gameState.blueScore++;
        document.getElementById('blue-score').textContent = gameState.blueScore;
        saveGameState(); // Save state after goal
        document.getElementById('blue-score').classList.add('score-animation');
        setTimeout(function() {
            document.getElementById('blue-score').classList.remove('score-animation');
        }, 500);
    }

    gameState.totalGoalsScored++;
    updatePlayerStats(goal);

    var logText = 'Goal: ' + goal.player;
    if (goal.assist) {
        logText += ', Assist: ' + goal.assist;
    }
    logText += ' (' + (goal.team === 'yellow' ? gameState.yellowTeamName : gameState.blueTeamName) + ')';

    var logIndex = gameState.actionLog.length;
    gameState.actionLog.push({
        type: 'goal',
        team: goal.team,
        player: goal.player,
        assist: goal.assist || null,
        timestamp: goal.timestamp,
        text: logText
    });

    var logContainer = document.getElementById('log-entries');
    var logEntry = document.createElement('div');
    logEntry.className = 'log-entry ' + goal.team;
    logEntry.setAttribute('data-log-index', logIndex);
    logEntry.innerHTML = '<span class="log-entry-text">' + logText + '</span>' +
        '<div class="log-entry-actions">' +
        '<button class="log-action-btn edit" onclick="if(window.AndroidInterface) window.AndroidInterface.showToast(\'Edit clicked!\'); editLogEntry(' + logIndex + ')"></button>' +
        '<button class="log-action-btn delete" onclick="if(window.AndroidInterface) window.AndroidInterface.showToast(\'Delete clicked for index ' + logIndex + '!\'); deleteLogEntry(' + logIndex + ')"></button>' +
        '</div>';
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;

    document.getElementById('assist-modal').style.display = 'none';

    // Determine which announcer sounds to play
    var announcerSounds = [];

    // First goal of the game
    if (isFirstGoal) {
        announcerSounds.push('announcer-first-goal');
    }

    // Hat trick (3 goals)
    if (playerGoalsBefore === 2) {
        announcerSounds.push('announcer-hat-trick');
    }

    // 5 goals
    if (playerGoalsBefore === 4) {
        announcerSounds.push('announcer-five-goals');
    }

    // Check for tie game
    if (gameState.yellowScore === gameState.blueScore) {
        announcerSounds.push('announcer-tie-game');
    }

    // Check for 3 goal lead
    var scoreDiff = Math.abs(gameState.yellowScore - gameState.blueScore);
    if (scoreDiff === 3 && !gameState.hasThreeGoalLead) {
        gameState.hasThreeGoalLead = true;
        announcerSounds.push('announcer-three-lead');
    }

    // Check for 5 goal lead
    if (scoreDiff === 5 && !gameState.hasFiveGoalLead) {
        gameState.hasFiveGoalLead = true;
        announcerSounds.push('announcer-five-lead');
    }

    // Reset lead flags if lead is lost
    if (scoreDiff < 3) {
        gameState.hasThreeGoalLead = false;
    }
    if (scoreDiff < 5) {
        gameState.hasFiveGoalLead = false;
    }

    // Play announcer sounds in sequence, then goal sound
    playAnnouncerSoundsSequence(announcerSounds, function() {
        // After all announcer sounds, play the goal sound
        playGoalSound(goal.team, goal.player);
    });

    gameState.currentGoal = null;
    debugLog('Goal confirmed: ' + logText);
}

    // Function to display sound item without assignment dropdown
    function displaySoundItem(sound) {
        var soundList = document.getElementById('sound-list');

        // Remove "no sounds" message if it exists
        var noSoundsMsg = soundList.querySelector('div[style*="text-align: center"]');
        if (noSoundsMsg) {
            noSoundsMsg.remove();
        }

        var soundItem = document.createElement('div');
        soundItem.className = 'sound-item';
        soundItem.setAttribute('data-sound-id', sound.id);
        soundItem.style.cssText = 'background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%); padding: 20px; border-radius: 10px; border: 2px solid rgba(59, 130, 246, 0.3); margin-bottom: 15px; transition: all 0.3s ease;';

        var uploadDate = sound.uploadDate ?
            new Date(sound.uploadDate).toLocaleDateString() : 'Unknown';

        // Create the HTML structure
        soundItem.innerHTML = '<h5 style="margin-bottom: 15px; color: #e2e8f0; font-size: 16px; display: flex; align-items: center; justify-content: space-between;"> ' + sound.name + ' <span style="font-size: 11px; color: #94a3b8;">(' + (sound.size/1024).toFixed(1) + 'KB  ' + uploadDate + ')</span></h5><audio controls preload="metadata" style="width: 100%; margin-bottom: 15px;"><source src="' + sound.data + '" type="' + sound.type + '">Your browser does not support the audio element.</audio><div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;"><button id="remove-btn-' + sound.id + '" style="padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; background: #e74c3c; color: white;"> Remove</button></div>';

        soundList.appendChild(soundItem);

        // Add event listener to the remove button AFTER it's added to DOM
        var removeBtn = document.getElementById('remove-btn-' + sound.id);
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                debugLog('Remove button clicked for sound: ' + sound.name);
                removeSound(sound.id);
            });
        } else {
            debugLog('ERROR: Remove button not found for sound: ' + sound.name);
        }
    }

    // New function to generate rename inputs with sound assignment

    function addPlayerDropdownElement(team, playerNum) {
        var container = document.getElementById(team + '-players');
        var playerDiv = document.createElement('div');
        playerDiv.className = 'player-dropdown';
        playerDiv.setAttribute('data-player-num', playerNum);

        var isOptional = playerNum > 5;
        var placeholderText = isOptional ? '#' + playerNum + ' (Optional)' : '#' + playerNum;

        var selectHTML = '<option value="" disabled selected style="color: #999;">' + placeholderText + '</option>';
        
        // Get already assigned players to exclude them
        var assignedPlayers = getAllAssignedPlayers();
        
        // Add players from playerProfiles that are not already assigned
        if (typeof playerProfiles !== 'undefined' && playerProfiles.length > 0) {
            for (var i = 0; i < playerProfiles.length; i++) {
                var player = playerProfiles[i];
                // Only add if not already assigned
                if (assignedPlayers.indexOf(player.name) === -1) {
                    selectHTML += '<option value="' + player.name + '">' + player.name + '</option>';
                }
            }
        }

        // Create a button instead of a select dropdown
        var playerName = '';
        var playerId = team + '-player-' + playerNum;
        
        // Check if there's already an assigned player
        if (typeof playerProfiles !== 'undefined' && playerProfiles.length > 0) {
            // This will be populated when player is assigned
        }
        
        playerDiv.innerHTML =
            '<button id="' + playerId + '" class="player-assignment-btn" onclick="openPlayerAssignmentModal(\'' + team + '\', ' + playerNum + ')" style="width: 100%; padding: 12px; border: 2px dashed #666; background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%); border-radius: 8px; cursor: pointer; text-align: center; color: #ccc;">' +
                placeholderText +
            '</button>' +
            (playerNum > 7 ? '<button class="remove-player-btn" onclick="removePlayerSlot(\'' + team + '\', ' + playerNum + ')" title="Remove player"></button>' : '');

        container.appendChild(playerDiv);
    }

    function addPlayerDropdown(team) {
        var currentCount = team === 'yellow' ? gameState.yellowPlayerCount : gameState.bluePlayerCount;

        if (currentCount >= 11) {
            var message = 'Maximum 11 players per team allowed!';
            alert(message);
            if (window.AndroidInterface) {
                // window.AndroidInterface.showToast(message);
            }
            return;
        }


        var newPlayerNum = currentCount + 1;
        addPlayerDropdownElement(team, newPlayerNum);

        if (team === 'yellow') {
            gameState.yellowPlayerCount = newPlayerNum;
            if (newPlayerNum >= 11) {
                document.getElementById('add-yellow-player').style.display = 'none';
            }
        } else {
            gameState.bluePlayerCount = newPlayerNum;
            if (newPlayerNum >= 11) {
                document.getElementById('add-blue-player').style.display = 'none';
            }
        }

        debugLog('Added player dropdown ' + newPlayerNum + ' for ' + team + ' team');
    }

    function getAllAssignedPlayers() {
        var assignedPlayers = [];
        
        // Check yellow team assignments
        for (var i = 1; i <= gameState.yellowPlayerCount; i++) {
            var button = document.getElementById('yellow-player-' + i);
            if (button) {
                var buttonText = button.textContent.trim();
                var isOptional = i > 5;
                var placeholderText = isOptional ? '#' + i + ' (Optional)' : '#' + i;
                
                // If it's not a placeholder, it's assigned
                if (buttonText !== placeholderText) {
                    assignedPlayers.push(buttonText);
                }
            }
        }
        
        // Check blue team assignments
        for (var i = 1; i <= gameState.bluePlayerCount; i++) {
            var button = document.getElementById('blue-player-' + i);
            if (button) {
                var buttonText = button.textContent.trim();
                var isOptional = i > 5;
                var placeholderText = isOptional ? '#' + i + ' (Optional)' : '#' + i;
                
                // If it's not a placeholder, it's assigned
                if (buttonText !== placeholderText) {
                    assignedPlayers.push(buttonText);
                }
            }
        }
        
        return assignedPlayers;
    }

    function getAllPlayerAssignments() {
        var assignments = [];
        
        // Check yellow team assignments
        for (var i = 1; i <= gameState.yellowPlayerCount; i++) {
            var button = document.getElementById('yellow-player-' + i);
            if (button) {
                var buttonText = button.textContent.trim();
                var isOptional = i > 5;
                var placeholderText = isOptional ? '#' + i + ' (Optional)' : '#' + i;
                
                // If it's not a placeholder, it's assigned
                if (buttonText !== placeholderText) {
                    assignments.push({
                        name: buttonText,
                        team: 'yellow',
                        slot: i
                    });
                }
            }
        }
        
        // Check blue team assignments
        for (var i = 1; i <= gameState.bluePlayerCount; i++) {
            var button = document.getElementById('blue-player-' + i);
            if (button) {
                var buttonText = button.textContent.trim();
                var isOptional = i > 5;
                var placeholderText = isOptional ? '#' + i + ' (Optional)' : '#' + i;
                
                // If it's not a placeholder, it's assigned
                if (buttonText !== placeholderText) {
                    assignments.push({
                        name: buttonText,
                        team: 'blue',
                        slot: i
                    });
                }
            }
        }
        
        return assignments;
    }

    function checkAvailablePlayers(team, playerNum) {
        // Check if there are any available players to assign
        var assignedPlayers = getAllAssignedPlayers();
        var availablePlayerCount = 0;
        
        if (typeof playerProfiles !== 'undefined' && playerProfiles.length > 0) {
            for (var i = 0; i < playerProfiles.length; i++) {
                var player = playerProfiles[i];
                if (assignedPlayers.indexOf(player.name) === -1) {
                    availablePlayerCount++;
                }
            }
        }
        
        if (availablePlayerCount === 0) {
            var message = 'No players available to assign! Please add players in the Players tab first.';
            alert(message);
            if (window.AndroidInterface) {
                window.AndroidInterface.showToast(message);
            }
            // Blur the select to close it
            var selectElement = document.getElementById(team + '-player-' + playerNum);
            if (selectElement) {
                selectElement.blur();
            }
            return false;
        }
        return true;
    }

    function updateSelectedPlayer(team, playerNum) {
        var selectElement = document.getElementById(team + '-player-' + playerNum);
        var selectedPlayer = selectElement.value;
        
        if (selectedPlayer) {
            // Check if this player is already assigned to another slot
            var currentSlotId = team + '-player-' + playerNum;
            var assignedPlayers = [];
            
            // Check all other slots for duplicates
            for (var i = 1; i <= gameState.yellowPlayerCount; i++) {
                var yellowSelect = document.getElementById('yellow-player-' + i);
                if (yellowSelect && yellowSelect.id !== currentSlotId && yellowSelect.value === selectedPlayer) {
                    assignedPlayers.push('Yellow Team Player ' + i);
                }
            }
            
            for (var i = 1; i <= gameState.bluePlayerCount; i++) {
                var blueSelect = document.getElementById('blue-player-' + i);
                if (blueSelect && blueSelect.id !== currentSlotId && blueSelect.value === selectedPlayer) {
                    assignedPlayers.push('Blue Team Player ' + i);
                }
            }
            
            if (assignedPlayers.length > 0) {
                // Player is already assigned, clear this selection and show warning
                selectElement.value = '';
                return;
            }
        }
        
        debugLog('Selected player: ' + selectedPlayer + ' for ' + team + ' team slot ' + playerNum);
        
        // Refresh all dropdowns to update available options
        refreshPlayerDropdowns();
    }

    // Global variables for player assignment modal
    var currentAssignmentTeam = '';
    var currentAssignmentSlot = 0;

    function openPlayerAssignmentModal(team, playerNum) {
        // Check if trying to assign to slot 6+ when slots 1-5 are empty
        if (playerNum >= 6) {
            var hasEmptyEssentialSlots = false;
            for (var i = 1; i <= 5; i++) {
                var button = document.getElementById(team + '-player-' + i);
                if (button) {
                    var buttonText = button.textContent.trim();
                    var placeholderText = '#' + i;
                    if (buttonText === placeholderText) {
                        hasEmptyEssentialSlots = true;
                        break;
                    }
                }
            }
            
            if (hasEmptyEssentialSlots) {
                var teamDisplayName = team === 'yellow' ? 'Yellow Team' : 'Blue Team';
                var message = ' Please fill slots #1-5 first before assigning to optional slots in ' + teamDisplayName + '!';
                if (window.AndroidInterface) {
                    window.AndroidInterface.showToast(message);
                } else {
                    alert(message);
                }
                return;
            }
        }
        
        currentAssignmentTeam = team;
        currentAssignmentSlot = playerNum;
        
        var teamDisplayName = team === 'yellow' ? 'Yellow Team' : 'Blue Team';
        var slotInfo = teamDisplayName + ' #' + playerNum;
        document.getElementById('assignment-slot-info').textContent = slotInfo;
        
        populatePlayerAssignmentList();
        document.getElementById('player-assignment-modal').style.display = 'block';
    }

    function populatePlayerAssignmentList() {
        var playerList = document.getElementById('player-assignment-list');
        playerList.innerHTML = '';
        
        // Add "Unassigned" option at the top
        var unassignOption = document.createElement('div');
        unassignOption.className = 'player-option unassign';
        unassignOption.textContent = ' Unassigned';
        unassignOption.onclick = function() { assignPlayerToSlot(''); };
        playerList.appendChild(unassignOption);
        
        // Get all player assignments with their teams and slots
        var playerAssignments = getAllPlayerAssignments();
        var currentPlayerId = currentAssignmentTeam + '-player-' + currentAssignmentSlot;
        var currentPlayerBtn = document.getElementById(currentPlayerId);
        var currentPlayerName = currentPlayerBtn ? currentPlayerBtn.textContent.trim() : '';
        
        // Remove current player from their current slot if they're being reassigned
        if (currentPlayerName && currentPlayerName !== '#' + currentAssignmentSlot && currentPlayerName !== '#' + currentAssignmentSlot + ' (Optional)') {
            // Find and remove current player from assignments
            for (var i = 0; i < playerAssignments.length; i++) {
                if (playerAssignments[i].name === currentPlayerName) {
                    playerAssignments.splice(i, 1);
                    break;
                }
            }
        }
        
        var availablePlayers = [];
        var assignedPlayers = [];
        
        // Categorize players
        if (typeof playerProfiles !== 'undefined' && playerProfiles.length > 0) {
            for (var i = 0; i < playerProfiles.length; i++) {
                var player = playerProfiles[i];
                var assignment = playerAssignments.find(function(a) { return a.name === player.name; });
                
                if (assignment) {
                    assignedPlayers.push({
                        name: player.name,
                        team: assignment.team,
                        slot: assignment.slot
                    });
                } else {
                    availablePlayers.push(player.name);
                }
            }
        }
        
        // Add available players first
        for (var i = 0; i < availablePlayers.length; i++) {
            var playerOption = document.createElement('div');
            playerOption.className = 'player-option';
            playerOption.textContent = ' ' + availablePlayers[i];
            playerOption.onclick = function(playerName) {
                return function() { assignPlayerToSlot(playerName); };
            }(availablePlayers[i]);
            playerList.appendChild(playerOption);
        }
        
        // Add separator if there are both available and assigned players
        if (availablePlayers.length > 0 && assignedPlayers.length > 0) {
            var separator = document.createElement('div');
            separator.style.padding = '8px 0';
            separator.style.textAlign = 'center';
            separator.style.color = '#666';
            separator.style.fontSize = '12px';
            separator.textContent = ' Already Assigned ';
            playerList.appendChild(separator);
        }
        
        // Add assigned players at the bottom with team styling
        for (var i = 0; i < assignedPlayers.length; i++) {
            var assignedPlayer = assignedPlayers[i];
            var playerOption = document.createElement('div');
            playerOption.className = 'player-option assigned-' + assignedPlayer.team;
            
            var teamEmoji = assignedPlayer.team === 'yellow' ? '' : '';
            playerOption.textContent = teamEmoji + ' ' + assignedPlayer.name + ' (#' + assignedPlayer.slot + ')';
            
            playerOption.onclick = function(playerName, fromTeam, fromSlot) {
                return function() { reassignPlayer(playerName, fromTeam, fromSlot); };
            }(assignedPlayer.name, assignedPlayer.team, assignedPlayer.slot);
            
            playerList.appendChild(playerOption);
        }
        
        // If no players available at all
        if (availablePlayers.length === 0 && assignedPlayers.length === 0) {
            var noPlayersMsg = document.createElement('div');
            noPlayersMsg.style.padding = '20px';
            noPlayersMsg.style.textAlign = 'center';
            noPlayersMsg.style.color = '#666';
            noPlayersMsg.textContent = 'No players available. Add players in the Players tab.';
            playerList.appendChild(noPlayersMsg);
        }
    }

    function assignPlayerToSlot(playerName) {
        var playerId = currentAssignmentTeam + '-player-' + currentAssignmentSlot;
        var playerBtn = document.getElementById(playerId);
        
        if (playerBtn) {
            if (playerName) {
                // Assign player
                playerBtn.textContent = playerName;
                playerBtn.style.border = '2px solid #27ae60';
                playerBtn.style.background = '#d5f4e6';
                playerBtn.style.color = '#27ae60';
                playerBtn.style.fontWeight = 'bold';
            } else {
                // Unassign player
                var isOptional = currentAssignmentSlot > 5;
                var placeholderText = isOptional ? '#' + currentAssignmentSlot + ' (Optional)' : '#' + currentAssignmentSlot;
                playerBtn.textContent = placeholderText;
                playerBtn.style.border = '2px dashed #666';
                playerBtn.style.background = 'linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%)';
                playerBtn.style.color = '#ccc';
                playerBtn.style.fontWeight = 'normal';
            }
        }
        
        closePlayerAssignmentModal();
        debugLog('=== ASSIGNMENT DEBUG: Player ' + (playerName || 'unassigned') + ' assigned to ' + currentAssignmentTeam + ' team slot ' + currentAssignmentSlot);
        
        // Show toast for debugging
        // if (window.AndroidInterface) {
        //     window.AndroidInterface.showToast(' Assigned: ' + (playerName || 'unassigned') + ' to ' + currentAssignmentTeam + ' #' + currentAssignmentSlot);
        // }
        
        // Save player assignments after any assignment change
        debugLog('=== SAVE DEBUG: Triggering savePlayerAssignments after assignment change');
        savePlayerAssignments();
    }

    function reassignPlayer(playerName, fromTeam, fromSlot) {
        // Clear the player from their current slot first
        var fromPlayerId = fromTeam + '-player-' + fromSlot;
        var fromPlayerBtn = document.getElementById(fromPlayerId);
        
        if (fromPlayerBtn) {
            var isOptional = fromSlot > 5;
            var placeholderText = isOptional ? '#' + fromSlot + ' (Optional)' : '#' + fromSlot;
            fromPlayerBtn.textContent = placeholderText;
            fromPlayerBtn.style.border = '2px dashed #666';
            fromPlayerBtn.style.background = 'rgba(255, 255, 255, 0.1)';
            fromPlayerBtn.style.color = '#ccc';
            fromPlayerBtn.style.fontWeight = 'normal';
        }
        
        // Now assign to the new slot
        assignPlayerToSlot(playerName);
        
        debugLog('Player ' + playerName + ' moved from ' + fromTeam + ' #' + fromSlot + ' to ' + currentAssignmentTeam + ' #' + currentAssignmentSlot);
    }

    function closePlayerAssignmentModal() {
        document.getElementById('player-assignment-modal').style.display = 'none';
        currentAssignmentTeam = '';
        currentAssignmentSlot = 0;
    }

    // Player Assignment Persistence Functions
    function savePlayerAssignments() {
        try {
            debugLog('=== SAVE DEBUG: savePlayerAssignments() called');
            
            // Store player assignments in gameState.playerAssignments (like soundAssignments)
            var assignments = getAllPlayerAssignments();
            debugLog('=== SAVE DEBUG: Found ' + assignments.length + ' assignments from getAllPlayerAssignments()');
            
            gameState.playerAssignments = {};
            
            // Convert assignments array to a key-value object for persistence
            assignments.forEach(function(assignment) {
                var key = assignment.team + '-player-' + assignment.slot;
                gameState.playerAssignments[key] = assignment.name;
                debugLog('=== SAVE DEBUG: Storing ' + key + ' = ' + assignment.name);
            });
            
            debugLog('=== SAVE DEBUG: gameState.playerAssignments now contains: ' + JSON.stringify(gameState.playerAssignments));
            
            // Show toast for debugging
            // if (window.AndroidInterface) {
            //     window.AndroidInterface.showToast(' Saving ' + assignments.length + ' player assignments');
            // }
            
            // Trigger auto-save which will include player assignments (same as sound assignments)
            if (typeof autoSaveSounds === 'function') {
                debugLog('=== SAVE DEBUG: Calling autoSaveSounds() (same as sound assignments)');
                autoSaveSounds();
            } else {
                debugLog('=== SAVE DEBUG: ERROR - autoSaveSounds function not found!');
                // if (window.AndroidInterface) {
                //     window.AndroidInterface.showToast(' ERROR: autoSaveSounds not found');
                // }
            }
        } catch (error) {
            debugLog('=== SAVE DEBUG: ERROR in savePlayerAssignments: ' + error.message);
            // if (window.AndroidInterface) {
            //     window.AndroidInterface.showToast(' Save error: ' + error.message);
            // }
        }
    }

    function loadPlayerAssignments() {
        // Player assignments are now loaded automatically with sounds
        // This function is kept for compatibility but the real loading happens in loadSoundsFromAndroid
        debugLog('Player assignments will be loaded with sounds');
    }

    function restorePlayerAssignmentsFromGameState() {
        try {
            debugLog('=== RESTORE FUNCTION DEBUG: restorePlayerAssignmentsFromGameState() called');
            debugLog('=== RESTORE FUNCTION DEBUG: gameState.playerAssignments = ' + JSON.stringify(gameState.playerAssignments));
            
            if (gameState.playerAssignments) {
                // Clear all existing assignments first
                debugLog('=== RESTORE FUNCTION DEBUG: Clearing all existing assignments');
                clearAllPlayerAssignments();
                
                var restoredCount = 0;
                
                // Restore each assignment from the gameState
                Object.keys(gameState.playerAssignments).forEach(function(key) {
                    var playerName = gameState.playerAssignments[key];
                    var playerBtn = document.getElementById(key);
                    
                    debugLog('=== RESTORE FUNCTION DEBUG: Attempting to restore: ' + playerName + ' to ' + key);
                    
                    if (playerBtn && playerName) {
                        playerBtn.textContent = playerName;
                        playerBtn.style.border = '2px solid #27ae60';
                        playerBtn.style.background = '#d5f4e6';
                        playerBtn.style.color = '#27ae60';
                        playerBtn.style.fontWeight = 'bold';
                        restoredCount++;
                        debugLog('=== RESTORE FUNCTION DEBUG:  Successfully restored player button: ' + key + ' = ' + playerName);
                    } else {
                        debugLog('=== RESTORE FUNCTION DEBUG:  Could not find player button or name: ' + key + ' = ' + playerName + ' (btn exists: ' + !!playerBtn + ')');
                    }
                });
                
                debugLog('=== RESTORE FUNCTION DEBUG: Completed restoring ' + restoredCount + '/' + Object.keys(gameState.playerAssignments).length + ' player assignments');
                
                // Show toast for debugging
                // if (window.AndroidInterface) {
                //     window.AndroidInterface.showToast(' Restored ' + restoredCount + ' assignments to UI');
                // }
            } else {
                debugLog('=== RESTORE FUNCTION DEBUG: No gameState.playerAssignments found');
            }
        } catch (error) {
            debugLog('=== RESTORE FUNCTION DEBUG: ERROR - ' + error.message);
            // if (window.AndroidInterface) {
            //     window.AndroidInterface.showToast(' Restore error: ' + error.message);
            // }
        }
    }


    function clearAllPlayerAssignments() {
        // Clear yellow team assignments
        for (var i = 1; i <= gameState.yellowPlayerCount; i++) {
            var button = document.getElementById('yellow-player-' + i);
            if (button) {
                var isOptional = i > 5;
                var placeholderText = isOptional ? '#' + i + ' (Optional)' : '#' + i;
                button.textContent = placeholderText;
                button.style.border = '2px dashed #666';
                button.style.background = 'linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%)';
                button.style.color = '#ccc';
                button.style.fontWeight = 'normal';
            }
        }
        
        // Clear blue team assignments
        for (var i = 1; i <= gameState.bluePlayerCount; i++) {
            var button = document.getElementById('blue-player-' + i);
            if (button) {
                var isOptional = i > 5;
                var placeholderText = isOptional ? '#' + i + ' (Optional)' : '#' + i;
                button.textContent = placeholderText;
                button.style.border = '2px dashed #666';
                button.style.background = 'linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%)';
                button.style.color = '#ccc';
                button.style.fontWeight = 'normal';
            }
        }
    }

    function clearAllPlayerAssignmentsWithConfirmation() {
        try {
            // Count current assignments to show in confirmation
            var assignments = getAllPlayerAssignments();
            var assignmentCount = assignments.length;
            
            debugLog('Clear all assignments button clicked - found ' + assignmentCount + ' assignments');
            
            if (assignmentCount === 0) {
                if (window.AndroidInterface) {
                    window.AndroidInterface.showToast(' No player assignments to clear');
                } else {
                    alert(' No player assignments to clear');
                }
                return;
            }
            
            // Set the assignment count in the modal text
            document.getElementById('clear-assignments-text').textContent = 
                'This will remove all ' + assignmentCount + ' player assignments from both teams.';
            
            // Show the custom confirmation modal
            document.getElementById('clear-assignments-modal').style.display = 'block';
            
        } catch (error) {
            debugLog('Error showing clear assignments modal: ' + error.message);
            // if (window.AndroidInterface) {
            //     window.AndroidInterface.showToast(' Error showing confirmation: ' + error.message);
            // } else {
            //     alert(' Error showing confirmation: ' + error.message);
            // }
        }
    }

    function confirmClearAssignments() {
        try {
            debugLog('User confirmed clearing all player assignments');
            
            // Close the modal
            document.getElementById('clear-assignments-modal').style.display = 'none';
            
            // Count assignments for toast message
            var assignments = getAllPlayerAssignments();
            var assignmentCount = assignments.length;
            
            // Clear all assignments from UI
            clearAllPlayerAssignments();
            
            // Clear from gameState
            gameState.playerAssignments = {};
            
            // Save the changes
            if (typeof autoSaveSounds === 'function') {
                autoSaveSounds();
            }
            
            debugLog('All player assignments cleared and saved');
            
            if (window.AndroidInterface) {
                window.AndroidInterface.showToast(' Cleared all ' + assignmentCount + ' player assignments');
            } else {
                alert(' All player assignments cleared!');
            }
        } catch (error) {
            debugLog('Error clearing all player assignments: ' + error.message);
            // if (window.AndroidInterface) {
            //     window.AndroidInterface.showToast(' Error clearing assignments: ' + error.message);
            // } else {
            //     alert(' Error clearing assignments: ' + error.message);
            // }
        }
    }

    function cancelClearAssignments() {
        debugLog('User cancelled clearing player assignments');
        
        // Close the modal
        document.getElementById('clear-assignments-modal').style.display = 'none';
        
        if (window.AndroidInterface) {
            window.AndroidInterface.showToast(' Clear cancelled');
        }
    }

    function refreshPlayerDropdowns() {
        debugLog('Refreshing player dropdowns with updated player list');
        
        // This function is kept for compatibility but now just updates button states
        for (var i = 1; i <= gameState.yellowPlayerCount; i++) {
            updatePlayerButtonState('yellow', i);
        }
        
        for (var i = 1; i <= gameState.bluePlayerCount; i++) {
            updatePlayerButtonState('blue', i);
        }
    }

    function updatePlayerButtonState(team, playerNum) {
        var playerId = team + '-player-' + playerNum;
        var playerBtn = document.getElementById(playerId);
        if (!playerBtn) return;
        
        var currentText = playerBtn.textContent.trim();
        var isOptional = playerNum > 5;
        var placeholderText = isOptional ? '#' + playerNum + ' (Optional)' : '#' + playerNum;
        
        // If it's not a placeholder, it's assigned
        if (currentText !== placeholderText) {
            // Keep assigned styling
            playerBtn.style.border = '2px solid #27ae60';
            playerBtn.style.background = '#d5f4e6';
            playerBtn.style.color = '#27ae60';
            playerBtn.style.fontWeight = 'bold';
        }
    }

    function refreshSingleDropdown(team, playerNum) {
        var selectElement = document.getElementById(team + '-player-' + playerNum);
        if (!selectElement) return;
        
        var currentValue = selectElement.value;
        var currentSlotId = team + '-player-' + playerNum;
        
        // Get all assigned players except the current slot
        var assignedPlayers = [];
        for (var i = 1; i <= gameState.yellowPlayerCount; i++) {
            var yellowSelect = document.getElementById('yellow-player-' + i);
            if (yellowSelect && yellowSelect.id !== currentSlotId && yellowSelect.value) {
                assignedPlayers.push(yellowSelect.value);
            }
        }
        for (var i = 1; i <= gameState.bluePlayerCount; i++) {
            var blueSelect = document.getElementById('blue-player-' + i);
            if (blueSelect && blueSelect.id !== currentSlotId && blueSelect.value) {
                assignedPlayers.push(blueSelect.value);
            }
        }
        
        var isOptional = playerNum > 5;
        var placeholderText = isOptional ? '#' + playerNum + ' (Optional)' : '#' + playerNum;
        var selectHTML = '<option value="" disabled' + (currentValue ? '' : ' selected') + ' style="color: #999;">' + placeholderText + '</option>';
        
        // Add players from playerProfiles that are not already assigned
        if (typeof playerProfiles !== 'undefined' && playerProfiles.length > 0) {
            for (var i = 0; i < playerProfiles.length; i++) {
                var player = playerProfiles[i];
                
                // Skip if this player is already assigned to another slot
                if (assignedPlayers.indexOf(player.name) === -1) {
                    var selected = player.name === currentValue ? ' selected' : '';
                    selectHTML += '<option value="' + player.name + '"' + selected + '>' + player.name + '</option>';
                }
            }
        }
        
        selectElement.innerHTML = selectHTML;
    }

    function removePlayerSlot(team, playerNum) {
        var playerDiv = document.querySelector('[data-player-num="' + playerNum + '"]');
        if (playerDiv) {
            playerDiv.remove();
        }

        // Show add button again if it was hidden
        if (team === 'yellow') {
            document.getElementById('add-yellow-player').style.display = 'block';
            gameState.yellowPlayerCount--;
        } else {
            document.getElementById('add-blue-player').style.display = 'block';
            gameState.bluePlayerCount--;
        }

        // Refresh all dropdowns to update available options after removal
        refreshPlayerDropdowns();

        debugLog('Removed player slot ' + playerNum + ' for ' + team + ' team');
    }

    function updateSoundsStats() {
        var totalSounds = gameState.sounds.length;
        var assignedSounds = 0;
        for (var i = 0; i < gameState.sounds.length; i++) {
            if (gameState.sounds[i].assigned) {
                assignedSounds++;
            }
        }
        var totalSize = 0;
        for (var i = 0; i < gameState.sounds.length; i++) {
            totalSize += gameState.sounds[i].size || 0;
        }
        var sizeMB = (totalSize / 1024 / 1024).toFixed(2);

        // These elements were removed from the UI, so we don't need to update them
        debugLog('Stats updated - Total: ' + totalSounds + ', Assigned: ' + assignedSounds + ', Size: ' + sizeMB + 'MB');
    }

    function randomlyAssignPlayers() {
        debugLog('Randomly assigning players');
        
        // Check if we have any players to assign
        if (!playerProfiles || playerProfiles.length === 0) {
            var message = 'No players available for assignment! Please add players in the Players tab first.';
            if (window.AndroidInterface) {
                window.AndroidInterface.showToast(message);
            }
            return;
        }

        // Check if we have enough players for both teams
        if (playerProfiles.length < 10) {
            var message = 'Need at least 10 players for random assignment (5 per team). You have ' + playerProfiles.length + ' players. Add more in the Players tab.';
            if (window.AndroidInterface) {
                window.AndroidInterface.showToast(message);
            }
            return;
        }

        // Ensure we have exactly 5 slots for each team
        // Add missing slots for yellow team
        while (gameState.yellowPlayerCount < 5) {
            gameState.yellowPlayerCount++;
            addPlayerDropdownElement('yellow', gameState.yellowPlayerCount);
        }
        
        // Add missing slots for blue team
        while (gameState.bluePlayerCount < 5) {
            gameState.bluePlayerCount++;
            addPlayerDropdownElement('blue', gameState.bluePlayerCount);
        }

        // Clear all current assignments (only clear empty slots, preserve manual assignments)
        var currentAssignments = getAllPlayerAssignments();
        var manuallyAssignedSlots = [];
        
        // Track which slots have manual assignments we want to preserve
        for (var i = 0; i < currentAssignments.length; i++) {
            var assignment = currentAssignments[i];
            manuallyAssignedSlots.push(assignment.team + '-' + assignment.slot);
        }
        
        // Clear only empty slots
        for (var i = 1; i <= gameState.yellowPlayerCount; i++) {
            var slotKey = 'yellow-' + i;
            if (manuallyAssignedSlots.indexOf(slotKey) === -1) {
                var button = document.getElementById('yellow-player-' + i);
                if (button) {
                    var isOptional = i > 5;
                    var placeholderText = isOptional ? '#' + i + ' (Optional)' : '#' + i;
                    button.textContent = placeholderText;
                    button.style.border = '2px dashed #666';
                    button.style.background = 'linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%)';
                    button.style.color = '#ccc';
                    button.style.fontWeight = 'normal';
                }
            }
        }
        
        for (var i = 1; i <= gameState.bluePlayerCount; i++) {
            var slotKey = 'blue-' + i;
            if (manuallyAssignedSlots.indexOf(slotKey) === -1) {
                var button = document.getElementById('blue-player-' + i);
                if (button) {
                    var isOptional = i > 5;
                    var placeholderText = isOptional ? '#' + i + ' (Optional)' : '#' + i;
                    button.textContent = placeholderText;
                    button.style.border = '2px dashed #666';
                    button.style.background = 'linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%)';
                    button.style.color = '#ccc';
                    button.style.fontWeight = 'normal';
                }
            }
        }

        // Get available players (exclude manually assigned ones)
        var manuallyAssignedPlayers = currentAssignments.map(function(a) { return a.name; });
        var availablePlayers = [];
        
        for (var i = 0; i < playerProfiles.length; i++) {
            if (manuallyAssignedPlayers.indexOf(playerProfiles[i].name) === -1) {
                availablePlayers.push(playerProfiles[i]);
            }
        }
        
        // Shuffle available players
        shuffleArray(availablePlayers);

        var playersAssigned = 0;
        
        // Assign players to empty yellow team slots
        var yellowSlotsAssigned = 0;
        for (var i = 1; i <= gameState.yellowPlayerCount && yellowSlotsAssigned < 5 && playersAssigned < availablePlayers.length; i++) {
            var slotKey = 'yellow-' + i;
            if (manuallyAssignedSlots.indexOf(slotKey) === -1) {
                var button = document.getElementById('yellow-player-' + i);
                if (button) {
                    var playerToAssign = availablePlayers[playersAssigned];
                    button.textContent = playerToAssign.name;
                    button.style.border = '2px solid #27ae60';
                    button.style.background = '#d5f4e6';
                    button.style.color = '#27ae60';
                    button.style.fontWeight = 'bold';
                    playersAssigned++;
                    yellowSlotsAssigned++;
                }
            }
        }

        // Assign players to empty blue team slots
        var blueSlotsAssigned = 0;
        for (var i = 1; i <= gameState.bluePlayerCount && blueSlotsAssigned < 5 && playersAssigned < availablePlayers.length; i++) {
            var slotKey = 'blue-' + i;
            if (manuallyAssignedSlots.indexOf(slotKey) === -1) {
                var button = document.getElementById('blue-player-' + i);
                if (button) {
                    var playerToAssign = availablePlayers[playersAssigned];
                    button.textContent = playerToAssign.name;
                    button.style.border = '2px solid #27ae60';
                    button.style.background = '#d5f4e6';
                    button.style.color = '#27ae60';
                    button.style.fontWeight = 'bold';
                    playersAssigned++;
                    blueSlotsAssigned++;
                }
            }
        }

        // Update button states
        refreshPlayerDropdowns();

        var totalAssigned = manuallyAssignedPlayers.length + playersAssigned;
        var manualCount = manuallyAssignedPlayers.length;
        var randomCount = playersAssigned;
        
        var message = ' Players assigned! ';
        if (manualCount > 0) {
            message += manualCount + ' kept from manual assignments, ';
        }
        message += randomCount + ' randomly assigned';
        
        if (totalAssigned >= 10) {
            message += ' (5 per team)';
        }
        
        var remainingPlayers = playerProfiles.length - totalAssigned;
        if (remainingPlayers > 0) {
            message += ' (' + remainingPlayers + ' players unassigned)';
        }

        if (window.AndroidInterface) {
            window.AndroidInterface.showToast(message);
        }
        
        // Save the randomly assigned players using the same persistence system
        debugLog('Saving randomly assigned players to gameState and storage');
        savePlayerAssignments();

    }

    // Helper function to shuffle an array
    function shuffleArray(array) {
        for (var i = array.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = array[i];
            array[i] = array[j];
            array[j] = temp;
        }
    }


    function updateTeamHeaders() {
        // Update player section headers in game mode
        var yellowPlayersHeader = document.getElementById('yellow-players-header');
        var bluePlayersHeader = document.getElementById('blue-players-header');
        
        if (yellowPlayersHeader) {
            yellowPlayersHeader.textContent = ' ' + gameState.yellowTeamName + ' Players';
        }
        if (bluePlayersHeader) {
            bluePlayersHeader.textContent = ' ' + gameState.blueTeamName + ' Players';
        }
        
        // Update score header if game is started
        if (gameState.isGameStarted) {
            var yellowNameHeader = document.getElementById('yellow-team-name-header');
            var blueNameHeader = document.getElementById('blue-team-name-header');
            
            if (yellowNameHeader) {
                yellowNameHeader.textContent = gameState.yellowTeamName;
            }
            if (blueNameHeader) {
                blueNameHeader.textContent = gameState.blueTeamName;
            }
        }
    }

    function initializePlayerStats() {
        gameState.playerStats = {};

        for (var i = 0; i < gameState.yellowPlayers.length; i++) {
            var player = gameState.yellowPlayers[i];
            if (player !== 'OWN GOAL') {
                gameState.playerStats['yellow-' + player] = {
                    goals: 0,
                    assists: 0,
                    team: 'yellow',
                    name: player
                };
            }
        }

        for (var i = 0; i < gameState.bluePlayers.length; i++) {
            var player = gameState.bluePlayers[i];
            if (player !== 'OWN GOAL') {
                gameState.playerStats['blue-' + player] = {
                    goals: 0,
                    assists: 0,
                    team: 'blue',
                    name: player
                };
            }
        }

        debugLog('Player stats initialized');
    }

    function generatePlayerButtons() {
        debugLog('Generating player buttons');

        var yellowContainer = document.getElementById('yellow-players-game');
        var blueContainer = document.getElementById('blue-players-game');

        if (!yellowContainer || !blueContainer) {
            debugLog('ERROR: Player containers not found');
            return;
        }

        yellowContainer.innerHTML = '';
        blueContainer.innerHTML = '';

        for (var i = 0; i < gameState.yellowPlayers.length; i++) {
            var player = gameState.yellowPlayers[i];
            var button = document.createElement('button');
            button.className = player === 'OWN GOAL' ? 'player-btn own-goal-btn' : 'player-btn yellow';
            button.textContent = player;
            button.onclick = (function(team, playerName, index) {
                return function() {
                    scoreGoal(team, playerName, index);
                };
            })('yellow', player, i);
            yellowContainer.appendChild(button);
        }

        for (var i = 0; i < gameState.bluePlayers.length; i++) {
            var player = gameState.bluePlayers[i];
            var button = document.createElement('button');
            button.className = player === 'OWN GOAL' ? 'player-btn own-goal-btn' : 'player-btn blue';
            button.textContent = player;
            button.onclick = (function(team, playerName, index) {
                return function() {
                    scoreGoal(team, playerName, index);
                };
            })('blue', player, i);
            blueContainer.appendChild(button);
        }

        debugLog('Generated ' + gameState.yellowPlayers.length + ' yellow buttons and ' + gameState.bluePlayers.length + ' blue buttons');
    }

    function updateCustomSoundButtons() {
        generateCustomSoundCards();
        generateGameModeCustomSounds();
    }

    function generateCustomSoundCards() {
        var container = document.getElementById('custom-sound-grid');
        container.innerHTML = '';

        for (var i = 1; i <= 8; i++) {
            var soundKey = 'custom-sound-' + i;
            var hasSound = gameState.soundAssignments[soundKey] ? true : false;
            var soundName = gameState.customSoundNames[i] || 'Custom Effect ' + i;
            
            var card = document.createElement('div');
            card.className = 'custom-sound-card';
            
            var statusText = hasSound ? 'Sound assigned' : 'No sound assigned';
            var statusColor = hasSound ? '#4ade80' : 'rgba(255, 255, 255, 0.7)';
            
            card.innerHTML = 
                '<div class="custom-sound-card-header">' +
                    '<div class="custom-sound-info">' +
                        '<div class="custom-sound-title">' + soundName + '</div>' +
                        '<div class="custom-sound-status" style="color: ' + statusColor + '">' + statusText + '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="custom-sound-controls">' +
                    '<input type="text" class="custom-sound-name-input" ' +
                           'placeholder="Enter custom name..." ' +
                           'value="' + (gameState.customSoundNames[i] || '') + '"' +
                           'maxlength="20"' +
                           'onchange="updateCustomSoundName(' + i + ', this.value)"' +
                           'onblur="updateCustomSoundName(' + i + ', this.value)">' +
                    '<button class="custom-sound-assign-btn" ' +
                            'onclick="uploadSoundDirectly(\'custom-sound-' + i + '\')">' +
                        ' ' + (hasSound ? 'Change' : 'Upload') +
                    '</button>' +
                    (hasSound ? '<button class="custom-sound-play-btn" ' +
                                         'onclick="playCustomSound(' + i + ')"' +
                                         'title="Play sound">' +
                                        '' +
                                  '</button>' +
                                  '<button class="remove-sound-btn" ' +
                                         'onclick="unassignSound(\'custom-sound-' + i + '\')"' +
                                         'title="Remove assigned sound">' +
                                        '' +
                                  '</button>' : '') +
                '</div>';
            
            container.appendChild(card);
        }
    }

    function generateGameModeCustomSounds() {
        var gameContainer = document.getElementById('custom-sounds-grid');
        var sectionContainer = document.getElementById('custom-sounds-section');
        
        if (!gameContainer || !sectionContainer) return;
        
        gameContainer.innerHTML = '';
        
        // Only show custom sounds if game has been started at least once
        if (!gameState.isGameStarted && !gameState.hasGameBeenStarted) {
            sectionContainer.style.display = 'none';
            return;
        }
        
        var hasAnySounds = false;
        
        // Only create buttons for sounds that actually have assignments
        for (var i = 1; i <= 10; i++) {
            var soundKey = 'custom-sound-' + i;
            var hasSound = gameState.soundAssignments[soundKey] ? true : false;
            
            // Skip if no sound is assigned to this slot
            if (!hasSound) continue;
            
            hasAnySounds = true;
            var soundName = gameState.customSoundNames[i] || 'Custom Sound ' + i;
            
            var button = document.createElement('button');
            button.className = 'custom-sound-btn';
            
            // Simple button with just the sound name
            button.textContent = soundName;
            
            // Set click handler (function will check game state)
            button.onclick = function(soundNum) {
                return function() {
                    playCustomSound(soundNum);
                };
            }(i);
            
            gameContainer.appendChild(button);
        }
        
        // Show section if there are sounds, or show message if no sounds
        if (hasAnySounds) {
            sectionContainer.style.display = 'block';
        } else {
            // Show helpful message when no custom sounds are configured
            gameContainer.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7); font-style: italic; margin: 0;">No custom sounds configured. Go to  Effects tab to upload sounds.</p>';
            sectionContainer.style.display = 'block';
        }
    }

    function updateCustomSoundName(soundNumber, newName) {
        var trimmedName = newName.trim();
        if (trimmedName) {
            gameState.customSoundNames[soundNumber] = trimmedName;
        } else {
            gameState.customSoundNames[soundNumber] = 'Custom Effect ' + soundNumber;
        }
        
        // Update the card display
        setTimeout(function() {
            generateCustomSoundCards();
            generateGameModeCustomSounds();
        }, 100);
        
        // Auto-save to Android storage
        autoSaveSounds();
    }

    // New function to save effect names
    function saveEffectNames() {
        for (var i = 1; i <= 8; i++) {
            var input = document.getElementById('rename-effect-' + i);
            if (input && input.value.trim()) {
                gameState.customSoundNames[i] = input.value.trim();
            }
        }

        updateCustomSoundButtons();


        // Save to localStorage or Android storage
        autoSaveSounds();
    }

    function playCustomSound(soundNumber) {
        if (!gameState.isGameStarted) {
            var message = 'Please start the game first!';
            if (window.AndroidInterface) {
                window.AndroidInterface.showToast(message);
            }
            return;
        }
        
        var soundKey = 'custom-sound-' + soundNumber;
        var soundName = gameState.customSoundNames[soundNumber];

        debugLog('Playing custom sound: ' + soundName + ' (' + soundKey + ')');

        // Stop any currently playing audio
        stopCurrentAudio();

        var soundId = gameState.soundAssignments[soundKey];

        if (soundId) {
            var sound = null;
            for (var i = 0; i < gameState.sounds.length; i++) {
                if (gameState.sounds[i].id === soundId) {
                    sound = gameState.sounds[i];
                    break;
                }
            }

            if (sound) {
                playSound(sound, soundName);
            } else {
                debugLog('Sound not found for ID: ' + soundId);
            }
        } else {
            debugLog('No sound assigned for: ' + soundName);
        }
    }

    function scoreGoal(team, player, playerIndex) {
        if (!gameState.isGameStarted) {
            var message = 'Please start the game first!';
            if (window.AndroidInterface) {
                window.AndroidInterface.showToast(message);
            }
            return;
        }

        debugLog('Goal scored: ' + team + ' - ' + player);

        gameState.currentGoal = {
            team: team,
            player: player,
            playerIndex: playerIndex,
            timestamp: new Date()
        };

        // Handle OWN GOAL differently - no assists, just confirm/cancel
        if (player === 'OWN GOAL') {
            var teamDisplayName = team === 'yellow' ? gameState.yellowTeamName : gameState.blueTeamName;
            document.getElementById('own-goal-team').textContent = (team === 'yellow' ? ' ' : ' ') + teamDisplayName;
            document.getElementById('own-goal-modal').style.display = 'block';
            return;
        }

        // Regular goal - show assist modal
        document.getElementById('goal-scorer').textContent = player;

        var assistButtons = document.getElementById('assist-buttons');
        assistButtons.innerHTML = '';

        var teamPlayers = team === 'yellow' ? gameState.yellowPlayers : gameState.bluePlayers;
        for (var i = 0; i < teamPlayers.length; i++) {
            var teamPlayer = teamPlayers[i];
            if (teamPlayer !== player && teamPlayer !== 'OWN GOAL') {
                var assistBtn = document.createElement('button');
                assistBtn.className = 'assist-btn';
                assistBtn.textContent = teamPlayer;
                assistBtn.onclick = (function(assistPlayer, index) {
                    return function() {
                        selectAssist(assistPlayer, index);
                    };
                })(teamPlayer, i);
                assistButtons.appendChild(assistBtn);
            }
        }

        document.getElementById('assist-modal').style.display = 'block';
    }

    function selectAssist(assistPlayer, assistIndex) {
        gameState.currentGoal.assist = assistPlayer;
        gameState.currentGoal.assistIndex = assistIndex;
        confirmGoal();
    }

    function cancelOwnGoal() {
        document.getElementById('own-goal-modal').style.display = 'none';
        gameState.currentGoal = null;
    }

    function updatePlayerStats(goal) {
        if (goal.player !== 'OWN GOAL') {
            var playerKey = goal.team + '-' + goal.player;
            if (gameState.playerStats[playerKey]) {
                gameState.playerStats[playerKey].goals++;
            }
        }

        if (goal.assist) {
            var assistKey = goal.team + '-' + goal.assist;
            if (gameState.playerStats[assistKey]) {
                gameState.playerStats[assistKey].assists++;
            }
        }

        debugLog('Player stats updated');
    }

    function cancelGoal() {
        document.getElementById('assist-modal').style.display = 'none';
        gameState.currentGoal = null;
    }

    function undoLastAction() {
        // Find the last goal or own-goal action (working backwards from the end)
        var lastActionIndex = -1;
        for (var i = gameState.actionLog.length - 1; i >= 0; i--) {
            var action = gameState.actionLog[i];
            if (action.type === 'goal' || action.type === 'own-goal') {
                lastActionIndex = i;
                break;
            }
        }

        if (lastActionIndex === -1) {
            var message = 'No goals to undo!';
            alert(message);
            if (window.AndroidInterface) {
                // window.AndroidInterface.showToast(message);
            }
            return;
        }

        var lastAction = gameState.actionLog[lastActionIndex];

        debugLog('Found action to undo at index ' + lastActionIndex + ': ' + lastAction.text);

        // Update scores and stats FIRST
        if (lastAction.type === 'goal') {
            // Undo regular goal
            if (lastAction.team === 'yellow') {
                gameState.yellowScore = Math.max(0, gameState.yellowScore - 1);
                document.getElementById('yellow-score').textContent = gameState.yellowScore;
            } else {
                gameState.blueScore = Math.max(0, gameState.blueScore - 1);
                document.getElementById('blue-score').textContent = gameState.blueScore;
            }
            saveGameState(); // Save state after undo
        // Update announcer-related state
        gameState.totalGoalsScored = Math.max(0, gameState.totalGoalsScored - 1);

        // Recalculate lead flags
        var scoreDiff = Math.abs(gameState.yellowScore - gameState.blueScore);
        if (scoreDiff < 3) {
            gameState.hasThreeGoalLead = false;
        }
        if (scoreDiff < 5) {
            gameState.hasFiveGoalLead = false;
        }
            // Update player stats
            if (lastAction.player && lastAction.player !== 'OWN GOAL') {
                var playerKey = lastAction.team + '-' + lastAction.player;
                if (gameState.playerStats[playerKey]) {
                    gameState.playerStats[playerKey].goals = Math.max(0, gameState.playerStats[playerKey].goals - 1);
                }
            }

            if (lastAction.assist) {
                var assistKey = lastAction.team + '-' + lastAction.assist;
                if (gameState.playerStats[assistKey]) {
                    gameState.playerStats[assistKey].assists = Math.max(0, gameState.playerStats[assistKey].assists - 1);
                }
            }
        } else if (lastAction.type === 'own-goal') {
            // Undo own goal
            if (lastAction.scoringTeam === 'yellow') {
                gameState.yellowScore = Math.max(0, gameState.yellowScore - 1);
                document.getElementById('yellow-score').textContent = gameState.yellowScore;
            } else {
                gameState.blueScore = Math.max(0, gameState.blueScore - 1);
                document.getElementById('blue-score').textContent = gameState.blueScore;
            }
        }

        // Remove the action from the array
        gameState.actionLog.splice(lastActionIndex, 1);

        // Rebuild the entire log display
        rebuildLogDisplay();

        // Show success message
        debugLog('Successfully undid: ' + lastAction.text);
    }

    // Simplified rebuild function
    function rebuildLogDisplay() {
        var logContainer = document.getElementById('log-entries');
        logContainer.innerHTML = '';

        for (var i = 0; i < gameState.actionLog.length; i++) {
            var action = gameState.actionLog[i];
            var logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.setAttribute('data-log-index', i);

            if (action.type === 'goal') {
                logEntry.className += ' ' + action.team;
                logEntry.innerHTML = '<span class="log-entry-text">' + action.text + '</span>' +
                    '<div class="log-entry-actions">' +
                    '<button class="log-action-btn edit" onclick="if(window.AndroidInterface) window.AndroidInterface.showToast(\'Edit clicked from restore!\'); editLogEntry(' + i + ')"></button>' +
                    '<button class="log-action-btn delete" onclick="if(window.AndroidInterface) window.AndroidInterface.showToast(\'Delete clicked from restore for index ' + i + '!\'); deleteLogEntry(' + i + ')"></button>' +
                    '</div>';
            } else if (action.type === 'own-goal') {
                logEntry.className += ' ' + action.scoringTeam;
                logEntry.innerHTML = '<span class="log-entry-text">' + action.text + '</span>' +
                    '<div class="log-entry-actions">' +
                    '<button class="log-action-btn edit" onclick="if(window.AndroidInterface) window.AndroidInterface.showToast(\'Edit own goal clicked from restore!\'); editLogEntry(' + i + ')"></button>' +
                    '<button class="log-action-btn delete" onclick="if(window.AndroidInterface) window.AndroidInterface.showToast(\'Delete own goal clicked from restore for index ' + i + '!\'); deleteLogEntry(' + i + ')"></button>' +
                    '</div>';
            } else {
                // System message (game start/stop)
                logEntry.innerHTML = '<span class="log-entry-text">' + action.text + '</span>';
            }

            logContainer.appendChild(logEntry);
        }

        // Update all log entry indices and bind event handlers
        updateLogEntryIndices();

        logContainer.scrollTop = logContainer.scrollHeight;
    }

    function resetMatch() {
        debugLog('Reset button clicked - showing confirmation modal');

        // Show custom reset confirmation modal
        document.getElementById('reset-modal').style.display = 'block';
    }

    function cancelReset() {
        debugLog('Reset cancelled by user');
        document.getElementById('reset-modal').style.display = 'none';
    }

    function confirmReset() {
        debugLog('Reset confirmed by user - executing reset');
        document.getElementById('reset-modal').style.display = 'none';

        // Reset scores to 0-0
        gameState.yellowScore = 0;
        gameState.blueScore = 0;
        document.getElementById('yellow-score').textContent = '0';
        document.getElementById('blue-score').textContent = '0';
        // Add these lines to reset announcer state:
        gameState.totalGoalsScored = 0;
        gameState.hasThreeGoalLead = false;
        gameState.hasFiveGoalLead = false;

        // Clear all action log
        gameState.actionLog = [];

        // Reset all player stats to 0
        for (var key in gameState.playerStats) {
            gameState.playerStats[key].goals = 0;
            gameState.playerStats[key].assists = 0;
        }

        // Clear the log display
        var logContainer = document.getElementById('log-entries');
        logContainer.innerHTML = '';

        // Add reset entry to log
        var resetEntry = {
            type: 'system',
            text: ' Match Reset - All data cleared',
            timestamp: new Date()
        };
        gameState.actionLog.push(resetEntry);

        // Add the reset entry to display
        var logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.setAttribute('data-log-index', '0');
        logEntry.innerHTML = '<span class="log-entry-text">' + resetEntry.text + '</span>';
        logContainer.appendChild(logEntry);

        // Show success message
        debugLog('Match reset completed - all data cleared');


        // Add a brief visual feedback
        document.getElementById('yellow-score').classList.add('score-animation');
        document.getElementById('blue-score').classList.add('score-animation');
        setTimeout(function() {
            document.getElementById('yellow-score').classList.remove('score-animation');
            document.getElementById('blue-score').classList.remove('score-animation');
        }, 1000);
    }

    function exportLog() {
        debugLog('exportLog() function called');
        
        if (gameState.actionLog.length === 0) {
            var message = 'No match data to export!';
            debugLog('No action log data to export');
            alert(message);
            return;
        }

        debugLog('Generating match report...');
        var report = generateMatchReport();
        var filename = 'football_match_' + new Date().toISOString().split('T')[0] + '_' + new Date().toTimeString().split(' ')[0].replace(/:/g, '-') + '.txt';
        debugLog('Generated filename: ' + filename);

        if (window.AndroidInterface) {
            debugLog('AndroidInterface is available');
            
            debugLog('Calling AndroidInterface.saveMatchReport...');
            try {
                window.AndroidInterface.saveMatchReport(report, filename);
                debugLog('AndroidInterface.saveMatchReport called successfully');
                
                // Show success dialog
                showExportSuccessDialog(filename);
            } catch (error) {
                debugLog('Error calling AndroidInterface.saveMatchReport: ' + error.message);
                alert('Error saving report: ' + error.message);
            }
        } else {
            debugLog('AndroidInterface not available, showing alert');
            alert('Match report ready:\n\n' + report);
        }
    }

    function showExportSuccessDialog(filename) {
        var dialog = confirm(
            ' Match Report Exported\n\n' +
            'File saved to Downloads folder:\n' + filename + '\n\n' +
            'The report includes match timeline, scores, and player stats.\n\n' +
            'Click OK to continue or Cancel to view Downloads folder.'
        );
        
        if (!dialog && window.AndroidInterface && window.AndroidInterface.openDownloadsFolder) {
            try {
                window.AndroidInterface.openDownloadsFolder();
            } catch (e) {
                debugLog('Could not open downloads folder: ' + e.message);
            }
        }

        debugLog('Match report export process completed: ' + filename);
    }

    // Debug function to check interface status
    function checkInterfaceStatus() {
        var status = {
            windowAndroidInterface: typeof window.AndroidInterface !== 'undefined',
            saveMatchReport: false,
            testInterface: false,
            timestamp: new Date().toISOString()
        };
        
        if (window.AndroidInterface) {
            status.saveMatchReport = typeof window.AndroidInterface.saveMatchReport === 'function';
            status.testInterface = typeof window.AndroidInterface.testInterface === 'function';
        }
        
        debugLog('Interface Status Check: ' + JSON.stringify(status));
        
        return status;
    }

    // Debug display removed


    // Periodic interface check (every 10 seconds)
    setInterval(function() {
        debugLog('Periodic interface check...');
        checkInterfaceStatus();
    }, 10000);

    function getAllPlayerStats() {
        var players = [];
        for (var key in gameState.playerStats) {
            var player = gameState.playerStats[key];
            // Only include players who have goals or assists
            if (player.goals > 0 || player.assists > 0) {
                players.push(player);
            }
        }

        // Sort by goals first (descending), then by assists (descending)
        players.sort(function(a, b) {
            if (b.goals !== a.goals) {
                return b.goals - a.goals; // Sort by goals first
            }
            return b.assists - a.assists; // Then by assists
        });

        return players;
    }

    function getTopScorers() {
        var players = [];
        for (var key in gameState.playerStats) {
            if (gameState.playerStats[key].goals > 0) {
                players.push(gameState.playerStats[key]);
            }
        }
        players.sort(function(a, b) {
            return b.goals - a.goals;
        });
        return players.slice(0, 5);
    }

    function getTopAssistants() {
        var players = [];
        for (var key in gameState.playerStats) {
            if (gameState.playerStats[key].assists > 0) {
                players.push(gameState.playerStats[key]);
            }
        }
        players.sort(function(a, b) {
            return b.assists - a.assists;
        });
        return players.slice(0, 5);
    }

    // Complete Sound Functions
    function openNativeSoundPicker() {
        if (window.AndroidInterface) {
            debugLog('Opening native sound picker');
            window.AndroidInterface.openSoundPicker();
        } else {
            alert('Native sound picker only works in the Android app!');
        }
    }

    function addSoundFromNative(fileName, dataUrl, fileSize) {
        debugLog('Adding sound from native: ' + fileName + ', Size: ' + fileSize);

        // Check file size (5MB = 5 * 1024 * 1024 bytes)
        var maxSize = 5 * 1024 * 1024;
        if (fileSize > maxSize) {
            var sizeInMB = (fileSize / (1024 * 1024)).toFixed(1);
            var message = 'File size too large! Maximum allowed: 5MB, your file: ' + sizeInMB + 'MB';
            alert(message);
            if (window.AndroidInterface) {
                window.AndroidInterface.showToast(message);
            }
            return;
        }

        try {
            var sound = {
                name: fileName,
                data: dataUrl,
                id: 'sound_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                size: fileSize,
                type: getMimeTypeFromDataUrl(dataUrl),
                assigned: false,
                uploadDate: new Date().toISOString()
            };

            gameState.sounds.push(sound);

            // Make sure the sound list exists before trying to display
            var soundList = document.getElementById('sound-list');
            if (soundList) {
                displaySoundItem(sound);
            } else {
                debugLog('Warning: sound-list element not found, will display on next refresh');
            }

            autoSaveSounds();
            showUploadStatus(' Successfully uploaded: ' + fileName, 'success');

            debugLog('Sound added successfully. Total sounds: ' + gameState.sounds.length);

            if (window.AndroidInterface) {
                // window.AndroidInterface.showToast(' "' + fileName + '" uploaded successfully');
            }
        } catch (error) {
            debugLog('Error in addSoundFromNative: ' + error.message);
            // Still show success if the sound was added
            if (gameState.sounds.length > 0) {
                showUploadStatus(' Successfully uploaded: ' + fileName, 'success');
                if (window.AndroidInterface) {
                    // window.AndroidInterface.showToast(' "' + fileName + '" uploaded successfully');
                }
            } else {
                showUploadStatus(' Error adding sound: ' + error.message, 'error');
            }
        }
    }

    function getMimeTypeFromDataUrl(dataUrl) {
        var match = dataUrl.match(/data:([^;]+);/);
        return match ? match[1] : 'audio/mpeg';
    }

    function showUploadStatus(message, type) {
        var statusDiv = document.getElementById('upload-status');
        if (statusDiv) {
            statusDiv.style.display = 'block';
            statusDiv.style.color = type === 'success' ? '#27ae60' : '#e74c3c';
            statusDiv.style.background = type === 'success' ? 'rgba(39, 174, 96, 0.2)' : 'rgba(231, 76, 60, 0.2)';
            statusDiv.textContent = message;

            setTimeout(function() {
                statusDiv.style.display = 'none';
            }, 4000);
        }
    }

    function displayAllSounds() {
        var soundList = document.getElementById('sound-list');

        if (!soundList) {
            debugLog('ERROR: sound-list element not found');
            return;
        }

        debugLog('Displaying all sounds. Count: ' + gameState.sounds.length);

        if (gameState.sounds.length === 0) {
            soundList.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">' +
                '<h3>No sounds uploaded yet</h3>' +
                '<p>Click "Upload Sound from Device" to get started!</p>' +
                '</div>';
            return;
        }

        soundList.innerHTML = '';
        for (var i = 0; i < gameState.sounds.length; i++) {
            displaySoundItem(gameState.sounds[i]);
        }
    }

    // Modified assignSound function to prevent multiple assignments
    function assignSound(soundId, assignment) {
        try {
            if (assignment) {
                // Check if this assignment already has a sound
                if (gameState.soundAssignments[assignment]) {
                    var existingSoundId = gameState.soundAssignments[assignment];
                    if (existingSoundId !== soundId) {
                        // Different sound already assigned - ask for confirmation
                        var existingSound = null;
                        for (var i = 0; i < gameState.sounds.length; i++) {
                            if (gameState.sounds[i].id === existingSoundId) {
                                existingSound = gameState.sounds[i];
                                break;
                            }
                        }

                        var confirmMsg = 'This assignment already has a sound: "' + (existingSound ? existingSound.name : 'Unknown') + '"\n\nDo you want to replace it?';
                        if (!confirm(confirmMsg)) {
                            // Restore select to empty value
                            var select = document.getElementById('select-' + soundId);
                            if (select) {
                                select.value = '';
                            }
                            return;
                        }

                        // Unassign the previous sound
                        if (existingSound) {
                            existingSound.assigned = false;
                            updateSoundItemStatus(existingSoundId, false);
                        }
                    }
                }

                // Remove previous assignment for this sound
                for (var key in gameState.soundAssignments) {
                    if (gameState.soundAssignments[key] === soundId) {
                        delete gameState.soundAssignments[key];
                    }
                }

                // Add new assignment
                gameState.soundAssignments[assignment] = soundId;

                // Update sound object
                var sound = null;
                for (var i = 0; i < gameState.sounds.length; i++) {
                    if (gameState.sounds[i].id === soundId) {
                        sound = gameState.sounds[i];
                        break;
                    }
                }

                if (sound) {
                    sound.assigned = true;
                    updateSoundItemStatus(soundId, true);
                }

                debugLog('Assigned sound ' + soundId + ' to ' + assignment);
                autoSaveSounds();

                if (sound && window.AndroidInterface) {
                    var displayName = getAssignmentDisplayName(assignment);
                    // window.AndroidInterface.showToast(' "' + sound.name + '" assigned to ' + displayName);
                }
            } else {
                // Unassign sound
                for (var key in gameState.soundAssignments) {
                    if (gameState.soundAssignments[key] === soundId) {
                        delete gameState.soundAssignments[key];
                    }
                }

                var sound = null;
                for (var i = 0; i < gameState.sounds.length; i++) {
                    if (gameState.sounds[i].id === soundId) {
                        sound = gameState.sounds[i];
                        break;
                    }
                }

                if (sound) {
                    sound.assigned = false;
                    updateSoundItemStatus(soundId, false);
                }

                autoSaveSounds();
            }

            // Update custom sound button appearance
            updateCustomSoundButtons();

        } catch (error) {
            debugLog('Error assigning sound: ' + error.message);
            if (window.AndroidInterface) {
                // window.AndroidInterface.showToast(' Error assigning sound');
            }
            // Restore select to empty value
            var select = document.getElementById('select-' + soundId);
            if (select) {
                select.value = '';
            }
        }
    }

    // Helper function to update sound item status
    function updateSoundItemStatus(soundId, isAssigned) {
        var soundItem = document.querySelector('[data-sound-id="' + soundId + '"]');
        if (soundItem) {
            var statusSpans = soundItem.querySelectorAll('span');
            var statusSpan = null;

            // Find the status span (the one with padding: 6px)
            for (var i = 0; i < statusSpans.length; i++) {
                if (statusSpans[i].style.padding && statusSpans[i].style.padding.includes('6px')) {
                    statusSpan = statusSpans[i];
                    break;
                }
            }

            if (statusSpan) {
                if (isAssigned) {
                    statusSpan.style.cssText = 'padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; background: rgba(39, 174, 96, 0.2); color: #4ade80;';
                    statusSpan.textContent = ' Assigned';
                } else {
                    statusSpan.style.cssText = 'padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; background: rgba(231, 76, 60, 0.2); color: #f87171;';
                    statusSpan.textContent = ' Not Assigned';
                }
            }
        }

        // Also update the select dropdown if it's set
        var select = document.getElementById('select-' + soundId);
        if (select && !isAssigned) {
            select.value = '';
        }
    }

    // Helper function to get display name for assignment
    function getAssignmentDisplayName(assignment) {
        if (assignment === 'yellow-team') return ' Yellow Team';
        if (assignment === 'blue-team') return ' Blue Team';
        if (assignment === 'yellow-own-goal') return ' Yellow Team Own Goal';
        if (assignment === 'blue-own-goal') return ' Blue Team Own Goal';
        if (assignment.startsWith('custom-sound-')) {
            var soundNum = assignment.replace('custom-sound-', '');
            return gameState.customSoundNames[parseInt(soundNum)];
        }
        return assignment.replace('-', ' ').replace('own goal', 'OWN GOAL');
    }

// Fixed removeSound function
function removeSound(soundId) {
    debugLog('Remove sound clicked for ID: ' + soundId);

    var sound = null;
    var soundIndex = -1;
    for (var i = 0; i < gameState.sounds.length; i++) {
        if (gameState.sounds[i].id === soundId) {
            sound = gameState.sounds[i];
            soundIndex = i;
            break;
        }
    }

    if (!sound) {
        debugLog('ERROR: Sound not found for ID: ' + soundId);
        if (window.AndroidInterface) {
            // window.AndroidInterface.showToast(' Sound not found');
        }
        return;
    }

    var soundName = sound.name;
    debugLog('Found sound to remove: ' + soundName + ' at index ' + soundIndex);

    // Confirmation prompt
    if (confirm(' Are you sure you want to remove "' + soundName + '"?\n\nThis will:\n Remove the sound from the app\n Clear all assignments using this sound\n This action cannot be undone')) {
        debugLog('User confirmed removal of: ' + soundName);

        // Stop current audio if it's the one being removed
        if (currentAudio && sound && currentAudio.src === sound.data) {
            stopCurrentAudio();
        }

        // Remove all assignments for this sound
        var assignmentKeysToRemove = [];
        for (var key in gameState.soundAssignments) {
            if (gameState.soundAssignments[key] === soundId) {
                assignmentKeysToRemove.push(key);
            }
        }

        for (var i = 0; i < assignmentKeysToRemove.length; i++) {
            delete gameState.soundAssignments[assignmentKeysToRemove[i]];
            debugLog('Removed assignment: ' + assignmentKeysToRemove[i]);
        }

        // Remove from sounds array
        if (soundIndex !== -1) {
            gameState.sounds.splice(soundIndex, 1);
            debugLog('Removed from sounds array. New length: ' + gameState.sounds.length);
        }

        // Remove the DOM element
        var soundItem = document.querySelector('[data-sound-id="' + soundId + '"]');
        if (soundItem) {
            soundItem.remove();
            debugLog('Removed DOM element');
        } else {
            debugLog('WARNING: DOM element not found for sound ID: ' + soundId);
        }

        // Update all UI elements that might be affected
        updateAllSoundAssignmentButtons();
        updateCustomSoundButtons();
        updateSoundsStats();

        // If we're in game mode, also update the rename effects container
        if (document.getElementById('rename-effects-container').style.display !== 'none') {
            generateRenameInputs();
        }

        // If no sounds left, show empty message
        if (gameState.sounds.length === 0) {
            var soundList = document.getElementById('sound-list');
            if (soundList) {
                soundList.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">' +
                    '<h3>No sounds uploaded yet</h3>' +
                    '<p>Click "Upload Sound from Device" to get started!</p>' +
                    '</div>';
            }
        }

        // Save the updated state
        autoSaveSounds();

        if (window.AndroidInterface) {
            window.AndroidInterface.showToast(' "' + soundName + '" deleted');
        }

        debugLog('Sound removed successfully: ' + soundName + ' (ID: ' + soundId + ')');
    } else {
        debugLog('User cancelled removal of: ' + soundName);
    }
}

// Also fix the updateLogEntryIndices function that was referenced but missing
function updateLogEntryIndices() {
    debugLog('Updating log entry indices and event handlers');
    var logEntries = document.querySelectorAll('.log-entry[data-log-index]');
    debugLog('Found ' + logEntries.length + ' log entries to update');
    for (var i = 0; i < logEntries.length; i++) {
        var entry = logEntries[i];
        entry.setAttribute('data-log-index', i);

        // Update the button onclick handlers
        var editBtn = entry.querySelector('.log-action-btn.edit');
        var deleteBtn = entry.querySelector('.log-action-btn.delete');

        if (editBtn) {
            editBtn.onclick = function(index) {
                return function() { 
                    debugLog('Edit button clicked for index: ' + index);
                    editLogEntry(index); 
                };
            }(i);
        }

        if (deleteBtn) {
            deleteBtn.onclick = function(index) {
                return function() { 
                    debugLog('Delete button clicked via updateLogEntryIndices for index: ' + index);
                    deleteLogEntry(index); 
                };
            }(i);
        }
    }
}

    // New function to update sound assignment dropdowns
    function updateSoundAssignmentDropdowns() {
        for (var i = 0; i < gameState.sounds.length; i++) {
            var sound = gameState.sounds[i];
            var soundItem = document.querySelector('[data-sound-id="' + sound.id + '"]');
            if (soundItem) {
                soundItem.remove();
                displaySoundItem(sound);
            }
        }
    }

    // Enhanced audio control functions
    function stopCurrentAudio() {
        if (currentAudio) {
            try {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                // Clear event handlers to prevent memory leaks
                currentAudio.onended = null;
                currentAudio.onerror = null;
                currentAudio.ontimeupdate = null;
                // Clear the source and force cleanup
                currentAudio.src = '';
                currentAudio.load();
            } catch (e) {
                debugLog('Error stopping audio: ' + e.message);
            } finally {
                currentAudio = null;
                debugLog('Stopped current audio playback');
            }
        }

        // Clear any existing timeout
        if (audioTimeout) {
            clearTimeout(audioTimeout);
            audioTimeout = null;
        }
    }

    function stopCurrentSound() {
        stopCurrentAudio();
        
        if (window.AndroidInterface) {
            // window.AndroidInterface.showToast(' Sound playback stopped');
        }
        debugLog('Sound playback stopped by user');
    }

    // Unified play sound function with 15-second limit
    function playSound(sound, description) {
        try {
            currentAudio = new Audio(sound.data);
            currentAudio.volume = 0.8;

            // Set up 15-second timeout
            audioTimeout = setTimeout(function() {
                debugLog('Sound playback exceeded 15 seconds - stopping');
                stopCurrentAudio();
            }, 15000);

            // Clear currentAudio when sound finishes or errors
            currentAudio.onended = function() {
                debugLog('Sound ended naturally');
                stopCurrentAudio();
            };

            currentAudio.onerror = function(e) {
                debugLog('Audio playback error: ' + e.type);
                stopCurrentAudio();
            };

            currentAudio.play().then(function() {
                debugLog('Sound played successfully: ' + sound.name + ' (' + description + ')');
                if (window.AndroidInterface) {
                    window.AndroidInterface.playSound(sound.name, description);
                }
            }).catch(function(e) {
                debugLog('Sound play error: ' + e.message);
                stopCurrentAudio();
                if (window.AndroidInterface) {
                    // window.AndroidInterface.showToast(' Sound playback failed');
                }
            });
        } catch (e) {
            debugLog('Error creating audio: ' + e.message);
            currentAudio = null;
            if (audioTimeout) {
                clearTimeout(audioTimeout);
                audioTimeout = null;
            }
        }
    }


    function getRandomPlayerMusic(playerName) {
        if (!playerProfiles || playerProfiles.length === 0) return null;
        
        var player = playerProfiles.find(function(p) { return p.name === playerName; });
        if (!player) return null;
        
        // Collect all assigned music tracks
        var musicTracks = [];
        for (var i = 1; i <= 3; i++) {
            var slot = 'slot' + i;
            if (player.music[slot] !== null) {
                musicTracks.push(player.music[slot]);
            }
        }
        
        if (musicTracks.length === 0) return null;
        
        // Return random track
        var randomIndex = Math.floor(Math.random() * musicTracks.length);
        return musicTracks[randomIndex];
    }

    function playGoalSound(team, player) {
        debugLog('Attempting to play sound for: ' + team + ' - ' + player);


        // Stop any currently playing audio
        stopCurrentAudio();

        var soundPlayed = false;
        
        // Special handling for OWN GOAL - use existing system
        if (player === 'OWN GOAL') {
            var ownGoalKey = team + '-own-goal';
            if (gameState.soundAssignments[ownGoalKey]) {
                var soundId = gameState.soundAssignments[ownGoalKey];
                var sound = gameState.sounds.find(function(s) { return s.id === soundId; });
                if (sound) {
                    var description = 'Own Goal: ' + team;
                    playSound(sound, description);
                    soundPlayed = true;
                    debugLog('Played own goal sound');
                }
            }
        } else {
            // Try to play random player music first
            var playerMusic = getRandomPlayerMusic(player);
            if (playerMusic) {
                try {
                    // Use unified audio system with 15-second timeout and overlap prevention
                    var playerMusicSound = {
                        name: playerMusic.name,
                        data: playerMusic.dataUrl
                    };
                    var description = 'Goal: ' + team + ' - ' + player;
                    playSound(playerMusicSound, description);
                    soundPlayed = true;
                    debugLog('Playing random player music: ' + playerMusic.name + ' for ' + player);
                } catch (error) {
                    debugLog('Error playing player music: ' + error.message);
                    playGoalSoundFallback(team, player);
                    soundPlayed = true;
                }
            }
        }
        
        // If no player music was played, use existing sound system
        if (!soundPlayed) {
            playGoalSoundFallback(team, player);
        }
    }
    
    function playGoalSoundFallback(team, player) {
        debugLog('Using fallback sound system for: ' + team + ' - ' + player);
        
        var soundId = null;
        var playerKey = null;
        var teamKey = team + '-team';

        // Get the original slot number for this player
        var playerSlots = team === 'yellow' ? gameState.yellowPlayerSlots : gameState.bluePlayerSlots;
        var originalSlotNumber = playerSlots[player];

        if (originalSlotNumber) {
            playerKey = team + '-player-' + originalSlotNumber;
        }

        // Try player-specific sound first
        if (playerKey && gameState.soundAssignments[playerKey]) {
            soundId = gameState.soundAssignments[playerKey];
            debugLog('Found player-specific sound: ' + playerKey);
        }
        // Fallback to team sound
        else if (gameState.soundAssignments[teamKey]) {
            soundId = gameState.soundAssignments[teamKey];
            debugLog('Found team sound: ' + teamKey);
        }

        if (soundId) {
            var sound = null;
            for (var i = 0; i < gameState.sounds.length; i++) {
                if (gameState.sounds[i].id === soundId) {
                    sound = gameState.sounds[i];
                    break;
                }
            }

            if (sound) {
                var description = 'Goal: ' + team + ' - ' + player;
                playSound(sound, description);
            } else {
                debugLog('Sound not found for ID: ' + soundId);
            }
        } else {
            debugLog('No sound assigned for: ' + team + ' - ' + player);
        }
    }

    function autoSaveSounds() {
        debugLog('Auto-saving sounds');
        if (window.AndroidInterface) {
            try {
                // Include custom sound names in the save
                var saveData = {
                    sounds: gameState.sounds,
                    soundAssignments: gameState.soundAssignments,
                    playerAssignments: gameState.playerAssignments,
                    customSoundNames: gameState.customSoundNames
                };
                var soundsJson = JSON.stringify(saveData);
                window.AndroidInterface.saveSounds(soundsJson, '');
            } catch (error) {
                debugLog('Auto-save failed: ' + error.message);
            }
        }
        updateSoundsStats();
    }

    function saveAllSounds() {
        debugLog('Saving sounds via Android interface');

        if (window.AndroidInterface) {
            try {
                debugLog('=== SAVE ALL SOUNDS DEBUG: saveAllSounds() called');
                debugLog('=== SAVE ALL SOUNDS DEBUG: gameState.playerAssignments = ' + JSON.stringify(gameState.playerAssignments));
                
                var saveData = {
                    sounds: gameState.sounds,
                    soundAssignments: gameState.soundAssignments,
                    playerAssignments: gameState.playerAssignments,
                    customSoundNames: gameState.customSoundNames
                };
                
                debugLog('=== SAVE ALL SOUNDS DEBUG: saveData object created with playerAssignments: ' + JSON.stringify(saveData.playerAssignments));
                
                var soundsJson = JSON.stringify(saveData);
                debugLog('=== SAVE ALL SOUNDS DEBUG: About to call AndroidInterface.saveSounds with data length: ' + soundsJson.length);
                
                window.AndroidInterface.saveSounds(soundsJson, '');
                updateSoundsStats();
                debugLog('=== SAVE ALL SOUNDS DEBUG: Saved ' + gameState.sounds.length + ' sounds and ' + Object.keys(gameState.playerAssignments || {}).length + ' player assignments to Android storage');
                
                // Show confirmation toast
                // if (window.AndroidInterface) {
                //     window.AndroidInterface.showToast(' Saved sounds + ' + Object.keys(gameState.playerAssignments || {}).length + ' player assignments');
                // }
            } catch (error) {
                debugLog('Error saving sounds: ' + error.message);
                if (window.AndroidInterface) {
                    // window.AndroidInterface.showToast(' Error saving sounds');
                }
            }
        } else {
            alert(' Android interface not available. This feature requires the Android app.');
        }
    }

    function loadSavedSounds() {
        debugLog('Loading sounds via Android interface');

        if (window.AndroidInterface) {
            try {
                window.AndroidInterface.loadSounds();
            } catch (error) {
                debugLog('Error loading sounds: ' + error.message);
                if (window.AndroidInterface) {
                    // window.AndroidInterface.showToast(' Error loading sounds');
                }
            }
        } else {
            alert(' Android interface not available. This feature requires the Android app.');
        }
    }

    function loadSoundsFromAndroid(soundsJson, assignmentsJson) {
        debugLog('=== LOAD FROM ANDROID DEBUG: loadSoundsFromAndroid() called');
        debugLog('=== LOAD FROM ANDROID DEBUG: soundsJson length: ' + (soundsJson ? soundsJson.length : 'null'));
        debugLog('Loading sounds from Android storage');

        try {
            if (soundsJson && soundsJson.trim() !== '') {
                var data = JSON.parse(soundsJson);

                // Handle both old and new data formats
                if (data.sounds) {
                    // New format with all data
                    debugLog('=== LOAD DEBUG: Loading new format data');
                    gameState.sounds = data.sounds || [];
                    gameState.soundAssignments = data.soundAssignments || {};
                    gameState.playerAssignments = data.playerAssignments || {};
                    debugLog('=== LOAD DEBUG: Loaded playerAssignments from data: ' + JSON.stringify(gameState.playerAssignments));
                    if (data.customSoundNames) {
                        gameState.customSoundNames = data.customSoundNames;
                    }
                } else {
                    // Old format - just sounds array
                    gameState.sounds = data || [];

                    // Try to load assignments from second parameter
                    if (assignmentsJson && assignmentsJson.trim() !== '') {
                        var assignments = JSON.parse(assignmentsJson);
                        gameState.soundAssignments = assignments || {};
                    }
                }

                debugLog('Loaded ' + gameState.sounds.length + ' sounds from Android');
                debugLog('Loaded ' + Object.keys(gameState.soundAssignments).length + ' assignments from Android');
            }

            displayAllSounds();
            updateSoundsStats();
            updateCustomSoundButtons();
            
            // Restore player assignments if they exist
            debugLog('=== RESTORE DEBUG: Checking for player assignments to restore...');
            debugLog('=== RESTORE DEBUG: gameState.playerAssignments = ' + JSON.stringify(gameState.playerAssignments));
            if (gameState.playerAssignments && Object.keys(gameState.playerAssignments).length > 0) {
                debugLog('=== RESTORE DEBUG: Found ' + Object.keys(gameState.playerAssignments).length + ' assignments, calling restore function');
                restorePlayerAssignmentsFromGameState();
                debugLog('=== RESTORE DEBUG: Restore function completed');
                
                // Show toast for debugging
                // if (window.AndroidInterface) {
                //     window.AndroidInterface.showToast(' Restored ' + Object.keys(gameState.playerAssignments).length + ' player assignments');
                // }
            } else {
                debugLog('=== RESTORE DEBUG: No player assignments found to restore');
                // if (window.AndroidInterface) {
                //     window.AndroidInterface.showToast(' No player assignments to restore');
                // }
            }

            if (window.AndroidInterface) {
                // window.AndroidInterface.showToast(' Loaded ' + gameState.sounds.length + ' saved sounds!');
            }
        } catch (error) {
            debugLog('Error parsing sounds from Android: ' + error.message);
            if (window.AndroidInterface) {
                // window.AndroidInterface.showToast(' Error loading saved sounds');
            }
        }
    }

// Also add this function to clear all sounds and refresh the display
function clearAllSounds() {
    if (gameState.sounds.length === 0) {
        if (window.AndroidInterface) {
            // window.AndroidInterface.showToast('No sounds to clear');
        } else {
            alert('No sounds to clear');
        }
        return;
    }

    var confirmMessage = ' Clear All Sounds\n\n';
    confirmMessage += 'This will permanently remove:\n';
    confirmMessage += ' ' + gameState.sounds.length + ' uploaded sound' + (gameState.sounds.length !== 1 ? 's' : '') + '\n';
    confirmMessage += ' All sound assignments\n';
    confirmMessage += ' All saved sound data\n\n';
    confirmMessage += 'This action cannot be undone.\n\n';
    confirmMessage += 'Are you sure you want to continue?';

    if (confirm(confirmMessage)) {
        debugLog('Clearing all sounds via user confirmation');

        var soundCount = gameState.sounds.length;

        // Stop any playing audio first
        stopCurrentAudio();

        // Clear all data
        gameState.sounds = [];
        gameState.soundAssignments = {};

        // Clear the UI and show empty message
        displayAllSounds();

        // Update all UI elements
        updateAllSoundAssignmentButtons();
        updateCustomSoundButtons();
        updateSoundsStats();

        // Clear from Android storage
        if (window.AndroidInterface) {
            try {
                window.AndroidInterface.clearAllSounds();
                // window.AndroidInterface.showToast(' Cleared ' + soundCount + ' sounds successfully');
            } catch (error) {
                debugLog('Error clearing sounds from Android storage: ' + error.message);
            }
        }

        debugLog('All sounds cleared: ' + soundCount + ' sounds removed');
    }
}

    function showStorageInfo() {
        debugLog('Getting storage info');

        var soundsSize = 0;
        for (var i = 0; i < gameState.sounds.length; i++) {
            soundsSize += gameState.sounds[i].size || 0;
        }
        var soundsSizeMB = (soundsSize / 1024 / 1024).toFixed(2);
        var assignedSounds = 0;
        for (var i = 0; i < gameState.sounds.length; i++) {
            if (gameState.sounds[i].assigned) {
                assignedSounds++;
            }
        }

        if (window.AndroidInterface) {
            try {
                // Let Android show the full storage info
                window.AndroidInterface.getStorageInfo();
            } catch (error) {
                debugLog('Error getting storage info: ' + error.message);
                if (window.AndroidInterface) {
                    // window.AndroidInterface.showToast(' Error getting storage info');
                }
            }
        } else {
            var info = ' Sound Storage Information:\n\n';
            info += ' Current Statistics:\n';
            info += ' Total sounds: ' + gameState.sounds.length + '\n';
            info += ' Assigned sounds: ' + assignedSounds + '/' + gameState.sounds.length + '\n';
            info += ' Storage used: ' + soundsSizeMB + ' MB\n';
            info += ' Active assignments: ' + Object.keys(gameState.soundAssignments).length + '\n\n';
            info += ' Note: Android interface not available for detailed storage info.';

            alert(info);
        }
    }

    // Function for direct sound upload
    function uploadSoundDirectly(target) {
        debugLog('Direct upload for: ' + target);
        currentSoundTarget = target;
        
        if (window.AndroidInterface) {
            window.AndroidInterface.openSoundPicker();
        } else {
            debugLog('AndroidInterface not available');
        }
    }

    function updateSoundAssignmentButton(target) {
        var btnId = '';
        if (target === 'yellow-team') {
            btnId = 'yellow-team-sound-btn';
        } else if (target === 'blue-team') {
            btnId = 'blue-team-sound-btn';
        } else if (target === 'yellow-own-goal') {
            btnId = 'yellow-own-goal-sound-btn';
        } else if (target === 'blue-own-goal') {
            btnId = 'blue-own-goal-sound-btn';
        } else if (target.startsWith('custom-sound-')) {
            btnId = 'effect-sound-btn-' + target.replace('custom-sound-', '');
        } else if (target.includes('-player-')) {
            var parts = target.split('-');
            btnId = parts[0] + '-player-sound-' + parts[2];
        }


        // Update status display for team and own goal sections
        var statusId = target + '-status';
        var statusElement = document.getElementById(statusId);
        if (statusElement) {
            if (gameState.soundAssignments[target]) {
                statusElement.className = 'rule-status assigned';
                statusElement.textContent = ' Assigned';
            } else {
                statusElement.className = 'rule-status not-assigned';
                statusElement.textContent = 'Not Assigned';
            }
        }

        // Update test button visibility
        var testBtnId = target + '-test-btn';
        var testBtn = document.getElementById(testBtnId);
        if (testBtn) {
            if (gameState.soundAssignments[target]) {
                testBtn.style.display = 'inline-block';
            } else {
                testBtn.style.display = 'none';
            }
        }
    }

    function updatePlayerSoundKey(team, playerNum) {
        // This function is called when a player name changes
        // We need to update the sound assignment key if the player has a sound
        var oldKey = team + '-player-' + playerNum;
        var input = document.getElementById(oldKey);
        if (input && input.value) {
            var newKey = team + '-' + input.value;
            if (gameState.soundAssignments[oldKey] && oldKey !== newKey) {
                gameState.soundAssignments[newKey] = gameState.soundAssignments[oldKey];
                delete gameState.soundAssignments[oldKey];
                autoSaveSounds();
            }
        }
    }
      // Function to update announcer buttons
    function updateAnnouncerButtons() {
        var announcerRules = [
            'game-start', 'first-goal', 'hat-trick', 'five-goals',
            'game-end', 'tie-game', 'three-lead', 'five-lead'
        ];

        for (var i = 0; i < announcerRules.length; i++) {
            var rule = announcerRules[i];
            var key = 'announcer-' + rule;
            updateSoundAssignmentButton(key);
            updateAnnouncerStatus(key);
        }
    }

// Function to update announcer status display
    function updateAnnouncerStatus(key) {
        var statusId = key + '-status';
        var statusElement = document.getElementById(statusId);
        if (statusElement) {
            if (gameState.soundAssignments[key]) {
                statusElement.className = 'rule-status assigned';
                statusElement.textContent = ' Assigned';
            } else {
                statusElement.className = 'rule-status not-assigned';
                statusElement.textContent = 'Not Assigned';
            }
        }
    }

    // Function to update custom sounds buttons
    function updateCustomSoundsButtons() {
        for (var i = 1; i <= 10; i++) {
            var key = 'custom-sound-' + i;
            updateCustomSoundStatus(key);
            
            // Update the sound name input field
            var nameInput = document.getElementById('custom-sound-' + i + '-name');
            if (nameInput && gameState.customSoundNames[i]) {
                nameInput.value = gameState.customSoundNames[i];
            }
        }
    }

    // Function to update custom sound status display
    function updateCustomSoundStatus(key) {
        var statusId = key + '-status';
        var statusElement = document.getElementById(statusId);
        if (statusElement) {
            if (gameState.soundAssignments[key]) {
                statusElement.className = 'rule-status assigned';
                statusElement.textContent = ' Assigned';
            } else {
                statusElement.className = 'rule-status not-assigned';
                statusElement.textContent = 'Not Assigned';
            }
        }
        
        // Also update the game mode display
        generateGameModeCustomSounds();
    }

// Function to play announcer sound
    function playAnnouncerSound(announcerKey, callback) {
        debugLog('Checking announcer sound for: ' + announcerKey);


        var soundId = gameState.soundAssignments[announcerKey];
        if (!soundId) {
            debugLog('No announcer sound assigned for: ' + announcerKey);
            if (callback) callback();
            return;
        }

        var sound = null;
        for (var i = 0; i < gameState.sounds.length; i++) {
            if (gameState.sounds[i].id === soundId) {
                sound = gameState.sounds[i];
                break;
            }
        }

        if (sound) {
            debugLog('Playing announcer sound: ' + announcerKey);

        // Stop any currently playing audio
            stopCurrentAudio();

            try {
                currentAudio = new Audio(sound.data);
            currentAudio.volume = 0.8;

            // Set up timeout for 15-second limit
            audioTimeout = setTimeout(function() {
                debugLog('Announcer sound exceeded 15 seconds - stopping');
                stopCurrentAudio();
                if (callback) callback();
            }, 15000);

            currentAudio.onended = function() {
                debugLog('Announcer sound ended');
                stopCurrentAudio();
                // Wait a short moment before playing the next sound
                setTimeout(function() {
                    if (callback) callback();
                }, 200);
            };

            currentAudio.onerror = function(e) {
                debugLog('Announcer audio error: ' + e.type);
                stopCurrentAudio();
                if (callback) callback();
            };

            currentAudio.play().then(function() {
                debugLog('Announcer sound playing: ' + announcerKey);
            }).catch(function(e) {
                debugLog('Announcer play error: ' + e.message);
                stopCurrentAudio();
                if (callback) callback();
            });
        } catch (e) {
            debugLog('Error creating announcer audio: ' + e.message);
            if (callback) callback();
        }
    } else {
        debugLog('Announcer sound not found for ID: ' + soundId);
        if (callback) callback();
    }
}

// Function to play multiple announcer sounds in sequence
    function playAnnouncerSoundsSequence(soundKeys, callback) {
        if (soundKeys.length === 0) {
            if (callback) callback();
            return;
    }

        var currentIndex = 0;

        function playNext() {
            if (currentIndex >= soundKeys.length) {
                if (callback) callback();
                return;
            }

            var soundKey = soundKeys[currentIndex];
            currentIndex++;

            playAnnouncerSound(soundKey, function() {
            // Small delay between announcer sounds
                setTimeout(playNext, 100);
            });
        }

        playNext();
}

    // Player Profile Management
    var playerProfiles = [];
    var currentMusicTarget = null;

    function createPlayerProfile() {
        var name = document.getElementById('new-player-name').value.trim();

        if (!name) {
            alert('Please enter a player name');
            return;
        }

        // Check if player name already exists
        if (playerProfiles.some(function(p) { return p.name.toLowerCase() === name.toLowerCase(); })) {
            alert('A player with this name already exists!');
            return;
        }

        var player = {
            id: 'player_' + Date.now(),
            name: name,
            music: {
                slot1: null,
                slot2: null,
                slot3: null
            },
            createdAt: new Date().toISOString()
        };

        playerProfiles.push(player);
        savePlayerProfiles();
        displayPlayerProfiles();

        // Clear form
        document.getElementById('new-player-name').value = '';

        // AndroidInterface.showToast(' Player profile created: ' + name);
    }

    function savePlayerProfiles() {
        try {
            localStorage.setItem('footballTracker_playerProfiles', JSON.stringify(playerProfiles));
        } catch (e) {
            console.error('Error saving player profiles:', e);
        }
    }

    function loadPlayerProfiles() {
        try {
            var saved = localStorage.getItem('footballTracker_playerProfiles');
            if (saved) {
                playerProfiles = JSON.parse(saved);
            } else {
                // First time startup - create 10 default players
                createDefaultPlayers();
            }
        } catch (e) {
            console.error('Error loading player profiles:', e);
            playerProfiles = [];
            // If error loading, also create default players
            createDefaultPlayers();
        }
    }

    function createDefaultPlayers() {
        debugLog('Creating 10 default players for first startup');
        playerProfiles = [];
        
        for (var i = 1; i <= 10; i++) {
            var player = {
                id: 'default_player_' + i,
                name: 'Player ' + i,
                music: {
                    slot1: null,
                    slot2: null,
                    slot3: null
                }
            };
            playerProfiles.push(player);
        }
        
        savePlayerProfiles();
        debugLog('Created 10 default players: Player 1 through Player 10');
    }

    var isBulkEditMode = false;

    function toggleBulkNameEdit() {
        isBulkEditMode = !isBulkEditMode;
        var button = document.querySelector('.edit-names-btn');
        
        if (isBulkEditMode) {
            button.textContent = ' Save Names';
            button.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            enableBulkNameEditing();
        } else {
            button.textContent = ' Edit Names';
            button.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
            saveBulkNameChanges();
            displayPlayerProfiles();
        }
    }

    function enableBulkNameEditing() {
        var grid = document.getElementById('players-grid');
        var html = '<div class="bulk-edit-header">' +
                      '<h3> Quick Edit Player Names</h3>' +
                      '<p>Edit the names below and click "Save Names" when done</p>' +
                   '</div>';
        
        for (var i = 0; i < playerProfiles.length; i++) {
            var player = playerProfiles[i];
            html += '<div class="bulk-edit-item">' +
                       '<label>Player ' + (i + 1) + ':</label>' +
                       '<input type="text" ' +
                              'id="bulk-edit-' + player.id + '" ' +
                              'value="' + player.name + '" ' +
                              'maxlength="30" ' +
                              'class="bulk-edit-input">' +
                    '</div>';
        }
        
        grid.innerHTML = html;
    }

    function saveBulkNameChanges() {
        for (var i = 0; i < playerProfiles.length; i++) {
            var player = playerProfiles[i];
            var input = document.getElementById('bulk-edit-' + player.id);
            if (input) {
                var newName = input.value.trim();
                if (newName && newName !== player.name) {
                    // Check for duplicates
                    var isDuplicate = playerProfiles.some(function(p, index) {
                        return index !== i && p.name.toLowerCase() === newName.toLowerCase();
                    });
                    
                    if (!isDuplicate) {
                        // Update player assignments in team dropdowns if name changed
                        updatePlayerNameInTeamAssignments(player.name, newName);
                        player.name = newName;
                    }
                }
            }
        }
        
        savePlayerProfiles();
        refreshPlayerDropdowns();
        
        if (window.AndroidInterface) {
            window.AndroidInterface.showToast('Remember to assign the player(s) with new name');
        }
    }

    function updatePlayerNameInTeamAssignments(oldName, newName) {
        // Update yellow team assignments
        for (var i = 1; i <= gameState.yellowPlayerCount; i++) {
            var select = document.getElementById('yellow-player-' + i);
            if (select && select.value === oldName) {
                select.value = newName;
            }
        }
        
        // Update blue team assignments
        for (var i = 1; i <= gameState.bluePlayerCount; i++) {
            var select = document.getElementById('blue-player-' + i);
            if (select && select.value === oldName) {
                select.value = newName;
            }
        }
    }

    function displayPlayerProfiles() {
        var grid = document.getElementById('players-grid');
        
        if (playerProfiles.length === 0) {
            grid.innerHTML = 
                '<div class="empty-state">' +
                    '<div class="empty-state-icon"></div>' +
                    '<h3>No Players Yet</h3>' +
                    '<p>Create your first player profile above</p>' +
                '</div>';
            return;
        }

        var html = '';
        playerProfiles.forEach(function(player) {
            html += createPlayerCardHTML(player);
        });
        
        grid.innerHTML = html;
        
        // Add event listeners for music buttons using event delegation
        grid.removeEventListener('click', handleMusicButtonClick); // Remove existing listener if any
        grid.addEventListener('click', handleMusicButtonClick);
        debugLog('Event listener added to players grid for music buttons');
        
        // Restore expanded music sections
        restoreExpandedMusicSections();
    }

    function handleMusicButtonClick(event) {
        debugLog('Click event detected on element: ' + event.target.tagName + ', classes: ' + event.target.className);
        
        var button = event.target;
        if (!button.classList.contains('music-btn')) {
            debugLog('Not a music button, ignoring click');
            return;
        }
        
        var playerId = button.getAttribute('data-player-id');
        var slotId = button.getAttribute('data-slot-id');
        var action = button.getAttribute('data-action');
        
        debugLog('Music button clicked: action=' + action + ', playerId=' + playerId + ', slotId=' + slotId);
        
        try {
            switch(action) {
                case 'play':
                    playPlayerMusic(playerId, slotId);
                    break;
                case 'remove':
                    removePlayerMusic(playerId, slotId);
                    break;
                case 'upload':
                    uploadPlayerMusic(playerId, slotId);
                    break;
                default:
                    debugLog('Unknown action: ' + action);
            }
        } catch (error) {
            debugLog('Error handling music button click: ' + error.message);
            // AndroidInterface.showToast(' Error: ' + error.message);
        }
    }
    // Make function globally accessible for debugging
    window.handleMusicButtonClick = handleMusicButtonClick;

    function createPlayerCardHTML(player) {

        var musicSlotsHTML = '';
        for (var i = 1; i <= 3; i++) {
            var slot = 'slot' + i;
            var hasMusic = player.music[slot] !== null;
            var musicInfo = hasMusic ? 
                '<span class="music-info has-music">' + player.music[slot].name + '</span>' :
                '<span class="music-info">No music assigned</span>';
            
            var controls = hasMusic ? 
                '<button class="music-btn play-music-btn" data-player-id="' + player.id + '" data-slot-id="' + slot + '" data-action="play"></button>' +
                ' <button class="music-btn remove-music-btn" data-player-id="' + player.id + '" data-slot-id="' + slot + '" data-action="remove"></button>' :
                '<button class="music-btn upload-music-btn" data-player-id="' + player.id + '" data-slot-id="' + slot + '" data-action="upload"></button>';

            musicSlotsHTML += 
                '<div class="music-slot ' + (hasMusic ? 'has-music' : '') + '">' +
                    '<span class="music-slot-number">' + i + '</span>' +
                    musicInfo +
                    '<div class="music-controls">' +
                        controls +
                    '</div>' +
                '</div>';
        }

        return '<div class="player-card">' +
                '<div class="player-card-header">' +
                    '<div class="player-info">' +
                        '<h3>' + player.name + '</h3>' +
                    '</div>' +
                    '<div>' +
                        '<button class="delete-player-btn" ' +
                                'onclick="debugLog(\'Delete button clicked for ' + player.id + '\'); confirmDeletePlayer(\'' + player.id + '\')" ' +
                                'ondblclick="debugLog(\'Double-click delete for ' + player.id + '\'); deletePlayer(\'' + player.id + '\')" ' +
                                'title="Click to delete with confirmation, double-click for immediate delete">' +
                            '' +
                        '</button>' +
                    '</div>' +
                '</div>' +
                
                '<div class="player-music">' +
                    '<div class="music-header" onclick="toggleMusicSection(\'' + player.id + '\')">' +
                        '<h4> Music Tracks (' + Object.values(player.music).filter(function(m) { return m !== null; }).length + '/3)</h4>' +
                        '<span class="expand-icon" id="expand-' + player.id + '"></span>' +
                    '</div>' +
                    '<div class="music-content" id="music-' + player.id + '">' +
                        '<div class="music-slots">' +
                            musicSlotsHTML +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
    }

    function uploadPlayerMusic(playerId, slotId) {
        try {
            debugLog('uploadPlayerMusic called with playerId: ' + playerId + ', slotId: ' + slotId);
            currentMusicTarget = { type: 'player', playerId: playerId, slotId: slotId };
            AndroidInterface.openSoundPicker();
        } catch (error) {
            debugLog('Error in uploadPlayerMusic: ' + error.message);
            // AndroidInterface.showToast(' Error opening file picker: ' + error.message);
        }
    }
    // Make function globally accessible
    window.uploadPlayerMusic = uploadPlayerMusic;

    function addMusicToPlayer(playerId, slotId, fileName, dataUrl, fileSize) {
        var player = playerProfiles.find(function(p) { return p.id === playerId; });
        if (!player) return;

        // Check file size (5MB = 5 * 1024 * 1024 bytes)
        var maxSize = 5 * 1024 * 1024;
        if (fileSize > maxSize) {
            var sizeInMB = (fileSize / (1024 * 1024)).toFixed(1);
            var message = 'File size too large! Maximum allowed: 5MB, your file: ' + sizeInMB + 'MB';
            alert(message);
            if (window.AndroidInterface) {
                window.AndroidInterface.showToast(message);
            }
            return;
        }

        player.music[slotId] = {
            name: fileName,
            dataUrl: dataUrl,
            size: fileSize,
            uploadedAt: new Date().toISOString()
        };

        savePlayerProfiles();
        displayPlayerProfiles();
        // AndroidInterface.showToast(' Music added to ' + player.name);
    }

    function playPlayerMusic(playerId, slotId) {
        try {
            // Stop any currently playing audio first
            stopCurrentAudio();
            
            debugLog('playPlayerMusic called with playerId: ' + playerId + ', slotId: ' + slotId);
            var player = playerProfiles.find(function(p) { return p.id === playerId; });
            if (!player) {
                debugLog('Player not found with ID: ' + playerId);
                // AndroidInterface.showToast(' Player not found');
                return;
            }
            
            if (!player.music[slotId]) {
                debugLog('No music found in slot ' + slotId + ' for player: ' + player.name);
                // AndroidInterface.showToast(' No music assigned');
                return;
            }

            var music = player.music[slotId];
            
            // Use unified audio system with 15-second timeout and overlap prevention
            var musicSound = {
                name: music.name,
                data: music.dataUrl
            };
            var description = 'Player: ' + player.name;
            
            playSound(musicSound, description);
            // AndroidInterface.showToast(' Playing: ' + music.name);
            debugLog('Playing music: ' + music.name + ' for player: ' + player.name);
        } catch (error) {
            debugLog('Error in playPlayerMusic: ' + error.message);
            console.error('Error playing music:', error);
            // AndroidInterface.showToast(' Error playing music: ' + error.message);
        }
    }
    // Make function globally accessible
    window.playPlayerMusic = playPlayerMusic;

    function removePlayerMusic(playerId, slotId) {
        try {
            debugLog('removePlayerMusic called with playerId: ' + playerId + ', slotId: ' + slotId);
            // AndroidInterface.showToast(' removePlayerMusic function called!');
            
            var player = playerProfiles.find(function(p) { return p.id === playerId; });
            if (!player) {
                debugLog('Player not found with ID: ' + playerId);
                // AndroidInterface.showToast(' Player not found');
                return;
            }
            
            if (!player.music[slotId] || player.music[slotId] === null) {
                debugLog('No music found in slot ' + slotId);
                // AndroidInterface.showToast(' No music found in this slot');
                return;
            }
            
            var musicName = player.music[slotId].name;
            debugLog('Found music to remove: ' + musicName);
            
            // Use a simple approach - remove directly with confirmation via Android toast
            // AndroidInterface.showToast(' Removing: ' + musicName);
            
            debugLog('Removing music from slot ' + slotId + ' for player: ' + player.name);
            player.music[slotId] = null;
            savePlayerProfiles();
            displayPlayerProfiles();
            // AndroidInterface.showToast(' Music removed from ' + player.name);
            debugLog('Music successfully removed');
            
        } catch (error) {
            debugLog('Error in removePlayerMusic: ' + error.message);
            // AndroidInterface.showToast(' Error removing music: ' + error.message);
            console.error('Error in removePlayerMusic:', error);
        }
    }
    // Make function globally accessible  
    window.removePlayerMusic = removePlayerMusic;
    
    function unassignSound(soundKey) {
        try {
            debugLog('unassignSound called for: ' + soundKey);
            
            if (gameState.soundAssignments[soundKey]) {
                var soundId = gameState.soundAssignments[soundKey];
                var sound = gameState.sounds.find(function(s) { return s.id === soundId; });
                var soundName = sound ? sound.name : 'Unknown';
                
                delete gameState.soundAssignments[soundKey];
                updateAllSoundAssignmentButtons();
                
                // Update specific UI components based on sound type
                if (soundKey.startsWith('announcer-')) {
                    updateAnnouncerStatus(soundKey);
                } else if (soundKey.startsWith('custom-sound-')) {
                    updateCustomSoundsButtons();
                }
                
                saveSoundsToAndroid();
                
                if (window.AndroidInterface) {
                    window.AndroidInterface.showToast(' Unassigned: ' + soundName);
                }
                debugLog('Sound unassigned successfully: ' + soundKey);
            } else {
                if (window.AndroidInterface) {
                    window.AndroidInterface.showToast(' No sound assigned');
                }
            }
        } catch (error) {
            debugLog('Error in unassignSound: ' + error.message);
            // AndroidInterface.showToast(' Error removing sound: ' + error.message);
        }
    }
    
    // Make function globally accessible
    window.unassignSound = unassignSound;
    


    function confirmDeletePlayer(playerId) {
        debugLog('confirmDeletePlayer called with ID: ' + playerId);
        var player = playerProfiles.find(function(p) { return p.id === playerId; });
        if (!player) {
            debugLog('Player not found with ID: ' + playerId);
            return;
        }

        debugLog('Single click on delete button for: ' + player.name);

        // Show helpful toast message instructing user to double-click
        if (window.AndroidInterface) {
            window.AndroidInterface.showToast(' Double-click the  button to delete "' + player.name + '"');
        }
    }

    function deletePlayer(playerId) {
        var player = playerProfiles.find(function(p) { return p.id === playerId; });
        if (!player) return;

        debugLog('Deleting player: ' + player.name);

        // Remove from playerProfiles array
        playerProfiles = playerProfiles.filter(function(p) { return p.id !== playerId; });
        
        // Clear any team assignments for this player
        clearPlayerFromTeamAssignments(player.name);
        
        // Save updated profiles
        savePlayerProfiles();
        
        // Refresh displays
        displayPlayerProfiles();
        refreshPlayerDropdowns();
        
        if (window.AndroidInterface) {
            // window.AndroidInterface.showToast(' Player deleted: ' + player.name);
        }
        
        debugLog('Player deleted successfully');
    }

    function clearPlayerFromTeamAssignments(playerName) {
        // Clear from yellow team
        for (var i = 1; i <= gameState.yellowPlayerCount; i++) {
            var select = document.getElementById('yellow-player-' + i);
            if (select && select.value === playerName) {
                select.value = '';
            }
        }
        
        // Clear from blue team
        for (var i = 1; i <= gameState.bluePlayerCount; i++) {
            var select = document.getElementById('blue-player-' + i);
            if (select && select.value === playerName) {
                select.value = '';
            }
        }
    }

    function toggleMusicSection(playerId) {
        var musicContent = document.getElementById('music-' + playerId);
        var expandIcon = document.getElementById('expand-' + playerId);
        
        if (!musicContent || !expandIcon) return;
        
        if (musicContent.classList.contains('expanded')) {
            // Collapse
            musicContent.classList.remove('expanded');
            expandIcon.classList.remove('expanded');
            expandIcon.textContent = '';
            expandedMusicSections[playerId] = false;
        } else {
            // Expand
            musicContent.classList.add('expanded');
            expandIcon.classList.add('expanded');
            expandIcon.textContent = '';
            expandedMusicSections[playerId] = true;
        }
    }

    function restoreExpandedMusicSections() {
        for (var playerId in expandedMusicSections) {
            if (expandedMusicSections[playerId] === true) {
                var musicContent = document.getElementById('music-' + playerId);
                var expandIcon = document.getElementById('expand-' + playerId);
                
                if (musicContent && expandIcon) {
                    musicContent.classList.add('expanded');
                    expandIcon.classList.add('expanded');
                    expandIcon.textContent = '';
                }
            }
        }
    }

    // Override the existing addSoundFromNative to handle player music and direct assignments
    var originalAddSoundFromNative = window.addSoundFromNative;
    window.addSoundFromNative = function(fileName, dataUrl, fileSize) {
        if (currentMusicTarget && currentMusicTarget.type === 'player') {
            addMusicToPlayer(currentMusicTarget.playerId, currentMusicTarget.slotId, fileName, dataUrl, fileSize);
            currentMusicTarget = null;
        } else if (currentSoundTarget) {
            // Handle direct sound assignment
            handleDirectSoundAssignment(fileName, dataUrl, fileSize);
        } else {
            // Call original function for other sound additions
            if (originalAddSoundFromNative) {
                originalAddSoundFromNative(fileName, dataUrl, fileSize);
            }
        }
    };
    
    function handleDirectSoundAssignment(fileName, dataUrl, fileSize) {
        debugLog('Direct assignment for: ' + currentSoundTarget);
        
        try {
            // Create the sound object
            var sound = {
                name: fileName,
                data: dataUrl,
                id: 'sound_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                size: fileSize,
                type: getMimeTypeFromDataUrl(dataUrl),
                assigned: true,
                uploadDate: new Date().toISOString()
            };

            // Add to sounds array
            gameState.sounds.push(sound);

            // Assign directly to the target
            gameState.soundAssignments[currentSoundTarget] = sound.id;

            // Update button appearance
            updateSoundAssignmentButton(currentSoundTarget);

            // Update custom sound buttons if needed
            if (currentSoundTarget.startsWith('custom-sound-')) {
                updateCustomSoundsButtons();
            }

            // Update announcer status if needed
            if (currentSoundTarget.startsWith('announcer-')) {
                updateAnnouncerStatus(currentSoundTarget);
            }

            // Auto save
            autoSaveSounds();
            
            // Show success message
            if (window.AndroidInterface) {
                // window.AndroidInterface.showToast(' "' + fileName + '" assigned successfully');
            }
            
            debugLog('Sound assigned successfully to: ' + currentSoundTarget);
            
        } catch (error) {
            debugLog('Error in direct sound assignment: ' + error.message);
            if (window.AndroidInterface) {
                // window.AndroidInterface.showToast(' Error assigning sound');
            }
        }
        
        // Clear the target
        currentSoundTarget = null;
    }

    // Save critical game state to prevent Bluetooth-induced resets
    function saveGameState() {
        try {
            var stateToSave = {
                isGameStarted: gameState.isGameStarted,
                hasGameBeenStarted: gameState.hasGameBeenStarted,
                yellowScore: gameState.yellowScore,
                blueScore: gameState.blueScore,
                yellowTeamName: gameState.yellowTeamName,
                blueTeamName: gameState.blueTeamName,
                actionLog: gameState.actionLog,
                yellowPlayers: gameState.yellowPlayers,
                bluePlayers: gameState.bluePlayers,
                expandedMusicSections: expandedMusicSections,
                timestamp: Date.now()
            };
            sessionStorage.setItem('footballTracker_gameState', JSON.stringify(stateToSave));
            debugLog('Game state saved to sessionStorage');
        } catch (error) {
            debugLog('Error saving game state: ' + error.message);
        }
    }

    // Restore game state after potential Bluetooth-induced reset
    function restoreGameState() {
        try {
            var savedState = sessionStorage.getItem('footballTracker_gameState');
            if (!savedState) return false;
            
            var state = JSON.parse(savedState);
            
            // Only restore if saved within last 30 seconds (likely a Bluetooth reset)
            if (Date.now() - state.timestamp > 30000) {
                sessionStorage.removeItem('footballTracker_gameState');
                return false;
            }
            
            // Restore critical game state
            gameState.isGameStarted = state.isGameStarted || false;
            gameState.hasGameBeenStarted = state.hasGameBeenStarted || false;
            gameState.yellowScore = state.yellowScore || 0;
            gameState.blueScore = state.blueScore || 0;
            gameState.yellowTeamName = state.yellowTeamName || '';
            gameState.blueTeamName = state.blueTeamName || '';
            gameState.actionLog = state.actionLog || [];
            gameState.yellowPlayers = state.yellowPlayers || [];
            gameState.bluePlayers = state.bluePlayers || [];
            expandedMusicSections = state.expandedMusicSections || {};
            
            // Restore UI elements
            if (state.yellowScore !== undefined) {
                document.getElementById('yellow-score').textContent = state.yellowScore;
            }
            if (state.blueScore !== undefined) {
                document.getElementById('blue-score').textContent = state.blueScore;
            }
            if (state.yellowTeamName) {
                document.getElementById('yellow-team-name').value = state.yellowTeamName;
                document.getElementById('yellow-team-name-header').textContent = state.yellowTeamName;
            }
            if (state.blueTeamName) {
                document.getElementById('blue-team-name').value = state.blueTeamName;
                document.getElementById('blue-team-name-header').textContent = state.blueTeamName;
            }
            
            // Restore game started state
            if (state.isGameStarted) {
                var startBtn = document.getElementById('start-stop-btn');
                if (startBtn) {
                    startBtn.textContent = ' STOP GAME';
                    startBtn.className = 'control-btn stop';
                }
                document.getElementById('main-title').style.display = 'none';
                document.getElementById('score-header').style.display = 'flex';
            }
            
            // Update Edit Names button visibility based on restored game state
            updateEditNamesButtonVisibility();
            
            debugLog('Game state restored from sessionStorage');
            return true;
        } catch (error) {
            debugLog('Error restoring game state: ' + error.message);
            return false;
        }
    }

    // Save state periodically and on important events
    function setupStatePersistence() {
        // Save state every 5 seconds during active game
        setInterval(function() {
            if (gameState.isGameStarted) {
                saveGameState();
            }
        }, 5000);
        
        // Save on page unload/visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                saveGameState();
            }
        });
        
        // Save on beforeunload
        window.addEventListener('beforeunload', function() {
            saveGameState();
        });
        
        // Save on audio interruptions (potential Bluetooth events)
        window.addEventListener('blur', function() {
            saveGameState();
        });
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
        if (isAppInitialized) {
            debugLog('App already initialized, skipping...');
            return;
        }
        
        debugLog('App initializing...');
        
        // Try to restore previous state first
        var wasRestored = restoreGameState();
        
        if (!wasRestored) {
            // Fresh initialization
            gameState.playerStats = {};
            initializePlayerSlots();
        }
        
        updateSoundsStats();
        loadPlayerProfiles();
        setupStatePersistence();
        
        // Restore player assignments after everything is initialized
        setTimeout(function() {
            debugLog('=== INIT DEBUG: Attempting to restore player assignments after initialization');
            if (gameState.playerAssignments && Object.keys(gameState.playerAssignments).length > 0) {
                debugLog('=== INIT DEBUG: Found player assignments to restore: ' + JSON.stringify(gameState.playerAssignments));
                restorePlayerAssignmentsFromGameState();
                // if (window.AndroidInterface) {
                //     window.AndroidInterface.showToast(' INIT: Restored ' + Object.keys(gameState.playerAssignments).length + ' player assignments');
                // }
            } else {
                debugLog('=== INIT DEBUG: No player assignments found in gameState');
                // if (window.AndroidInterface) {
                //     window.AndroidInterface.showToast(' INIT: No player assignments to restore');
                // }
            }
        }, 2000); // Wait 2 seconds to ensure sounds are loaded
        
        isAppInitialized = true;
        debugLog('Football Match Tracker ready' + (wasRestored ? ' (state restored)' : ' (fresh start)'));
    });
    

    debugLog('JavaScript loaded successfully');
</script>

<!-- Help Modal -->
<div id="helpModal" class="help-modal">
    <div class="help-modal-content">
        <div class="help-modal-header">
            <h2> How to Use Football Tracker</h2>
            <button class="help-modal-close" onclick="closeHelpModal()">&times;</button>
        </div>
        <div class="help-modal-body">
            <div class="help-content">
                <h3> Getting Started</h3>
                <p><strong>Football Tracker</strong> helps you keep score during football matches with custom sounds and music. When players score goals, their personal music plays automatically!</p>
                
                <h3> Quick Start (3 Steps)</h3>
                <p><strong>1.</strong> Go to <strong> Setup</strong>  Enter team names  Assign players<br>
                <strong>2.</strong> Go to <strong> Game</strong>  Press <strong> START GAME</strong><br>
                <strong>3.</strong> Tap player buttons when they score goals!</p>
                
                <h3> Setup Mode</h3>
                <p><strong>Team Names:</strong> Enter names for Yellow and Blue teams<br>
                <strong>Goal Sounds:</strong> Upload sounds that play when each team scores<br>
                <strong>Player Slots:</strong> Assign real player names to numbered positions<br>
                <strong>Own Goal Sounds:</strong> Special sounds for accidental own goals</p>
                
                <h3> Game Mode</h3>
                <p><strong>Start/Stop:</strong> Use  START GAME to begin tracking<br>
                <strong>Score Goals:</strong> Tap any player button to add a goal<br>
                <strong>Action Log:</strong> See complete match timeline below<br>
                <strong>Controls:</strong>  UNDO mistakes,  RESET match,  LOGS to save</p>
                
                <h3> Players Mode (Optional)</h3>
                <p>Create detailed player profiles with personal music. When these players score, their music plays instead of team sounds. Perfect for highlighting star players!</p>
                
                <h3> Announcer Mode (Optional)</h3>
                <p>Add excitement with special event sounds:<br>
                 <strong>Game Start/End:</strong> Official match beginning and conclusion<br>
                 <strong>Hat Tricks:</strong> When a player scores 3 goals<br>
                 <strong>Big Leads:</strong> When teams get 3+ or 5+ goal advantages</p>
                
                <h3> Effects Mode (Optional)</h3>
                <p>Upload up to 10 custom sounds for manual use during matches. Great for crowd cheers, referee whistles, or celebration sounds you can play anytime.</p>
                
                <h3> Tips & Tricks</h3>
                <p><strong>Audio Files:</strong> Supports MP3, WAV, OGG, AAC, FLAC (max 5MB each)<br>
                <strong>Sound Priority:</strong> Player music  Team sounds  Announcer effects<br>
                <strong>Quick Fixes:</strong> Use  UNDO for recent mistakes,  RESET for fresh start<br>
                <strong>Match Reports:</strong>  LOGS saves complete game timeline to Downloads</p>
                
                <h3> Perfect For</h3>
                <p> <strong>Youth Leagues:</strong> Make games more exciting for young players<br>
                 <strong>Family Games:</strong> Add fun to backyard or park matches<br>
                 <strong>Tournaments:</strong> Professional tracking with audio celebrations<br>
                 <strong>Training:</strong> Motivate players with personal goal music</p>
                
                <h3> About</h3>
                <p>Made entirely with <strong>Claude Code</strong>.</p>
                <p><strong>About author:</strong> <a href="https://www.linkedin.com/in/przemek-wojcik/" target="_blank" style="color: #6366f1; text-decoration: underline;">Przemek Wojcik on LinkedIn</a> - feel free to reach out!</p>
            </div>
        </div>
    </div>
</div>

</body>
</html>